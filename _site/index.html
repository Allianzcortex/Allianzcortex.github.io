<!DOCTYPE html>

<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Allianzcortex-Blog</title>
  <meta name="description" content="Promised Land">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Allianzcortex-Blog" href="http://localhost:4000/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="hzcortex">
  <meta name="twitter:title" content="Allianzcortex-Blog">
  <meta name="twitter:description" content="Promised Land">
  
    <meta name="twitter:creator" content="hzcortex">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Allianzcortex-Blog</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="/projects/">Projects</a>
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/board/">board</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">

  

  

  <ul class="post-list">
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/11/07/blockchain-bitcoin-talk/">操作数字货币的一些碎碎念(比特币、区块链、一致性、etc)</a>
          </h1>

          <p class="post-meta">Nov 7, 2017 • 
  
  

</p>
        </header>

        <div class="post-content">
          <ol>
  <li>讨论 BTC 的套利性是否真的有必要</li>
  <li>讨论比特币的存储，外部交易所的不稳定性</li>
  <li>讨论数字货币的不靠谱性，白皮书，代码</li>
  <li>讨论长期持有与其他理财方式(美股)的关系</li>
  <li>讨论如何在一个自己完全陌生的环境中不被割韭菜</li>
</ol>

<hr />

<p>讨论 EOS 的图片</p>

<p><img src="/images/EOS.jpg" alt="EOS.png" /></p>

<p>讨论比特币打赏：</p>

<p>欢迎大家：<strong>1KAYM9K6M6Cp7RJwwr4K1m59ETPxB6o8n4</strong></p>

        </div>
        
          <p class="post-continue">
            <a href="/2017/11/07/blockchain-bitcoin-talk/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/05/21/Scala-Test-Junit-Sbt-Problem/">ScalaTest 和 JUnit 集成，使用 Sbt 不执行测试的解决办法</a>
          </h1>

          <p class="post-meta">May 21, 2017 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>ScalaTest 与 JUnit 集成后，执行 <code class="highlighter-rouge">sbt test</code> 提示 <code class="highlighter-rouge">no tests are executed</code> 的解决办法</p>

<!-- more -->

<p>最近在试着写一个用 Scala 解决 LeetCode 的 <a href="https://github.com/Allianzcortex/Scala-LeetCode">集合</a>，Scala 里的单元测试一般推荐使用 ScalaTest，而大部分 Scala 使用者都有 Java 背景，所以 ScalaTest 也可以与 Junit 集成使用，参见 <a href="http://www.scalatest.org/getting_started_with_junit_4_in_scala">链接</a></p>

<h4 id="遇到了什么问题">遇到了什么问题</h4>

<p>首先定义如下的测试代码：</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.scalatest.</span><span class="o">{</span><span class="nc">BeforeAndAfterEach</span><span class="o">,</span> <span class="nc">FunSpec</span><span class="o">,</span> <span class="nc">FunSuite</span><span class="o">}</span>

<span class="k">class</span> <span class="nc">FileUtilTest</span> <span class="k">extends</span> <span class="nc">FunSpec</span> <span class="k">with</span> <span class="nc">BeforeAndAfterEach</span> <span class="o">{</span>
    <span class="n">it</span><span class="o">(</span><span class="s">"should be equal"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">assert</span><span class="o">(</span><span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>然后定义如下的 <strong>build.sbt</strong> 文件：</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.scalatest"</span> <span class="o">%</span> <span class="s">"scalatest_2.12"</span> <span class="o">%</span> <span class="s">"3.0.1"</span> <span class="o">%</span> <span class="s">"test"</span>
<span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"junit"</span> <span class="o">%</span> <span class="s">"junit"</span> <span class="o">%</span> <span class="s">"4.8.1"</span> <span class="o">%</span> <span class="s">"test"</span></code></pre></figure>

<p>上面是 Scala-Test 最标准的代码</p>

<p>同时用 IDEA 和 <code class="highlighter-rouge">sbt test</code> 来跑测试用例都没有问题</p>

<p>那么如果想要引入 JUnit 的话则如下：</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.junit.Assert._</span>
<span class="k">import</span> <span class="nn">org.scalatest.junit.</span><span class="o">{</span><span class="nc">AssertionsForJUnit</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.leetcode.util.</span><span class="o">{</span><span class="nc">FileUtil</span> <span class="k">=&gt;</span> <span class="n">xx</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.junit.Test</span>

<span class="k">class</span> <span class="nc">FileUtilTest</span> <span class="k">extends</span>  <span class="nc">AssertionsForJUnit</span> <span class="o">{</span>
    <span class="nd">@Test</span> <span class="k">def</span> <span class="n">test_max</span><span class="o">()={</span>
     <span class="n">assertTrue</span><span class="o">(</span><span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)==</span><span class="mi">2</span><span class="o">)</span>
   <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>在这种情况下用 IDEA 可以跑测试用例，但用 <code class="highlighter-rouge">sbt test</code> 的话会提示 <code class="highlighter-rouge">no tests are executed</code></p>

<p>参考：http://stackoverflow.com/questions/28174243/run-junit-tests-with-sbt 需要在原有 sbt 的基础上加上：</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">crossPaths</span> <span class="o">:=</span> <span class="kc">false</span>
<span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"com.novocode"</span> <span class="o">%</span> <span class="s">"junit-interface"</span> <span class="o">%</span> <span class="s">"0.11"</span> <span class="o">%</span> <span class="nc">Test</span>
<span class="n">testOptions</span> <span class="o">+=</span> <span class="nc">Tests</span><span class="o">.</span><span class="nc">Argument</span><span class="o">(</span><span class="nc">TestFrameworks</span><span class="o">.</span><span class="nc">JUnit</span><span class="o">,</span> <span class="s">"-q"</span><span class="o">,</span> <span class="s">"-v"</span><span class="o">)</span></code></pre></figure>

<p>出现这个问题的原因还是在于 Scala 和 Java 最后编译出来的是两套不同的字节码</p>

<hr />

<p>看了一下，Spark 里面的测试用例都是用的纯 ScalaTest 框架，而没有用 JUnit ：-D</p>

        </div>
        
          <p class="post-continue">
            <a href="/2017/05/21/Scala-Test-Junit-Sbt-Problem/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/05/21/Scala-99-Solution/">《Scala For Impatient》的习题和 Scala 99 的一些题解记录</a>
          </h1>

          <p class="post-meta">May 21, 2017 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>《Scala For Impatient》的习题和 Scala 99 的一些题解记录</p>

<!-- more -->

<p>Scala 的语法的复杂度堪比 C++ ……</p>

<p>《Scala CookBook》的作者评价 Java 这门语法的特性是 <code class="highlighter-rouge">Verbose yet obvious</code>，这是见过的最好对 Java 这门语言的描述了。正是因为 obvious 的特性，才能在工业级开发领域中遥遥领先，Web 开发/Android/数据领域都占据主要地位。也正是因为 verbose 的特性，让写 Java 写多的人很容易产生啰嗦的感觉，相比于 Python 的话对比感就更强烈了。</p>

<blockquote>
  <p>现在来看 Kotlin 的定位更像是 Better Java，字节码被翻译成 Java 类型，无缝调用 Java 的所有库，语法更简洁。</p>
</blockquote>

<p>Scala 则是对 Java 很好的一个改进，同样基于 JVM 平台。Scala 的官网上宣传 OO meets FP，它同时融合了面向对象和函数式编程的优点。就像很多人说的，没有必要把 Scala 的语法完全了解以后再去用它。要用 Spark，要看 Kafka，直接看就好了：-D</p>

<p>Scala 学习的时候主要分为两方面吧：</p>

<ul>
  <li>
    <p>Array/List/Seq 等一系列 Immutable 与 Mutable 对象，对应的 take/filter/map/flatMap/reduce/head/tail/init 等可以提高开发效率的方法</p>
  </li>
  <li>
    <p>class/case class/object/trait 等新的 OO 相关内容</p>
  </li>
</ul>

<p>关于水平掌握，达到 A3/L2 。</p>

<p>最近做了 Scala99 里面的一些题目，试着做一些摘抄，里面有些题目提出了和原来的一些不一样的方法</p>

<ul>
  <li>第 17 题：</li>
</ul>

<p>** 要求 ** 把一个 List 分为两个部分</p>

<ul>
  <li>
    <p>网站上提供了 ls.splitAt(n) 和直接返回 (ls.take(n),ls.drop(n)) 两种方法</p>
  </li>
  <li>
    <p>自己的实现：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">splitToTwoPart</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">ls</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">zipWithIndex</span><span class="o">.</span><span class="n">partition</span><span class="o">(</span><span class="n">elem</span> <span class="k">=&gt;</span> <span class="n">elem</span><span class="o">.</span><span class="n">_2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">)</span>
    <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">_1</span><span class="o">),</span> <span class="n">s</span><span class="o">.</span><span class="n">_2</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">_1</span><span class="o">))</span>
<span class="o">}</span></code></pre></figure>

<p>关于类的部分：算是实现了一个小的 demo 吧</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">collection.mutable.ArrayBuffer</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Record</span><span class="o">(</span><span class="k">var</span> <span class="n">event</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">var</span> <span class="n">money</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="k">this</span><span class="o">()</span> <span class="k">=</span> <span class="k">this</span><span class="o">(</span><span class="s">"sample"</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
<span class="o">}</span>


<span class="k">trait</span> <span class="nc">People</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
  <span class="k">var</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span>
  <span class="k">var</span> <span class="n">activity</span><span class="k">:</span> <span class="kt">ArrayBuffer</span><span class="o">[</span><span class="kt">Record</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">addRecord</span><span class="o">(</span><span class="n">newEvent</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">newMoney</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">removeRecord</span><span class="o">(</span><span class="n">deleteName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deleteMoney</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="c1">// 这也行，也就是说
</span>
  <span class="k">def</span> <span class="n">getAllCost</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">userName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">userAge</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">People</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">name</span> <span class="k">=</span> <span class="n">userName</span>
  <span class="k">var</span> <span class="n">age</span> <span class="k">=</span> <span class="n">userAge</span>
  <span class="k">var</span> <span class="n">activity</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ArrayBuffer</span><span class="o">[</span><span class="kt">Record</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">addRecord</span><span class="o">(</span><span class="n">newEvent</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">newMoney</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">activity</span> <span class="o">+=</span> <span class="nc">Record</span><span class="o">(</span><span class="n">newEvent</span><span class="o">,</span> <span class="n">newMoney</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="cm">/*def addRecord={

  }*/</span>

  <span class="k">def</span> <span class="n">removeRecord</span><span class="o">(</span><span class="n">deleteName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deleteMoney</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">targetRecord</span> <span class="k">=</span> <span class="nc">Record</span><span class="o">(</span><span class="n">deleteName</span><span class="o">,</span> <span class="n">deleteMoney</span><span class="o">)</span>
    <span class="cm">/*if this.activity.exists(_ == targetRecord) this.activity -= targetRecord*/</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">getAllCost</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">activity</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">x</span><span class="k">=&gt;</span><span class="n">println</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">money</span><span class="o">))</span>
    <span class="n">println</span><span class="o">(</span><span class="s">"money "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="n">activity</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">money</span><span class="o">).</span><span class="n">reduceLeft</span><span class="o">(</span><span class="k">_</span><span class="o">+</span><span class="k">_</span><span class="o">))</span>
    <span class="k">this</span><span class="o">.</span><span class="n">activity</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">money</span><span class="o">).</span><span class="n">reduceLeft</span><span class="o">(</span><span class="k">_</span><span class="o">+</span><span class="k">_</span><span class="o">)</span>
    <span class="c1">//所以自己一开始的 reduce((x,y)=&gt;x.money+y.money)) 思路是错的，你看，前两个得到的结果是 Record,但之后得到的是 Int
</span>    <span class="c1">// 再之后就会在 Record 和 Int 之间产生冲突
</span>  <span class="o">}</span>

  <span class="k">def</span> <span class="n">getActivity</span><span class="o">()</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Record</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// 返回的 Array 必须是有类型的，而不能是 Array
</span>    <span class="c1">// List 也是一样的道理。并且 List 的可读性更好
</span>    <span class="k">this</span><span class="o">.</span><span class="n">activity</span><span class="o">.</span><span class="n">toList</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">toString</span> <span class="k">=</span> <span class="n">s</span><span class="s">"$name $age"</span>

<span class="o">}</span>

<span class="k">object</span> <span class="nc">testApplication</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">u</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"Tom"</span><span class="o">,</span> <span class="mi">18</span><span class="o">)</span>
  <span class="n">u</span><span class="o">.</span><span class="n">addRecord</span><span class="o">(</span><span class="s">"Buy Clothes"</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
  <span class="n">println</span><span class="o">(</span><span class="n">u</span><span class="o">)</span>
  <span class="n">println</span><span class="o">(</span><span class="s">"用户的活动为 "</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">getActivity</span><span class="o">())</span>
  <span class="n">println</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">activity</span><span class="o">.</span><span class="n">toList</span><span class="o">)</span>
  <span class="n">println</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">getActivity</span><span class="o">())</span>
  <span class="n">println</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">getAllCost</span><span class="o">())</span>
<span class="o">}</span></code></pre></figure>

<hr />

<p>在附录部分再总结一下 Scala 方法的集合：</p>


        </div>
        
          <p class="post-continue">
            <a href="/2017/05/21/Scala-99-Solution/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/05/07/Create-Rest-API-With-Sprint-Boot/">用 Spring Boot 来构建一个 Rest 服务</a>
          </h1>

          <p class="post-meta">May 7, 2017 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>使用 spring 来从 <code class="highlighter-rouge">redis/MySQL/HBase/ES</code> 中读取数据，并对外提供 Restful 接口</p>

<!-- more -->

<p>ETL 工作的最终落地</p>


        </div>
        
          <p class="post-continue">
            <a href="/2017/05/07/Create-Rest-API-With-Sprint-Boot/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/05/01/read-HBase-source-code/">阅读 HBase 源代码</a>
          </h1>

          <p class="post-meta">May 1, 2017 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>开始阅读 HBase 源代码</p>

<!-- more -->

<p><img src="/images/HBase-source-code.png" alt="HBase-source-code.png" /></p>

<p>HBase 的特点：</p>

<ul>
  <li>
    <p>实现比 redis 持久化存储效果更好的 key-value 键值对</p>
  </li>
  <li>
    <p>实现需要有历史版本的增量存储</p>
  </li>
</ul>

<p>阅读代码主要包括以下几个方面：</p>

<ul>
  <li>
    <p>在实际编写程序时，通过有关 API 及 IDEA 跳转到源代码的功能，查看具体功能实现</p>
  </li>
  <li>
    <p>在 debug 应用时，了解整个 Hbase 执行应用的业务逻辑</p>
  </li>
  <li>
    <p>通读整个源代码，了解各块的实现</p>
  </li>
</ul>

<hr />

<p>在这里首先看第一部分，执行一个小的应用，看它是怎么执行下来的</p>

<p>读取配置文件 reloadConfig()，重新记载配置文件</p>

<p>checkDefaultVersion():检查配置文件的版本和应用所读取的版本是否相等。可以用一个配置文件来跳过这项配置</p>

<p>set(String name,String value) // 这里用 Guava 的 Preconditions.checkArgument() 来判断配置是否为 null
同时还有 updateSource()</p>

<p>关于 HConnection connection = HConnectionManager.create</p>

<div class="highlighter-rouge"><pre class="highlight"><code>IDEA 为分析项目的整体结构提供了非常强大的功能
几个常用的如下：

光标选中某个类：在 Navigate-&gt;call  call Hierarchy 查看该
callers 查看该方法被哪个方法调用，callee 查看该方法调用了哪些方法

选中某个方法，类，查看该类被哪些类引用，生成用例图， ctrl+alt+H

</code></pre>
</div>

<p>方便开发</p>

        </div>
        
          <p class="post-continue">
            <a href="/2017/05/01/read-HBase-source-code/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/04/27/JVM-tuning-Tips/">Jvm Tuning Tips</a>
          </h1>

          <p class="post-meta">Apr 27, 2017</p>
        </header>

        <div class="post-content">
          

        </div>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/04/27/JVM-performance-snippets/">Jvm Performance Snippets</a>
          </h1>

          <p class="post-meta">Apr 27, 2017</p>
        </header>

        <div class="post-content">
          

        </div>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/04/25/Mapreduce-Design-Pattern/">关于 MapReduce 设计模式</a>
          </h1>

          <p class="post-meta">Apr 25, 2017 • 
  
  

</p>
        </header>

        <div class="post-content">
          <h4 id="实现统计-uv">实现统计 UV</h4>

<p>类似于 SQL 中的 count(distinct *)</p>

<p>我所实现的第一种：</p>

<p>map:emit(null,key)</p>

<p>reduce:TreeSet 存储元素，cleanup():写入，得到 length</p>

<p>优势：跑一次 MapReduce Job 即可得到最终结果
劣势：只能有一个 reduce
待优化：在 combiner 阶段可以写一个处理类来减少 shuffle 的数量</p>

<p>书中的第二种：
map:emit(key,null)
reduce:迭代任意一个 Iterrator 时只需要 O(1) 操作</p>

<p>优势：利用 MR 框架自带的去重特性，在处理大量数据时有优势
劣势：需要跑两次 MR 来得到最终的统计结果</p>

<hr />

<h4 id="实现数据库-leftinnerright-join">实现数据库 left/inner/right join</h4>

<p>这里可以参考 Quora 的这个问题：https://www.quora.com/How-does-Hive-implement-joins-in-Map-Reduce</p>

<p>存在 Map-side 和 Reduce-side 两种情况来区分讨论</p>

<p>MultiInput 用 ArrayList 存储</p>

<p>劣势：在一个表中有上千万数据时可能会 OOM</p>

<hr />

<p>####</p>

        </div>
        
          <p class="post-continue">
            <a href="/2017/04/25/Mapreduce-Design-Pattern/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/04/08/Some-Interesting-Logical-Problem/">一些有趣的逻辑问题</a>
          </h1>

          <p class="post-meta">Apr 8, 2017 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>逻辑问题……
<!-- more --></p>

<ol>
  <li>第一个问题是在已有的一个随机数基础上再生成一个随机数，确保生成 0 和 1 的概率是相等的</li>
</ol>

<p>思路也很直接啦。</p>

<p>来写一个程序验证一下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span> <span class="c"># compatible with Py2
</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>


<span class="k">def</span> <span class="nf">rand</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">new_rand</span><span class="p">():</span>
    <span class="n">_prev</span><span class="p">,</span> <span class="n">_next</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">_prev</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">_next</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span><span class="p">(</span><span class="n">_prev</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">_next</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">_prev</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span>
        <span class="n">_next</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
    <span class="n">sum_zero</span><span class="p">,</span> <span class="n">sum_one</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">gen_num</span> <span class="o">=</span> <span class="n">new_rand</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">gen_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">sum_zero</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sum_one</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"rate is {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sum_one</span> <span class="o">/</span> <span class="n">sum_zero</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">check</span><span class="p">()</span>  <span class="c"># 3 sample results: 1.00320512821,1.01938610662,0.982160555005</span></code></pre></figure>

<ol>
  <li>第二个问题其实就是数据可用性的问题</li>
</ol>

<p>最后抽象出黑盒问题：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># -*- coding:utf-8 -*-
from __future__ import division

from random import randint


def gen_unique_list():
    i = 0
    res = set()
    while i &lt; 100000:
        temp = [1] * 5
        while True:
            r1, r2, r3 = randint(0, 4), randint(0, 4), randint(0, 4)
            if(r1 != r2 and r1 != r3 and r2 != r3):
                temp[r1] = 0
                temp[r2] = 0
                temp[r3] = 0
                break
        if tuple(temp) not in res:
            res.add(tuple(temp))
        i += 1
    return res


def gen_probability():
    res = gen_unique_list()
    prob = 0
    for elem in res:
        # find last occurence
        print elem
        ind = 4 - list(reversed(elem)).index(0)
        red_cnt, green_cnt = 3, 2
        x = 1
        # for in in range(0,ind)  这句话就是另一种思路了，显然不应该，最后得出的和都大于 1 了
        for i in range(0, 5):
            if(elem[i] == 0):
                # means red
                x *= (red_cnt / (red_cnt + green_cnt))
                red_cnt -= 1
            else:
                # means green
                x *= (green_cnt / (red_cnt + green_cnt))
                green_cnt -= 1
        prob += x
        print x
    print prob


if __name__ == '__main__':
    gen_probability()


</code></pre>
</div>

<p>但实际上直接 C(5,3) 就足够了……自己想的太复杂</p>

<p>这还只是一份数据，那么如果有两份数据呢。是在第一份数据可用的前提下 * 第二份数据可用，那么这两个问题就应该是独立的。
因为前提是机器损坏已经发生了</p>

        </div>
        
          <p class="post-continue">
            <a href="/2017/04/08/Some-Interesting-Logical-Problem/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/03/06/Write-A-Multithreading-Application/">一个 Java 多线程程序实例——JStorm 处理逻辑</a>
          </h1>

          <p class="post-meta">Mar 6, 2017 • 
  
  

  
  

</p>
        </header>

        <div class="post-content">
          <p>在实时流 JStorm 中处理一个多线程的程序
<!-- more --></p>

<hr />

<p>Update：最近又遇到了这个问题。具体的原因就是最近在处理的程序用了一个自建的 redis pool。
它在 getInstance() 方法这里用了 synchronized 关键字来加锁。</p>

<p>但我们看一下 redis 是怎么实现这一点的。它继承了 Apache.commons.pool ，里面调用了
<code class="highlighter-rouge">super.getResource()</code> 方法，而它又调用了 pool 里面的 <code class="highlighter-rouge">borrowObject</code> 方法。
在 <code class="highlighter-rouge">borrowObject</code> 方法里，它已经实现了对多线程的考虑：</p>

<p>long starttime = System.currentTimeMillis();
1060        Latch<T> latch = new Latch<T>();
1061        byte whenExhaustedAction;
1062        long maxWait;
1063        synchronized (this) {
1064            // Get local copy of current config. Can't sync when used later as
1065            // it can result in a deadlock. Has the added advantage that config
1066            // is consistent for entire method execution
1067            whenExhaustedAction = _whenExhaustedAction;
1068            maxWait = _maxWait;
1069
// activate &amp; validate the object
1203            try {
1204                _factory.activateObject(latch.getPair().value);
1205                if(_testOnBorrow &amp;&amp;
1206                        !_factory.validateObject(latch.getPair().value)) {
1207                    throw new Exception("ValidateObject failed");
1208                }
1209                synchronized(this) {
1210                    _numInternalProcessing--;
1211                    _numActive++;
1212                }
1213                return latch.getPair().value;
1214            }
1215            catch (Throwable e) {
                ......
}</T></T></p>

        </div>
        
          <p class="post-continue">
            <a href="/2017/03/06/Write-A-Multithreading-Application/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/03/01/HBase-Definitions/">Hbase Definitions</a>
          </h1>

          <p class="post-meta">Mar 1, 2017</p>
        </header>

        <div class="post-content">
          

        </div>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2016/12/16/Hadoop-Mapreduce-Tutorial/">译—利用 MapReduce 来探寻好友关系</a>
          </h1>

          <p class="post-meta">Dec 16, 2016 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>一篇译文，介绍 MapReduce 在实际中的应用
<!-- more --></p>

<p>原文链接在 <a href="http://stevekrenzel.com/finding-friends-with-mapreduce">finding-friends-with-mapreduce</a>，稍有改动。</p>

<p>MapReduce 程序通常包括两部分函数：一个 Map 函数与一个 Reduce 函数。Map 函数会接受一个输入值(value) 并返回一个键值对(key:value pairs)。比如说，如果我们定义了一个接受字符串作为输入并输出该字符长度作为输出的 Map 函数，那么 Map(steve) 将会返回 <code class="highlighter-rouge">5:steve</code> 并且 Map(savannah) 会返回 <code class="highlighter-rouge">8:savannah</code>。你也会注意到 Map 函数是无状态(stateless) 的并且只会要求输入值来确定输出值。这就使得我们可以并行运行多个 Map 函数从而取得巨大的性能优势。在进入到 Reduce 函数之前，MapReduce 框架会把所有的输出值(values)按照键(key)来进行分组。所以说如果 Map 函数输出的结果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>3 : the
3 : and
3 : you
4 : then
4 : what
4 : when
5 : steve
5 : where
8 : savannah
8 : research
</code></pre>
</div>

<p>那么他们会被排类为如下的形式：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>3 : [the, and, you]
4 : [then, what, when]
5 : [steve, where]
8 : [savannah, research]

</code></pre>
</div>

<p>接下来每一行都会作为一个参数被传递进 reduce 函数中，reduce 函数接受一个 key 和一系列的 values。在这个例子中，我们想要探寻包含特定长度的单词的数量，所以 reduce 函数将会仅仅计算列表中的单词数量并且将它与 key 一起进行输出，产生如下的形式：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>3 : 3
4 : 3
5 : 2
8 : 2

</code></pre>
</div>

<p>reduce 函数仍然可以并行工作。我们可以看到这里长度为 5 的单词只有 2 个，诸如此类…</p>

<p>上面所说的 wordcount 例子是 MapReduce 版的 Hello World，下面我们将要介绍一个真实世界中的使用（FaceBook 或许不是真的这样去做的，这里只是举一个例子）：</p>

<p>FackBook 上存在着朋友列表（注意，在 FaceBook 中好友关系是双向的，如果我是你的朋友，那么你也是我的朋友）。同时 FaceBook 拥有大量的磁盘存储空间与海量访问请求。FaceBook 决定提前计算这样他们就可以减少请求的访问时间。一个常见的处理操作是“你和 Joe 有 230 个共同好友”。当你访问某人的资料页时，你可以看到你们所共同拥有的好友。这个列表不会频繁改动所以如果每次访问页面都重新计算的话就太浪费了（当然你可以使用缓存来做，但这样的话我就不会讲述用 MapReduce 来解决这个问题了）。我们将要使用 MapReduce 在一天内 来计算并储存这些结果。</p>

<p>假设朋友是以 <code class="highlighter-rouge">Person-&gt;[List of Friends]</code> 的形式存储的，我们的朋友列表为：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>A -&gt; B C D
B -&gt; A C D E
C -&gt; A B D E
D -&gt; A B C E
E -&gt; B C D

</code></pre>
</div>

<p>mappper 会将每一行作为参数来处理。同样 mapper 函数会输出一个键值对，键（key）会是一对朋友（a friend along with the person），值（value）会是朋友列表（list of firends）。并且键（key）会是一对已经经过排序的值，这样在 reducer 函数里会形成相同的 pairs。这用语言很难解释，所以让我们直接去做吧。经过 mapper 函数，你会得到如下的输出结果：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>For map(A -&gt; B C D) :

(A B) -&gt; B C D
(A C) -&gt; B C D
(A D) -&gt; B C D
For map(B -&gt; A C D E) : (Note that A comes before B in the key)

(A B) -&gt; A C D E
(B C) -&gt; A C D E
(B D) -&gt; A C D E
(B E) -&gt; A C D E
For map(C -&gt; A B D E) :

(A C) -&gt; A B D E
(B C) -&gt; A B D E
(C D) -&gt; A B D E
(C E) -&gt; A B D E
For map(D -&gt; A B C E) :

(A D) -&gt; A B C E
(B D) -&gt; A B C E
(C D) -&gt; A B C E
(D E) -&gt; A B C E
And finally for map(E -&gt; B C D):

(B E) -&gt; B C D
(C E) -&gt; B C D
(D E) -&gt; B C D
</code></pre>
</div>

<p>在把它们送往 reduce 函数前，我们根据 key 来把它们进行分类并且得到</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(A B) -&gt; (A C D E) (B C D)
(A C) -&gt; (A B D E) (B C D)
(A D) -&gt; (A B C E) (B C D)
(B C) -&gt; (A B D E) (A C D E)
(B D) -&gt; (A B C E) (A C D E)
(B E) -&gt; (A C D E) (B C D)
(C D) -&gt; (A B C E) (A B D E)
(C E) -&gt; (A B D E) (B C D)
(D E) -&gt; (A B C E) (B C D)
</code></pre>
</div>

<p>reduce 函数将会取每一个键对应的值的交集并输出。比如 reduce((A B) -&gt; (A C D E)(B C D)) 将会输出 (A B):(C  D) ，这意味着 A 和 B 有共同好友 C 和 D 。</p>

<p>最终的结果为：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(A B) -&gt; (C D)
(A C) -&gt; (B D)
(A D) -&gt; (B C)
(B C) -&gt; (A D E)
(B D) -&gt; (A C E)
(B E) -&gt; (C D)
(C D) -&gt; (A B E)
(C E) -&gt; (B D)
(D E) -&gt; (B C)

</code></pre>
</div>

<p>这样当 D 访问 B 的资料页时，我们可以快速查询 (B D) 并且看到他们的共同好友 (A C E)。</p>

        </div>
        
          <p class="post-continue">
            <a href="/2016/12/16/Hadoop-Mapreduce-Tutorial/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2016/12/15/urldecode-20-space/">A Problem about urlencode,space and 20%</a>
          </h1>

          <p class="post-meta">Dec 15, 2016 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>So when url is encoded/decoded, when to use + and when to use %20?
<!-- more --></p>

<p><a href="/../translation/2016-12-15-urldecode-20-space.html">这篇文章对应的中文版</a></p>

<h4 id="background">Background</h4>

<p>In short, this is the case. The mobile application logs of company is collected by Nginx.
Encode with <code class="highlighter-rouge">urlencode</code>. tricky method is to us <code class="highlighter-rouge">tail -F | grep ***</code> to find the target line and then parse it with pratical tools, but recently we have to deal with the logs, so there must be one way to do it automatically. gland to find <a href="http://stackoverflow.com/questions/28431359/how-to-decode-a-url-encoded-string-in-python">method</a> on <strong>StackOverFlow</strong>, so directly import <code class="highlighter-rouge">urllib. Unquote</code> to the code .</p>

<h4 id="development">Development</h4>

<p>But soon something wrong happened, if the time format given is <code class="highlighter-rouge">2016-12-15 12:02:22</code>, the result after processing is formatted as
<code class="highlighter-rouge">2016-12-15+12:02:22</code>. It’s impossible to sort by the time of the recent occurrence, even the most basic search functions will be a big problem,let alone further processing.</p>

<h4 id="what-happened">What Happened</h4>

<p>There is still <a href="http://stackoverflow.com/questions/1634271/url-encoding-the-space-character-or-20">discussion</a> about this problem on SO，and quote the wikipedia：</p>

<blockquote>
  <p>When data that has been entered into HTML forms is submitted, the form field names and values are encoded and sent to the server in an HTTP request message using method GET or POST, or, historically, via email.[2] The encoding used by default is based on an early version of the general URI percent-encoding rules,[3] with a number of modifications such as newline normalization and replacing spaces with + instead of %20. The media type of data encoded this way is application/x-www-form-urlencoded, and it is currently defined (still in a very outdated manner) in the HTML and XForms specifications. In addition, the CGI specification contains rules for how web servers decode data of this type and make it available to applications.
When HTML form data is sent in an HTTP GET request, it is included in the query component of the request URI using the same syntax described above. When sent in an HTTP POST request or via email, the data is placed in the body of the message, and application/x-www-form-urlencoded is included in the message’s Content-Type header.</p>
</blockquote>

<p>发生的原因是 URL 编码是分裂的，老式的 application/x-www-form-urlencoded 空格被表示为 + ，而 + 被表示为 “%2B”。比如在 Google 里搜索”Python urlencode+20”，query url 为 <code class="highlighter-rouge">https://www.google.com/search?q=Python+urlencode%2B20</code></p>

<p>在现代的 url 的 HTTP URLs 中，空格被编码为”%20”，而 + 不被编码。</p>

<p>在给的日志中空格仍然是按照 “+” 来传递的，而 unquote() 是按照现代方式解码的，所以造成结果的差异。解决办法就是在解码前用 <code class="highlighter-rouge">raw_data.replace('+','%20')</code>来把空格给转回去(因为日志包含内容里没有 + 号，所以这么做不会影响日志的表达性)。</p>

<p>关于 urlencode 编码中各种对应关系，可以参考 <a href="http://www.degraeve.com/reference/urlencoding.php">这个列表</a></p>

        </div>
        
          <p class="post-continue">
            <a href="/2016/12/15/urldecode-20-space/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2016/09/08/Data-Visualize-With-Flask-And-Highcharts/">记录一次用 Flask 和 Highcharts 实现的数据可视化</a>
          </h1>

          <p class="post-meta">Sep 8, 2016 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>数据可视化。后端：Flask，前端：Highcharts，可以做的更好的啊……
<!-- more --></p>

<h4 id="what-happened">What Happened</h4>

<p>我司采用的是阿里巴巴开源的 <code class="highlighter-rouge">zeus</code> ，结合脚本来进行业务系统的调度。有过一段时间突然晚上调度业务连续崩的现象(预警短信连发)，只能白天重新洗数据。经过研究发现是在某段时间内任务运行过多造成并行压力过大造成的，需要合理分布 <code class="highlighter-rouge">ods/mds/ads</code> 表的时间。但 zeus 系统本身没有提供查询调度任务的时间分布功能，所以需要来实现一个任务分布的可视化。</p>

<h5 id="flask-后端框架">Flask 后端框架</h5>

<p>虽然用 <code class="highlighter-rouge">Django</code> 用的多，但 <code class="highlighter-rouge">Django</code> 作为一个 <code class="highlighter-rouge">Full-Stack Framework</code> 实在太重了，里面的注册、登陆功能都不会用到。所以换为 Flask ，实时从 MySQL 中查询，将查询的结果用自带的 <code class="highlighter-rouge">jsonify</code> 转化后返回给前端页面。</p>

<p>Zeus 的调度时间格式类似 crontab，所以为了能在后端直接生成需要的数据，就决定将时间统一折合为 <code class="highlighter-rouge">int</code> 值。比如：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>原始时间    对应展示
0 10 1（表示 1:10） 110
0 16 0 （表示 12:16）   16
0 30 23（表示晚上 11:30） 2330
</code></pre>
</div>

<p>在看的时候如果不满足四位，需要补全前导零来去看。</p>

<p>时间的核心计算如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="s">'0'</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">'0'</span><span class="p">:</span>
        <span class="n">key</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></figure>

<p>配置 post 数据</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/timeserialize'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_json</span><span class="p">():</span>
    <span class="c"># calculate some data
</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></figure>

<h5 id="highcharts-前端框架">Highcharts 前端框架</h5>

<p>在前端框架里比较出名的就是百度的 <code class="highlighter-rouge">Echarts</code> 和 Google 的 <code class="highlighter-rouge">HighCharts</code>(还有 <code class="highlighter-rouge">D3.js</code>，但怎么都用不到啊…)。就选择后者啦。</p>

<p>首先加入资源文件。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"&gt;&lt;/script&gt;
    &lt;link rel="stylesheet" type="text/css" href=""&gt;
    &lt;!-- jquery.min.js 顺序应该在 highcharts.js 之前 --&gt;
    &lt;script src=""&gt;&lt;/script&gt;
    &lt;script src=""&gt;&lt;/script&gt;

</code></pre>
</div>

<p>之后用 <code class="highlighter-rouge">jquery</code> 来配置 POST 格式的 JSON 数据。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;script&gt;
$(function () {
    $.getJSON('/timeserialize', function (data) {
    /*$.getJSON('/configure', function (data) {*/
        $('#container').highcharts({
            // legend,option 等数据
        });
    });
});
&lt;/script&gt;


</code></pre>
</div>

<h4 id="第一个版本">第一个版本</h4>

<p>做完第一个版本后的显示效果如下所示：</p>

<p><img src="/images/figure-1.png" alt="figure-1" /></p>

<p><img src="/images/figure-2.png" alt="figure-2" /></p>

<p>点的数量指代了在当前时间点运行的 job 数量。拖拽放大能看到更细的时间维度内的变化。</p>

<h4 id="第二个版本">第二个版本</h4>

<p>第二个版本要感谢 <a href="https://www.zhihu.com/people/wu-bo-72-98/activities">@吴波</a> 同学的贡献。自己当时实现的还是有些太粗糙了。实际上将得到的时间格式和具体的秒数进行字符串组合后是
可以得到任务的具体执行时间，转为 unixtime 后传给前端，再转为具体时间，可视化的效果会更好。</p>

<p>其中的关键就是在 <code class="highlighter-rouge">$function()</code> 里再添加一个对 JSON 格式处理的函数。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var jsonData = data;
var jsonDataSuccess = new Array();
var jsonDataFailed = new Array();
# ...
tempArray.push(parseInt(jsonData[i].startTime) + 28800000,parseInt(jsonData[i].spendTime));
# ...
</code></pre>
</div>

<p>在 <code class="highlighter-rouge">series</code> 里分别用两种类型来标注：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    series:[{
            name:'success',
            color:'rgb(119,152,191)',
            data:jsonDataSuccess,
            },{
            name:'failed',
            color:'rgb(255,0,0)',
            data:jsonDataFailed
            }
                    ]
</code></pre>
</div>

<p>在 <code class="highlighter-rouge">tooltip</code> 里用 formatter() 选项来返回更友好的表达式：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>tooltip:{
    formatter: function() {
        //...
        return 'jobid :' + jobId + '&lt;br&gt;' + "jobName:" + jobName + '&lt;br&gt;'  + 'starttime :' + startTime
    }
}
</code></pre>
</div>

<p>最后得到的可视化结果如下所示：</p>

<p><img src="/images/figure-3.png" alt="figure-3" /></p>

<p>感觉好漂亮(捂脸)</p>

<p>在一开始做到时候有些太追求开发速度了…可以慢一点来让可视化效果更好:-D。同时学一下 js 的语法，有很多功能是不能用 jquery 代替的～～</p>


        </div>
        
          <p class="post-continue">
            <a href="/2016/09/08/Data-Visualize-With-Flask-And-Highcharts/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2016/07/03/hive-and-sqoop/">最近做的一些事——Hive+Sqoop 与 调度系统选型</a>
          </h1>

          <p class="post-meta">Jul 3, 2016 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>用 <code class="highlighter-rouge">Hive</code> 与 <code class="highlighter-rouge">Sqoop</code> 实现 ETL，以及对 <strong>Ozzie/Azkaban/Airflow/Zeus/Kettle</strong> 的调研</p>

<!-- more -->

<h4 id="what-happened">What Happened</h4>

<p>最近所做的一些事。还是挺有趣的。</p>

<p>ETL 过程，代指 <strong>Extract-&gt;Transform-&gt;Load</strong>，进行数据抽取处理的过程</p>

<p>HDFS 文件路径下面的数据来源一般有以下几种：</p>

<ul>
  <li>
    <p>从已有的 RDBMS 数据库中导入，方便和业务进行分析</p>
  </li>
  <li>
    <p>从已有的 HDFS 数据中进行连接和抽样，生成新的复合需求的数据</p>
  </li>
  <li>
    <p>一些其他的路径，包括从 Flume 中用 HDFS Sink 写入，或者用 <code class="highlighter-rouge">hadoop fs -put</code> 来把本地的文件导入到 HDFS 中。</p>
  </li>
</ul>

<p>第一种工具包括 Apache 出品的 Sqoop 和阿里出品的 DataX(京东是根据 DataX 的原理自己搞了一套)。二者的对比可以查看这个 <a href="https://chu888chu888.gitbooks.io/hadoopstudy/content/Content/11/chapter11.html">链接</a>。</p>

<p>第二种工具则在大多数情况下都是在用 Hive 来解决需求。Hive 是 FaceBook 出品的可以把 HQL(类 SQL 语法)转化为 MapReduce 执行的工具，方便数据分析师进行操作。</p>

<p>同时还调研了调度系统。从原理上来说只要写好执行脚本，直接用 crontab 设置好定时任务就好。但一方面随着业务量上升我们要管理多个脚本，另一方面还想要添加进度提醒、查看日志、失败重试、邮件预警、管理多个相互依赖任务等功能。在这种情况下调研了 <strong>Ozzie/Azkaban/Airflow/Zeus/Kettle</strong> 等项目。</p>

<h4 id="关于-sqoop">关于 sqoop</h4>

<h4 id="关于-hive">关于 Hive</h4>

<h4 id="调度系统">调度系统</h4>

<h5 id="关于-airflow">关于 Airflow</h5>

<p>要求团队里至少有一个人会 Python。严格来说这不算是什么多的要求，特别是在 ML/DL/AI 如火如荼的当下，上手 Python 可能也就是一两天的事情。但总归是多了一些成本。</p>

<p>附录 A 里补充了 Airflow 的安装和使用</p>

<h5 id="关于-zeus">关于 Zeus</h5>

<p>其实我司之前用的就是 Zeus：-D 但如果要重新开始选型的话，可以有更多的选择。</p>

<ul>
  <li>
    <p>更新缓慢。最近一次和代码有关的提交是在 2013 年，源代码长时间没有进行更新，一个非常明显的 <a href="https://github.com/alibaba/zeus/pull/66">Bug Fix PR</a> 有一个月没有合并到主分支里</p>
  </li>
  <li>
    <p>部署和运维相对于其他调度工具偏难，参考它的 <a href="https://github.com/alibaba/zeus/wiki/%E5%AE%89%E8%A3%85%E6%8C%87%E5%AF%BC%E6%96%87%E6%A1%A3">安装文档</a></p>
  </li>
</ul>

<p><a href="https://github.com/michael8335/zeus2">zeus2</a> 但上一次更新是在 2014 年…</p>

<hr />

<p>附录A</p>


        </div>
        
          <p class="post-continue">
            <a href="/2016/07/03/hive-and-sqoop/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2016/05/23/Read-Python-Open-Source-Project/">阅读过的一些 Python 开源项目...</a>
          </h1>

          <p class="post-meta">May 23, 2016 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>写出 <code class="highlighter-rouge">fluent/pythonic/elegant/idiomatic</code> 的代码～～～～～～
<!-- more --></p>

<h4 id="前言">前言</h4>

<p>阅读开源项目的好处不止一个人说过，无论是为了增加对自己使用工具的理解，还是为了能学会更好地划分项目结构和提高代码质量，阅读开源项目都必不可少。</p>

<p>做毕设的时候就被老师说过之前师兄看过 <code class="highlighter-rouge">Apache</code> 服务器源码，这个目标虽然很难……但一些更易读的项目还是可以做到的：-D。阅读有的时候会有一些奇怪的东西，比如 <a href="https://github.com/requests/requests">requests</a> 在 github 上列出的第一个版本 v0.2.3 里有一个文件(core.py)是用 tab 作为 whitespace 的……，想到这么牛逼的项目在一开始也是这样……自己现在的代码写的没那么好好像也没有什么……</p>

<hr />

<h4 id="什么是-pythonic-的代码">什么是 Pythonic 的代码</h4>

<p>Pythonic 代码，就是能够把代码逻辑 Pythonic 地实现，试着进行一些小的总结：</p>

<ol>
  <li>
    <p>OOP,考虑代码复用和扩展，很多都是可以用一个基本类/ABC 来提供接口，其他子类自定义实现方法不要想着写一个大而全的类实现所有功能。</p>
  </li>
  <li>
    <p>自定义 BaseException，如 <code class="highlighter-rouge">class ProjectBasedException(Exception)</code>,然后用各种继承共有异常类的代码来处理具体异常，从而能够更有针对性地报出提示信息</p>
  </li>
  <li>
    <p>在 utils 里定义一些小的和公用的函数，将复用的代码抽象成 @decorators；在 settings 里定义会被使用的配置文件，如 url 等，避免硬编码（hard-coded）</p>
  </li>
  <li>
    <p>防御性编码（defensive programming），虽然可以用 _prefix 来做到某种程度的定义 private 属性，但对 API 传入的参数必须要做类型检测。用合理的数据结构或者其他工具（redis/celery）来限制资源的使用。发现这个时候正向逻辑的代码在整个代码的占比中会大幅下降)</p>
  </li>
  <li>
    <p>meta-programming 实现 <code class="highlighter-rouge">User-defined behaviour</code> 行为。实际上所有优秀的 Python 代码都有这一部分</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">docstring</code> 的标准注释以及自己编写单测，<code class="highlighter-rouge">logging</code> 保留日志</p>
  </li>
  <li>
    <p>在完成以上的基础上，一些细节，像用 <code class="highlighter-rouge">''.join[]</code> 来取代字符串拼接，用 <code class="highlighter-rouge">list-comprehension</code> 来取代循环等</p>
  </li>
</ol>

<hr />

<h4 id="阅读列表集合">阅读列表集合</h4>

<p>并不是所有的 Github 上高 star 项目都具有借鉴性，比如说某个 <code class="highlighter-rouge">1000+ star</code> 的项目的代码风格并不好，有大量的代码不符合 <code class="highlighter-rouge">DRY(Don't Repeat Yourself)</code> 的原则。还有许多项目直接 Hack 了 Python 本身，看到那么多以 __ 开头的变量和函数，很难理清背后的逻辑到底是什么（说的就是 Django…….）最后主要看了以下的一些代码：</p>

<hr />

<h5 id="lepture-所写的-june">@lepture 所写的 <a href="https://github.com/pythoncn/june">june</a></h5>

<p>虽然项目在描述上已经被废弃（deprecated），但还是可以顺利运行。一个论坛项目，包含了常见的 Node/Topic/Reply 三级主题。</p>

<p>a. 对 OOP 贯彻的非常彻底，以下为例：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># 在 models 模型里定义了保存的方法
</span>
<span class="k">class</span> <span class="nc">Topic</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c">#...
</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="nb">id</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>

<span class="c"># 在 forms 表单里调用了 models 里的保存方法
</span>
<span class="k">class</span> <span class="nc">TopicForm</span><span class="p">(</span><span class="n">BaseForm</span><span class="p">):</span>
    <span class="c">#...
</span>
    <span class="n">topic</span> <span class="o">=</span> <span class="n">Topic</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Topic</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span><span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>

<span class="c"># 在 views 视图里调用了 forms 里的方法
</span>
<span class="nd">@bp.route</span><span class="p">(</span><span class="s">'/create/&lt;int:id&gt;'</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span><span class="s">'POST'</span><span class="p">])</span>
<span class="nd">@require_user</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">url_name</span><span class="p">):</span>
    <span class="c">#...
</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">TopicForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="p">,</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'.view'</span><span class="p">,</span><span class="n">uid</span><span class="o">=</span><span class="n">topic</span><span class="o">.</span><span class="nb">id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'topic/create.html'</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="c"># 这样就避免了在 views 里调用模型和 db.session.add(topic) 的麻烦</span></code></pre></figure>

<p>b. 在上面看到了有一个装饰器 <code class="highlighter-rouge">@require_user</code>,这是对用户进行的权限管理。实际上试着想一下，一名用户可能会有多个角色，如果对这些角色每个都定义一个装饰器，就会有太多的重复了。在这种情况下我们来看看作者是怎么做的：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># 定义了一个基本类
</span>

<span class="k">class</span> <span class="nc">require_role</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'spam'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">'new'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">'user'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s">'staff'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">'admin'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'account.signin'</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">'?'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">+=</span> <span class="s">'?next='</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="nb">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># this is superuser, have no limitation
</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s">'new'</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">'Please verify your email'</span><span class="p">),</span> <span class="s">'warn'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'account.setting'</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s">'spam'</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">'You are a spammer'</span><span class="p">),</span> <span class="s">'error'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>

<span class="c"># 之后定义不同的权限限制
</span>

<span class="n">require_login</span> <span class="o">=</span> <span class="n">require_role</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="n">require_user</span> <span class="o">=</span> <span class="n">require_role</span><span class="p">(</span><span class="s">'user'</span><span class="p">)</span>
<span class="n">require_staff</span> <span class="o">=</span> <span class="n">require_role</span><span class="p">(</span><span class="s">'staff'</span><span class="p">)</span>
<span class="n">require_admin</span> <span class="o">=</span> <span class="n">require_role</span><span class="p">(</span><span class="s">'admin'</span><span class="p">)</span></code></pre></figure>

<hr />

<h5 id="7sdream七秒不觉梦-所写的-zhihu-oauth">@7sDream(七秒不觉梦) 所写的 <a href="https://github.com/7sDream/zhihu-oauth">zhihu-oauth</a></h5>

<p>第二个项目是 @7sDream(七秒不觉梦) 所写的 <a href="https://github.com/7sDream/zhihu-oauth">zhihu-oauth</a>。整体结构非常漂亮，meta-programming 也做的非常好。特别是考虑到作者和我是同龄人，真的是厉害厉害。顺便提了两个 PR:<a href="https://github.com/7sDream/zhihu-oauth/pull/27">pull-27</a> 和 <a href="https://github.com/7sDream/zhihu-oauth/pull/28">pull-28</a> ~</p>

<p>整体项目是这样的，作者逆解析了知乎的安卓客户端，将其中的 oauth 接口进行了封装，不同于其他的利用模拟登陆和 BeautifuoSoup 解析网页内容的库，zhihu-oauth 能提供更加稳定的接口，也更不容易被封 ip ⊙﹏⊙b</p>

<p>整个项目分为三部分：<code class="highlighter-rouge">oauth</code> 进行验证，<code class="highlighter-rouge">zhcls</code> 进行类的描述，<code class="highlighter-rouge">client</code> 将两者结合起来提供登陆的接口</p>

<p>对 oauth 部分：</p>

<ul>
  <li>
    <p>在 im_android.py 中定义了 imZhihuAndroidClient 类，继承了 requests.authbase 。在 <code class="highlighter-rouge">__init__</code> 中定义了 api_version/app_version/zpp_za/ua 等在构建参数时会用到的方法。同时用 self._api_version=api_version or API_VERSION(来自 setting.py) 的方法来允许用户自定义一些参数。之后的 <code class="highlighter-rouge">__call__(self,r)</code> 则是 authbase 的机制，会在 requests 时自动调用。</p>
  </li>
  <li>
    <p>在 before_login_auth.py 中则定义了 BeforeLoginAuth 类，继承了上面的 imZhihuAndroidClient 类，在 imZhihuAndroidClient 的基础上增加了 client_id,用 self._client_id=client_id 来进行登陆之前的基础验证。而 <code class="highlighter-rouge">__call__</code> 的实现如下：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BeforeLoginAuth</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">()</span>
    <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'oauth{0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span></code></pre></figure>

<ul>
  <li>
    <p>在 setting.py 中则定义了一些会用到的参数，如 ZHIHU_API_ROOT,LOGIN_URL=ZHIHU_API_ROOT+’/signin’,全部用大写</p>
  </li>
  <li>
    <p>在 token.py 中则定义了 ZhihuToken 类，访问知乎后所产生的 token。所以很显然根据 OOP 的思想，可以做如下工作：
在 <code class="highlighter-rouge">__init__</code> 中定义了 self._cretate_at=time.time(),self._expires_in=expires_in 初始化工具，同时还提供了这些：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">ZhihuToken</span><span class="p">:</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">json_dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZhihuToken</span><span class="p">(</span><span class="o">**</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'{} is not a valid zhihu token json'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json_dict</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_str</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZhihuToken</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'{} is not a valid zhihu token str'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json_str</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="c"># 本地持久化存储
</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="s">"""
        将 token 保存为文件
        """</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span></code></pre></figure>

<ul>
  <li>
    <p>在 utils.py 中则定义了 <code class="highlighter-rouge">login_signature(data,secret)</code> 函数，为经过签名后的 dict 添加了 timestamp 和 signature 两项（这就是业务相关了，将签名和主体的验证函数分开）</p>
  </li>
  <li>
    <p>在 zhihu_oauth.py 中定义了 ZhihuOAuth,相比于 BeforeLoginAuth,这个类同样继承了 imZhihuAndroidClient,所不同的是增加了发送 token 的功能，参见：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ZhihuOAuth</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'{type} {token}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">capitialize</span><span class="p">()),</span> <span class="c"># self._token 是在 __init__ 里定义的
</span>
        <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="nb">type</span><span class="p">)</span> <span class="c"># self._token.type 就再次看到了 OOP 的存在
</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span></code></pre></figure>

<p>下面进行 zhcls 的分析，在分析之前先看一下 exception.py 的实现。正如前面所说，exception 应该提供一个整个项目的错误。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>try:
    from json import JSONDecodeError as MyJSONDecodeError
except ImportError:
    MyJSONDecodeError = Exception

# 对 py3 用 JSONDecodeError,而用 py2 每次都用纯 exception 来处理 JSON 格式解析错误也
# 太不 Pythonic 了

</code></pre>
</div>
<p>在实现的各种异常里最有通用性的还是 UnexpectedResponseException:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class UnexpectedResponseException(Exception):
    def __init__(self,url,res):
        """
        此处做了适当演绎
        对于所有 JSON 没有符合预期的错误，都可以用该异常来处理
        """
        self.url = url
        self.res = res

    def __repr__(self):
        return "when visit {self.url},get an unexpected response {self.res.text}".
            format(self=self)

    __str__ = __repr__

</code></pre>
</div>

<p>在 zhcls 中，Base.py 定义了基本类，从而可以被各种类来继承：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Base(object):
    def __init__(self,zhihu_obj_id,cache,session):
        """
        Base 中的 cache 类表示已知的属性值，一般由另一个对象的 JSON 数据中的一个属性充当

         比如 :any:`Answer.author` 方法，由于在请求 :any:`Answer` 的数据时，
         原始 JSON 数据中就有关于作者的一些简单信息。比如 name，id，headline。
         在使用此方法时就会将这些不完整的数据传递到 ``answer`` 对象 （类型为
         :any:`People`）的 ``cache`` 中。这样一来，在执行
         ``answer.author.name`` 时，取出名字的操作可以省去一次网络请求。

         在使用 @normal_attr,@other_obj,@streaming 时都会优先使用 cache 中的数据，在获取失败时
         才会调用 _get_data 方法请求数据

         // 这里的 cache 还是挺复杂的,相比之下 session 还是好理解的～
        """
        self._id = zhihu_obj_id
        self._cache = cache
        self._session = session

    def _get_data(self):
        """
        它需要用到 4 个方法，都是类里面的
        """
        if self._data is None:
            url = self._build_url()
            res = self._session.request(
                method = self._method(),
                url = url,
                params = self._build_params,
                data = self._build_data())
            e=GetDataErrorException(
                url,res,'valid zhihu {0} JSON data'.format(self.__class__.__name__))
            try:
                json_dict = res.json()
                if 'error' in json_dict:
                    raise e
                self._data = json_dict
            except JSONDecodedError:
                raise e

    @abc.abstractmethod
    def _build_url(self):
        """
        子类必须重载这一方法
        """
        return ''

        def _build_params(self):
            return None

        def _build_data(self):
            return None

        def _method(self):
            return 'GET'

</code></pre>
</div>

<ul>
  <li>对于很多像同一问题下的答案，answers，需要用 generator.py 来定义并生成了一系列的生成器</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>class BaseGenerator(object):
    def __init__(self,url,session):
        self._url = url
        self._session = session
        self._index = 0
        self._data = []
        self._up = 0
        self._next_url = self._url
        self._need_sleep = 0.5
        self._extra_params = {}

    def _fetch_more(self):
        # 这一部分是关于具体的实现，就不多写了
        # 大概就是说要设置一个 wait_time 如果不大于 MAX_WAITTIME 就

    @abc.abstractmethod
    def _build_obj(self,data):
        """
        进行构造对象
        """
        return None

    def __getitem__(self,item):
        """ 对　范围进行迭代 """
        if not isinstance(item,int):
            raise TypeError('{0} must be int'.format(item))

        while item&gt;=self._up:
            if self._next_url is nont None:
                self._fetch_more() # 在 fetch_more 的过程中会使得 self._up 增加
            else:
                raise IndexError('Index out of range')
        # 写代码的时候先写下面的，再写上面的，对异常处理
        return self._build_obj(self._data[item])

    def __iter__(self):
        return self # 默认进行迭代的方式，可以直接用 yield 直接生成

    def __next__(self):
        """ 提供迭代方式访问数据，for xx in obj.xxxs　
        用 self._index 来存储下一次迭代的下标"""
        try:
            obj=self._data[self._index] # 突然意识到它和 obj=self[self._index]
            # 效果是一样的，可以可以，非常 Pythonic
        except IndexError:
            self._idnex=0
            raise StopIteration # 学以致用
        self._index+=1
        return obj

    next=__next__ # 适配 Py2 和 Py3
</code></pre>
</div>

<p>下面以生成答案 AnswerGenerator 为例：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class AnswerGenerator(BaseGenerator):
    def __init__(self,url,session):
        super(AnswerGenerator,self).__init__(url,session)
    def _build_obj(self):
        from .answer imoprt Answer # 避免循环引用还有其他
        return Answer(data['id'],data,self._session) # 哪来的 data。。。这个变量是怎么来的
</code></pre>
</div>

<p>下面就是一个装饰器，用来循环生成列表：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
def generator_of(url_pattern, class_name=None):
    def wrappers_wrapper(func):
        @functools.wraps(func)
        def wrapper(self, *args, **kwargs):
            cls_name = class_name or func.__name__

            if cls_name.endswith('s'):
                cls_name = cls_name[:-1]
            cls_name = cls_name.capitalize()

            gen_cls_name = cls_name + 'Generator'
            try:
                gen_cls = getattr(sys.modules[__name__], gen_cls_name)
            except AttributeError:
                return func(*args, **kwargs)

            self._get_data()

            return gen_cls(url_pattern.format(self.id), self._session)

        return wrapper

    return wrappers_wrapper
</code></pre>
</div>

<p>还用到了一个装饰器是 normal_attr,直接从 data 中提取属性并返回：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def normal_attr(name_in_json=None):
    """
    标志这个属性为常规属性，自动从对象的数据中提取对应属性返回
    """
    def wrappers(func):
        @functools.wraps(func)
        def wrapped_func(self,*args,**kwargs):
            def use_data_or_func(name,data):
                if can_get_from(the_name,data):
                    return data[name]
                else:
                    return func(*args,**kwargs)
            name=name_in_json if name_in_json else func.__name__ 
            if self._data:
                return use_data_or_func(name,self._data)
            elif self._cache and can_get_from(name,self._cache):
                return self._cache[name]
            else:
                # 对于 id ,需要特殊对待
                if name=='id':
                    return func(self,*args,**kwargs)
                self._get_data() # 来取得数据

                if self._data:
                    return use_data_or_func(name,self._data)

        return wrapped_func

    return wrappers

</code></pre>
</div>

<ul>
  <li>关于 StreamingJSON 数据这里就不详细写了</li>
</ul>

        </div>
        
          <p class="post-continue">
            <a href="/2016/05/23/Read-Python-Open-Source-Project/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2015/10/21/Django-And-CortexForum/">Django 学习及 cortexForum</a>
          </h1>

          <p class="post-meta">Oct 21, 2015 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>关于 Django 的学习资料以及 cortexForum</p>

<!-- more -->

<h5 id="学习资料">学习资料</h5>

<p>主要看的是 Django 的官方 tutorial 和 <a href="http://www.tangowithdjango.com/book17/">tango with Django</a></p>

<p>进阶的书包括：</p>

<ul>
  <li>
    <p>《Two Scopes of Django》:Django 作者是 Django 的社区开发者，汇聚了一大批的最佳实践</p>
  </li>
  <li>
    <p>《Test Driven Web Development》:以 TDD(测试驱动开发) 方式所写的关于 Django 开发的一本书，非常漂亮啊</p>
  </li>
</ul>

<hr />

<h5 id="cortexforum">cortexForum</h5>

<p>在文档的学习过程中所有遇到的问题和有必要的记录都在 Wiznote 里保存，方便进行复习balabala</p>

<p>最近在做毕设的过程中实在是看不下去论文了，便有了写一个有 Django 最佳实践的论坛的想法。在写 <a href="https://github.com/Allianzcortex/cortexForum">cortexForum</a> 的过程中，自己尽量实现了以下几点：</p>

<ul>
  <li>
    <p>在代码中将所用到的文档模块和对应的具体用法进行标志，方便查找</p>
  </li>
  <li>
    <p>标注中有 SO 的部分说明它很常用，并且 stackoverflow 上有相关的问题(比如query_set() 里的 lookup field)</p>
  </li>
  <li>
    <p>对于有多种解决方法的部分都在注释里写了出来(比如 <code class="highlighter-rouge">objects.filer().update 和 instance.save()</code>)</p>
  </li>
  <li>
    <p>用 gitbook 的格式作为 wiki，对于 forum 的设计有这样一个总体的概述</p>
  </li>
</ul>

<hr />

<ul>
  <li>Django 的 models 模型里有一个 Manager 对象，非常方便实现 OOP(实现 HighLevel 而不仅仅是具体实例的行为)，以发帖的单位 Topic 为例，定义发帖的 title 和 content 之后，再定义两个外键，一个是 node,定义帖子发表的节点；一个是 author，定义帖子发表的作者。对于一个帖子来说，我希望能通过一个 node 的名称(这里可以理解为 slug )，或者一个作者的名称(username)，就能得到所有主题的信息，所以你就需要定义：</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_all_topic_by_node_slug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_slug</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">node__slug</span><span class="o">=</span><span class="n">node_slug</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">select_related</span><span class="p">(</span><span class="s">'node'</span><span class="p">,</span> <span class="s">'author'</span><span class="p">,</span> <span class="s">'last_replied_by'</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">order_by</span><span class="p">(</span><span class="s">'-last_replied_time'</span><span class="p">,</span> <span class="s">'-reply_count'</span><span class="p">,</span> <span class="s">'-created_at'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span></code></pre></figure>

<p>通过 queryset() 的重定义，你可以用 <code class="highlighter-rouge">Node.objects.get_all_topic_by_node_slug('slug-example')</code> 来获取主题信息。而如果你不这样做的话，就需要在每个 views 的函数里来多次重新定义，并且一旦模型发生更改就很难再修正过来了，比 hard-coded 还复杂的重写。</p>

<p>而 form 里没有为我们定义更高层次的抽象，但并不妨碍我们进行 OOP，以 authen 的 registrationForm 为例，我们在 forms 里进行了 <code class="highlighter-rouge">clean_username</code>,<code class="highlighter-rouge">clean_mail</code>,重写了默认的 clean 方法，在进行 <code class="highlighter-rouge">is_valid()</code> 验证的时候就会直接提出错误信息。</p>

<hr />

<p>在前端方面，自己完全采用 bootstrap 的架构。</p>

<p>关于手写 HTML 还是用 <code class="highlighter-rouge">Crispyforms/Django-bootstrap3 </code>，这种东西见仁见智，我觉得还是用纯粹的手写 HTML 比较好，因为这样的解决方式是前后端分离的，在下次学习其他框架的时候也能用到，你只需要传给前端需要用到的 API 就行。</p>

<p>比如</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"id_"</span> <span class="na">class=</span><span class="s">"col-md-3 control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-9"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"id_"</span> <span class="na">required</span> <span class="na">name=</span><span class="s">""</span> <span class="na">autofocus</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>请输入你的用户名<span class="nt">&lt;/p&gt;</span>

```<span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"id_"</span> <span class="na">class=</span><span class="s">"col-md-3 control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-9"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"id_"</span> <span class="na">required</span> <span class="na">name=</span><span class="s">""</span> <span class="na">autofocus</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>请输入你的用户名<span class="nt">&lt;/p&gt;</span></code></pre></figure>

<p>就要比 <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="err">form.as_p</span><span class="w"> </span><span class="p">}</span></code> 或者 <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="err">crispy</span><span class="w"> </span><span class="err">form</span><span class="w"> </span><span class="p">}</span><span class="w"> </span></code>更能实现定制化，crispy-forms 的思想是在 forms 里设置 layout 和对应的 label，想要更新前端显示需要在后端修改代码而不是 CSS 文件……</p>

<hr />

<p>Mysql 问题还是挺多的。一开始的情况下，英文发帖是正常的。之后按照 <a href="hthttps://blog.ionelmc.ro/2014/12/28/terrible-choices-mysql/tps://blog.ionelmc.ro/2014/12/28/terrible-choices-mysql/">mysql-utf-8</a> 里的方法采用 utf-8 编码之后就会发生只有管理员可以正常发帖，而其他用户在发帖时会提醒 second column not exists ,SO 上的解决方法都没有效果，最后分析下觉得有可能是因为 user 和 forumUser 对应的 id 不对其造成的，所以手动添加一个 request.User 后解决问题。</p>

<p>下次还是用 PG 吧……为什么第一次用 onetooneField 的时候就没有这种错误？要用 abstractUser 去扩展 User 模型去……</p>

<hr />

        </div>
        
          <p class="post-continue">
            <a href="/2015/10/21/Django-And-CortexForum/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2015/09/14/Use-PyQt-Develop-Desktop-Web-GUI/">Develop a desktop client with PyQT</a>
          </h1>

          <p class="post-meta">Sep 14, 2015 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>In this novel,I’ll demonstrate how to read the database and display it , with Python’s dynamic mechanism and Qt’s signal slot.</p>

<!-- more -->

<p><a href="/../translation/2015-09-14-Use-PyQt-Develop-Desktop-Web-GUI.html">这篇文章对应的中文版</a></p>

<hr />

<p>This is a program that can detect network connections. The screenshot of the interface is as follows</p>

<p><img src="/images/pyqt-example.png" alt="PyQt" /></p>

<p>There will be very few opportunities to write the client in the future(I mean many professional clients are mainly developed by C#/.net,although actually dropbox developed its’ client with PyQT)… So I won’t pursue the best practices. I just need to make a <strong>poke-marked GUI</strong> .⊙﹏⊙b</p>

<h4 id="ui-and-interface-corresponding">UI and interface corresponding</h4>

<p>PyQt itself is similar to Qt’s signal slot mechanism. When a button is clicked, a signal is sent and the processing mechanism of the signal needs to be defined.</p>

<p>The design interface is designed directly with the <strong>designer</strong>. Drag <code class="highlighter-rouge">button/listview/model</code> and customize the name.</p>

<p>After generating the .ui file, use <code class="highlighter-rouge">pyuic4 –x ping_ui.ui –o ping_ui.py</code> to see that the ping_ui.py file contains <code class="highlighter-rouge">class Ui_Form(object)</code>, which has various lengths/locations defined. It’s More convenient than handwriting</p>

<p>Then define a <code class="highlighter-rouge">pyqt_example2.py</code> which contains the following files:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">CalculateForm</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CalculateForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">Ui_Form</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code></pre></figure>

<p>then define the execution function：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">CalculateForm</span><span class="p">()</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span></code></pre></figure>

<p>After execution, you can see that the interface has been successfully displayed.</p>

<p>The next step is to establish a signal slot mechanism. For example, when the button of the ui was originally defined, there is a button named <code class="highlighter-rouge">add_url</code> . We want to associate it with the function of <code class="highlighter-rouge">add_url</code> , just define it as follows (preferably in <strong>init</strong> ):</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">add_url</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_url_func</span><span class="p">)</span> <span class="c"># click function</span></code></pre></figure>

<h4 id="crud-and-display">CRUD and Display</h4>

<p>The model defined in PyQt is <code class="highlighter-rouge">QSqlTableModel</code>, and the definition of table is <code class="highlighter-rouge">listview</code>.
For example, define the method of initialize_model() :</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">db</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlDatabase</span><span class="o">.</span><span class="n">addDatabase</span><span class="p">(</span><span class="s">'QSQLITE'</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">setDatabaseName</span><span class="p">(</span><span class="s">'test_ping.db'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">setTable</span><span class="p">(</span><span class="s">'url_ping'</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">setEditStrategy</span><span class="p">(</span><span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlTableModel</span><span class="o">.</span><span class="n">OnManualSubmit</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">setHeaderData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">,</span> <span class="s">u"url"</span><span class="p">)</span> <span class="c"># url link</span></code></pre></figure>

<p>To display, just connect the listview with the corresponding model:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">show_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">QSqlTableModel</span><span class="p">()</span>
    <span class="n">initialize_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">url_list</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="c"># self.ui.url_list is  listview
</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">url_list</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></figure>

<p>You can see the latest database, equivalent to refreshing, by calling the self.show_view() method after each addition, deletion, and change.</p>

<h5 id="how-to-execute-a-query">How to execute a query</h5>

<p>For example, to find the content containing ‘test’, the code is as follows:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">()</span>
<span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="s">"select * from test where value like '</span><span class="si">%</span><span class="s">test</span><span class="si">%</span><span class="s">'"</span><span class="p">)</span></code></pre></figure>

<p>And if you want to show with a better way,then redefine QSqlQueryModel</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sqlQueryModel</span><span class="o">.</span><span class="n">setQuery</span><span class="p">(</span><span class="s">"select * from test where value like '</span><span class="si">%</span><span class="s">test</span><span class="si">%</span><span class="s">' "</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">url_list</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">sqlQueryModel</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">url_list</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></figure>

<p>Define the popup: Use the simplest of the following functions:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">show_messagebox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">u'detect successfully'</span><span class="p">)</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></code></pre></figure>

<h4 id="ui-and-execution-thread-separation">Ui and execution thread separation</h4>

<p>How to set the ui and execute task thread separation so that the application won’t be non-reactive:</p>

<p>There are many ways to do this. I chose the following method:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="n">QThread</span>

<span class="k">class</span> <span class="nc">PingThread</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
    <span class="s">""" define PingThread """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">QThread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ping_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">'ping url'</span><span class="p">))</span>
        <span class="k">return</span>

<span class="s">""" Then call it in the main thread. """</span>

<span class="bp">self</span><span class="o">.</span><span class="n">pingThread</span> <span class="o">=</span> <span class="n">PingThread</span><span class="p">(</span><span class="n">target_url</span><span class="p">)</span>
<span class="c"># self.connect(self.pingThread, SIGNAL('ping url'), self.show_messagebox) 可选
</span>
<span class="bp">self</span><span class="o">.</span><span class="n">pingThread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></code></pre></figure>

<h4 id="progressbar">ProgressBar</h4>

<p>The progress bar in PyQt is displayed using QProgressBar. When set in ui, there will be a minimum value (default is 0) and a maximum value (default is 100).</p>

<p>Just set it when updating</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">click_progrress</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="c">#  progresses to 30%
</span>
<span class="c"># click_progress 是 ui 里对应的 ProgressBar</span></code></pre></figure>

<h4 id="other-stuffs">Other Stuffs</h4>

<p>The ping calls the ping API that comes with the system.</p>

<p>Tracert calls the tracert API in windows (the corresponding Linux command is traceroute)</p>

<p>Telnet is to detect if the port is open. Directly calling the system command has two drawbacks:</p>

<p>1 Windows requires the user to manually open the configuration</p>

<p>2 telnet uses the cursor to flash to determine the port status with no return value, it is not convenient for program processing.</p>

<p>So final decision is to use socket to connect:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="n">url_name</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="n">port_open</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span></code></pre></figure>

<p>PyQt comes with a lot of demos in site-packages, and it’s faster to see the code directly than the documentation.
At the time of the study, I wrote a calculator demo that adds genuine. When the input number or the selected calculation symbol changes, the calculation result is automatically changed (well, eval()~ and the Python decorator is used. characteristic.</p>

        </div>
        
          <p class="post-continue">
            <a href="/2015/09/14/Use-PyQt-Develop-Desktop-Web-GUI/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2015/03/11/Python-Import-Mechanism/">Python 中的引用机制</a>
          </h1>

          <p class="post-meta">Mar 11, 2015 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>解决 <code class="highlighter-rouge">No module named</code> 和 <code class="highlighter-rouge">Attempted relative import</code> 这两个问题
<!-- more --></p>

<h2 id="两个引用时最常见的问题">两个引用时最常见的问题</h2>

<h3 id="no-module-named-xxxz">No module named XXXz</h3>

<p>在编译时遇到 <code class="highlighter-rouge">No Module Named XX</code> 。这个问题曾经遇到过，并且用命令行执行时会报错，但用 Pycharm 的运行按钮就可以顺利执行。最后发现错误的过程也很简&gt;单，在编辑配置一项里勾选 “show command line afterwards”，然后执行　<code class="highlighter-rouge">import sys;sys.path</code> 命令，和在命令行里的选项进行对比，发现前者多了一个 <code class="highlighter-rouge">/home/hzcortex/projects...</code> 的模块。也就是说 Python 并没有把执行命令的这个脚本所在的目录加入 sys.path 中。</p>

<hr />

<p>解决方法是在报错的文件目录下加入：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))))</span></code></pre></figure>

<h3 id="attempted-relative-import-in-non--package">Attempted relative import in non  package</h3>

<p>这个问题要分两类来进行讨论：</p>

<p>① 在引用的时候确实发生了循环引用，A 要引用 B，B 要引用 C，而 C 同时要引用 B 里的一个函数。这时通常的解决办法是修改 C 文件的引用顺序，把 <code class="highlighter-rouge">import</code> 语句放到需要使用引用对象的语句前(参考 《Python 核心编程》 的说法)。最近在开发 <a href="https://github.com/Allianzcortex/FBRank">FBRank</a> 的时候确实遇到了这个问题，项目结构是这样的：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">└──</span> <span class="n">utils</span>
    <span class="err">├──</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">py</span>
    <span class="err">├──</span> <span class="n">__init__</span><span class="o">.</span><span class="n">py</span>

<span class="c"># utils.py
</span>
 <span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">NotSupprotedYetException</span>

<span class="k">def</span> <span class="nf">check_before</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="s">'name'</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">raise</span> <span class="n">NotSupprotedYetException</span>
    <span class="o">...</span>

<span class="c"># exceptions.py
</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">github_url</span><span class="p">,</span> <span class="n">connect_url</span>

<span class="k">class</span> <span class="nc">NotSupprotedYetException</span><span class="p">(</span><span class="n">FBRankException</span><span class="p">):</span>
    <span class="s">"""still not supprt
    """</span></code></pre></figure>

<p>之后在执行程序的时候出现了这样的错误：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>File "/home/hzcortex/FBRank/FBRank/parse/League.py", line 13, in &lt;module&gt;
    from FBRank.utils.exceptions import IllegalArgumentException, NotSupprotedYetException
  File "/home/hzcortex/FBRank/FBRank/utils/exceptions.py", line 2, in &lt;module&gt;
    from .utils import github_url, connect_url
  File "/home/hzcortex/FBRank/FBRank/utils/utils.py", line 5, in &lt;module&gt;
    from .exceptions import NotSupprotedYetException
ImportError: cannot import name 'NotSupprotedYetException'

</code></pre>
</div>
<p>自上而下看调用的顺序，在 /exceptions.py 里从 .utils.py 调用了 <code class="highlighter-rouge">github_url, connect_url</code> 这两个变量，而在调用 .utils.py 时又从 /exceptions.py 调用了 NotSupprotedYetException，这样就互相循环，永远都无法解决引入。解决办法就是只在需要使用的函数时再加载：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># utils.py
</span>

<span class="k">def</span> <span class="nf">check_before</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="s">'name'</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">NotSupprotedYetException</span>
    <span class="c"># ......</span></code></pre></figure>

<p>因为 Python 的引用机制并不会重新引入之前已经引入的包(需要的话要用 <code class="highlighter-rouge">imp.reaload()</code>)，所以不用担心这种引入会对性能产生影响</p>

<p>② 如果确实没有循环引用，那么通常是如下的情况：</p>

<p>拿之前写的一个从 Kafka 向 ES 导数据的程序来举例子。整个程序的结构如下(好像紫色对比度比较高…)：</p>

<p><img src="/images/RLTES-2.png" alt="RLTES-Project" /></p>

<p>在主程序 <code class="highlighter-rouge">RealtimeLogToES.py</code> 里有如下的引用：</p>

<p><img src="/images/RLTES-1.png" alt="RLTES-import" /></p>

<p>如果在这种情况下进入到 RLTES 目录里直接执行 <code class="highlighter-rouge">python RealtimeLogToES.py</code>，那么就会报上面的循环引用的错。</p>

<p>解决方法再有以下两种：</p>

<p>① 将 <code class="highlighter-rouge">from .config import</code> 改为和下面一样的绝对引用，<code class="highlighter-rouge">from RLTES.config import</code></p>

<p>② 不修改代码，退回到上一层目录,<code class="highlighter-rouge">cd ..</code>，之后执行 <code class="highlighter-rouge">python -m RLTES.RealtimeLogToES</code></p>

<p>Python 在进行相对引入的时候，判断的根据是当前文件的 <strong>name</strong> 属性。而当你执行一个文件的时候，该文件原有的 <strong>name</strong> 属性被替代为了固定的 ‘<strong>main</strong>‘,所以相对引入就无法工作，而绝对引入是没有问题的。在命令行里加入-m 后，告诉 Python 解释器应该将这个文件作为一个脚本来运行。</p>

<h5 id="为什么会发生这种问题">为什么会发生这种问题</h5>

<p>要真正理解 Python 的 import 机制是如何查找变量的。</p>

<h5 id="到底怎么引用">到底怎么引用</h5>

<p>PEP8 里建议是一直用绝对引用，但就像那个 <code class="highlighter-rouge">annoying double underscore</code> 一样，不喜欢绝对引用的也大有人在。</p>

<p>团队里面保持一致即可。就个人开发来说，还是更喜欢单层采用用 .import，其他用绝对引用。</p>

<p>在 <strong>《Two Scopes Of Django》</strong> 一书里明确说明了禁止使用如 <code class="highlighter-rouge">from A import a</code> 这样的 <strong>implicit import</strong> 语句，但考虑到很多时候写脚本并不会具体到一个大的工程，而是在服务器上建立一个目录去完成一个特定的功能，如果这么写能方便调试和部署，那么也没有大的问题。</p>

<h5 id="__init__py-的作用"><code class="highlighter-rouge">__init__.py</code> 的作用</h5>

<p><code class="highlighter-rouge">__init__.py</code> 最重要的作用就是标记含有该 <code class="highlighter-rouge">__init__.py</code> 目录的文件夹为一个 package ，从而完成对应的引入。</p>

<p>大部分情况下 <code class="highlighter-rouge">__init__.py</code> 里什么内容也不用写，如果一定要写的话基本有以下三个作用：</p>

<ul>
  <li>
    <p>写 <code class="highlighter-rouge">__author__</code> 等有关信息</p>
  </li>
  <li>
    <p>写一个 <code class="highlighter-rouge">__all__</code> 的配置，精确定义在 <code class="highlighter-rouge">from x import *</code> 时候会引入的内容</p>
  </li>
  <li>
    <p>如果说前两个都无关紧要的话，那么最后一个就比较多了，可以简化引入方式，用来控制 API 的稳定性。</p>

    <p>还是拿写的 <a href="github.com/Allianzcortex/FBRank">FBRank</a> 来举例子。虽然你看在 README 里写的是只支持命令行工具，但其实它也提供了在代码里引入的能力。举个例子：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python">  <span class="c"># 想要引入某个异常，需要具体到对应的文件
</span>
  <span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">FBRank.utils.exceptions</span> <span class="kn">import</span> <span class="n">IllegalArgumentException</span>

  <span class="c"># 但想要引入某个类，只要具体到对应的 package 就可以了
</span>
  <span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">FBRank.object</span> <span class="kn">import</span> <span class="n">Club</span>

  <span class="c"># 具体原因是在 FBRank/object 下的 __init__.py 里有如下代码
</span>
  <span class="kn">from</span> <span class="nn">.League</span> <span class="kn">import</span> <span class="n">League</span>
  <span class="kn">from</span> <span class="nn">.Club</span> <span class="kn">import</span> <span class="n">Club</span>
  <span class="kn">from</span> <span class="nn">.Player</span> <span class="kn">import</span> <span class="n">Player</span>
  </code></pre></figure>


        </div>
        
          <p class="post-continue">
            <a href="/2015/03/11/Python-Import-Mechanism/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2015/03/11/Dynamic-Programming-Explanation/">DP 解题思路</a>
          </h1>

          <p class="post-meta">Mar 11, 2015 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>动态规划例题及 Leetcode 题解
<!-- more --></p>

<h4 id="关于-dp">关于 DP</h4>

<ul>
  <li>
    <p>动态规划是一门非常重要的算法，对它的掌握应该是计算机科学专业学生的基本功</p>
  </li>
  <li>
    <p>下面来把对这类算法的理解进行尽可能多的解释</p>
  </li>
  <li>
    <p>关键是 <strong>状态定义</strong> 和 <strong>状态转移方程</strong></p>
  </li>
</ul>

<hr />

<h4 id="最长递增子序列">最长递增子序列</h4>

<blockquote>
  <p>给定K个整数的序列{ N1, N2, …, NK }，其任意连续子序列可表示为{ Ni, Ni+1, …, Nj }，其中 1 &lt;= i &lt;= j &lt;= K。最大连续子序列是所有连续子序中元素和最大的一个， 例如给定序列{ -2, 11, -4, 13, -5, -2 }，其最大连续子序列为{ 11, -4, 13 }，最大和为20。</p>
</blockquote>

<ul>
  <li>
    <p>定义<code class="highlighter-rouge">sum[i]</code>为’以A[i]作为最后一个结尾的连续子序列的最大值’</p>
  </li>
  <li>
    <p>状态转移方程为：sum[i]=max(sum[i-1]+a[i],a[i])</p>
  </li>
  <li>
    <p>实际求解的时候则是，只要sum&gt;0，那么加上之后的a[i]都还是有可能使max增大的；但如果sum&lt;0，则应该立即抛弃，从0开始计算下一个</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">}</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">max</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="nb">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">sum</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">:</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="nb">sum</span>
    <span class="k">if</span> <span class="nb">sum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="k">return</span> <span class="nb">sum</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">LIS</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">n</span><span class="o">];</span> <span class="c1">// 存储长度
</span>
        <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">index</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">n</span><span class="o">];</span> <span class="c1">// 存储距离
</span>
        <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>


        <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">arr</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">arr</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">list</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">list</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">index</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="c1">// 选择出最大的
</span>
        <span class="kt">int</span> <span class="n">max_index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">max</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                <span class="n">max_index</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>


        <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">arr</span><span class="o">[</span><span class="n">max_index</span><span class="o">]);</span>
        <span class="kt">int</span> <span class="n">next_index</span> <span class="o">=</span> <span class="n">index</span><span class="o">[</span><span class="n">max_index</span><span class="o">];</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">next_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">arr</span><span class="o">[</span><span class="n">next_index</span><span class="o">]</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
            <span class="n">next_index</span> <span class="o">=</span> <span class="n">index</span><span class="o">[</span><span class="n">next_index</span><span class="o">];</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span> <span class="c1">// 输出子序列
</span>
        <span class="k">return</span> <span class="n">max</span><span class="o">;</span></code></pre></figure>

<hr />

<h4 id="数塔问题">数塔问题</h4>
<p><img src="/images/hdu-2084.jpg" alt="img" /></p>

<blockquote>
  <p>要求从顶层到底层，每一层只能走到相邻节点，求经过的数字之和是多少</p>
</blockquote>

<ul>
  <li>
    <p>定义状态方程：max[i,j] 表示以 [i,j] 作为起始点，所经过的最大的数字之和。则 max[1,1] 是我们要求的目标</p>
  </li>
  <li>
    <p>定义状态转移方程：max[i,j]=num[i,j]+max(max(i+1,j),max(i+1,j+1))</p>
  </li>
  <li>
    <p>接下来可以自底向上，也可以自顶向下，具体参见之前所写的关于<a href="http://acm.hdu.edu.cn/showproblem.php?pid=2084">hdu2084</a>的<a href="http://blog.csdn.net/allianzcortex/article/details/41620503">博文</a></p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include&lt;iostream&gt;  
#include&lt;cstring&gt;  
</span><span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">;</span>  
<span class="cp">#define maxnum 1000  
</span><span class="kt">int</span> <span class="n">num</span><span class="p">[</span><span class="n">maxnum</span><span class="p">][</span><span class="n">maxnum</span><span class="p">];</span>  
<span class="kt">int</span> <span class="n">d</span><span class="p">[</span><span class="n">maxnum</span><span class="p">][</span><span class="n">maxnum</span><span class="p">];</span>  
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">;</span>  
    <span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">;</span>  
    <span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">n</span><span class="p">;</span>  
    <span class="k">while</span><span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">){</span>  
        <span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">m</span><span class="p">;</span>  
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">m</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>  
            <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>  
            <span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>  
        <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">m</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">d</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">num</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>  
  
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>  
            <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>  
            <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>  
        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>  
        <span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>  
    <span class="p">}</span>  
<span class="p">}</span>  </code></pre></figure>

<hr />

<h4 id="背包问题">背包问题</h4>

<ul>
  <li>
    <p>有著名的背包问题九讲，这里自己先写最基本的</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">有N件物品和一个容量为V的背包。第i件物品的费用是c[i]，价值是w[i]。求解将哪些物品装入背包可使价值总和最大</code></p>
  </li>
  <li>
    <p>如果单纯使用递归来求解 DP 的话有两种思路</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">Knapsack1</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">value</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">weight</span><span class="o">,</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">weight</span><span class="o">[</span><span class="n">number</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="o">)</span>
            <span class="k">return</span> <span class="nf">Knapsack1</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">capacity</span><span class="o">,</span> <span class="n">number</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="nf">max</span><span class="o">(</span><span class="n">value</span><span class="o">[</span><span class="n">number</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="n">Knapsack1</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">capacity</span> <span class="o">-</span> <span class="n">weight</span><span class="o">[</span><span class="n">number</span> <span class="o">-</span> <span class="mi">1</span><span class="o">],</span> <span class="n">number</span> <span class="o">-</span> <span class="mi">1</span><span class="o">),</span>
                    <span class="n">Knapsack1</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">capacity</span><span class="o">,</span> <span class="n">number</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">Knapsack2</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">value</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">weight</span><span class="o">,</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">weight</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="o">)</span>
            <span class="k">return</span> <span class="nf">Knapsack2</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">capacity</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="nf">max</span><span class="o">(</span><span class="n">value</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">+</span> <span class="n">Knapsack2</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">capacity</span> <span class="o">-</span> <span class="n">weight</span><span class="o">[</span><span class="n">index</span><span class="o">],</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">),</span>
                    <span class="n">Knapsack2</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">capacity</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>

        <span class="c1">// KnapSack 问题，两种调用
</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="mi">60</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="mi">120</span><span class="o">};</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">weight</span> <span class="o">=</span> <span class="o">{</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mi">30</span><span class="o">};</span>
        <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">50</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dp</span><span class="o">.</span><span class="na">Knapsack1</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">capacity</span><span class="o">,</span> <span class="n">number</span><span class="o">));</span> <span class="c1">// 220
</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dp</span><span class="o">.</span><span class="na">Knapsack2</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">weight</span><span class="o">,</span> <span class="n">capacity</span><span class="o">,</span> <span class="n">index</span><span class="o">));</span>  <span class="c1">// 220</span></code></pre></figure>

<hr />

<h4 id="leetcode-上相关题目">Leetcode 上相关题目</h4>

<h5 id="303-range-sum-quwey---immutable">303 Range Sum Quwey - Immutable</h5>

<ul>
  <li>
    <p><a href="https://leetcode.com/problems/range-sum-query-immutable/">链接</a></p>
  </li>
  <li>
    <p>大意：给出一个数组，要求返回任意两个区间范围的的值</p>
  </li>
  <li>
    <p>思路：题目中说到<code class="highlighter-rouge">many calls to function</code>，所以多次遍历求解肯定会TLE；而sum[i,j]=sum[j]-sum[i-1]，所以一次遍历求出所有的sum值之后做减法就可以。注意要用全局变量</p>
  </li>
  <li>
    <p>代码：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// c++版
//用vector&lt;int&gt; 来存储状态会更好
</span><span class="n">class</span> <span class="n">NumArray</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">dp</span><span class="p">[</span><span class="mi">100000</span><span class="p">];</span>
<span class="n">public</span><span class="o">:</span>
    <span class="n">NumArray</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">nums</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">;</span>
        <span class="kt">int</span> <span class="n">length</span><span class="o">=</span><span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dp</span><span class="p">));</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">length</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">sumRange</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dp</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">dp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>    
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure>

<p>python版：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">NumArray</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="n">nums</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">sumRange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span></code></pre></figure>

<hr />

<h5 id="70-climbstatirs">70 climbStatirs</h5>

<ul>
  <li>
    <p><a href="https://leetcode.com/problems/climbing-stairs/">链接</a></p>
  </li>
  <li>
    <p>大意：登上一个楼梯，可以走1步，可以走两步，问走到n步有几种解法</p>
  </li>
  <li>
    <p>思路：用dp[n]来表示走到n步的方法数。对dp[n-1],只能选择走1步；对dp[n-2]，
如果选择1+1，就会和dp[n-1]有重叠，只能选择2步</p>
  </li>
  <li>
    <p>代码：
C++版：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">class</span> <span class="n">Solution</span> <span class="p">{</span>
<span class="n">public</span><span class="o">:</span>
    <span class="kt">int</span> <span class="n">climbStairs</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]);</span>
        <span class="k">return</span> <span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure>

<p>python版：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Solution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="o">=</span><span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">climbStairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>  </code></pre></figure>

<hr />

<h5 id="64-minimum-path-sum">64 Minimum Path Sum</h5>

<ul>
  <li>
    <p><a href="https://leetcode.com/problems/minimum-path-sum/">链接</a></p>
  </li>
  <li>
    <p>大意：m*n的全为正数的矩阵，可以向右向下移动，求从左上到右下经过的距离之和最小值</p>
  </li>
  <li>
    <p>思路：动态规划，用dp[i][j]表示以i,j作为最后一个方块所经过的最短步数
则 dp[i][j]=max(dp[i-1][j]+grid[i][j],dp[i][j-1]+gird[i][j]</p>
  </li>
  <li>
    <p>代码：
C++ 版：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">class</span> <span class="n">Solution</span> <span class="p">{</span>
<span class="n">public</span><span class="o">:</span>
    <span class="kt">int</span> <span class="n">minPathSum</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;&amp;</span> <span class="n">grid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">grid</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">m</span><span class="o">=</span><span class="n">grid</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">n</span><span class="o">=</span><span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">dp</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">;</span>
        <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">m</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">m</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                <span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">min</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
        <span class="k">return</span> <span class="n">dp</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure>


        </div>
        
          <p class="post-continue">
            <a href="/2015/03/11/Dynamic-Programming-Explanation/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2015/01/07/Person-Blog-Build-And-Modify/">如何利用 Jekyll 来搭建个人博客</a>
          </h1>

          <p class="post-meta">Jan 7, 2015 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>利用 Jekyll 来搭建个人博客</p>

<!-- more -->

<h3 id="博客现状">博客现状</h3>

<p>博客最早是由 <code class="highlighter-rouge">Jekyll</code> 搭建的，中间更换过两个主题—&gt;之后换成 <code class="highlighter-rouge">Octopress</code>，但对中文字体的渲染支持不是特别良好-&gt;再之后更换为 <code class="highlighter-rouge">hexo</code>，主题也变成 <code class="highlighter-rouge">Next</code>—&gt;最后又回到 <code class="highlighter-rouge">Jekyll</code>，更换成了 <code class="highlighter-rouge">WhiteGlass</code> 主题。这种粗墨渲染式的风格非常有感觉，应该不会再更换主题风格了：- D</p>

<h3 id="搭建过程">搭建过程</h3>
<p>这里以<a href="https://pages.github.com/">官方教程</a> 为例进行说明。</p>

<ol>
  <li>
    <p>首先需要有一个github的账号并创建一个名为 username.github.io 的 repository 。其中 username 就是你注册github使用的名称，进行替换即可。</p>
  </li>
  <li>
    <p>其次将该仓库 clone 至本地。github-pages 将每一个页面的初始配置文件都默认命名为为 index.html。所以创建一个名为index.html的文件。里面的文件随意填写，内容就是你首页的内容。并同步到终端。</p>
  </li>
  <li>
    <p>这时就能在网页：<strong>username.github.io</strong> 上看到你所想看到的页面了。</p>
  </li>
</ol>

<hr />

<p>但一个静态页面肯定无法满足我们的需求。还好，我们有Jekyll来搭建更为丰富、更加可定制化的网站。请参见
<a href="https://help.github.com/articles/using-jekyll-with-pages/">blogging with jekyll</a></p>

<ul>
  <li>
    <p>因为之后自己又安装了Windows平台下的jekyll，根据 <a href="http://jekyll-windows.juthilo.com/5-running-jekyll/">jekyll-windows</a>来一步步实现就可以(简而言之就是 jekyll 官方文档推荐了一个非官方的 windows 实现……)</p>
  </li>
  <li>
    <p>根据自己踩坑的过程，新的 jekyll 和 ruby gem 刚好差了一层依赖关系。换句话说想要部署新版的 github-pages，就必须用 ruby 2.x 版本，即不能用 <code class="highlighter-rouge">sudo apt-get install ruby</code> 的方式来安装，而是推荐从官方下载源代码后用 <code class="highlighter-rouge">./configure &amp;&amp; make &amp;&amp; sudo make install</code> 三部曲来编译。</p>
  </li>
  <li>
    <p>首先需要安装Ruby.OSx下已默认安装好</p>
  </li>
  <li>
    <p>安装bundler来进行包管理。<code class="highlighter-rouge">gem install bundler</code></p>
  </li>
  <li>
    <p>接下来根据github官方教程是安装gem，使用</p>

    <p><code class="highlighter-rouge">source 'https://rubygems.org'</code></p>

    <p><code class="highlighter-rouge">gem 'github-pages'</code></p>

    <p>来安装。但大部分情况下只会发生连接超时或者下载不下来的情况。所以请先</p>

    <p><code class="highlighter-rouge">gem sources --remove https://rubygems.org/</code></p>

    <p>移除默认的选项。</p>
  </li>
  <li>
    <p>这时候输入<code class="highlighter-rouge">jekyll server</code> 会显示网页地址</p>
    <blockquote>
      <p>http://127.0.0.1:4000</p>
    </blockquote>

    <p>在浏览器中打开，就能看到在本地生成的默认网页。</p>
  </li>
</ul>

<hr />

<p>下面是关于网页的配置情况。这里我希望能够将整个jekyll的网页结构讲清楚，方便大家进行fork和修改</p>

<p>首先是查看<a href="http://jekyllrb.com/docs/home/">jekyll文档</a></p>

<p>jekyll的结构图如下：</p>

<p><img src="http://7xk19m.com1.z0.glb.clouddn.com/屏幕快照 2015-06-30 下午8.51.56.png" alt="结构图" /></p>

<p>这里先不要急着往下看，一个一个来讲解它的作用。</p>

<ul>
  <li>
    <p>首先是<strong>_config.yml</strong>，它定义了你的博客整体所需要的构件。包括：博客名称、是否采用markdown语法、是否需要评论。它的注释将它的每一项作用表达的很清楚。</p>
  </li>
  <li>
    <p><strong>_includes</strong>,多数情况下我们不需要处理它。</p>
  </li>
  <li>
    <p>其次是<strong>layouts</strong>，它定义了你文章的表现形式。<strong>default.html</strong>是定义了首页的内容，你看，如果你想要在首页栏上添加一个新的标题，只需插入如下语句：</p>

    <p><code class="highlighter-rouge"> &lt;li&gt;&lt;a href="/Y_o_m/"&gt;Y_o_m&lt;/a&gt;&lt;/li&gt;</code></p>

    <p>以后在每一个打开的页面上都可以看见你的最上方黑色一栏里多出了<strong>Y_o_m</strong>。</p>

    <p>而还有两个分别是<strong>post.html</strong>,<strong>page.html</strong>。OK，打开后会看到它们都是以<strong>default.html</strong>作为模板。在我的博客里这两个.html的区别就是<strong>page.html</strong>多了一个评论功能。</p>

    <p>比如说我的Y_o_m主题的index.html文件我只希望它显示文件列表，所以就用post.html;而我想要2015-06文章里提供评论功能，就用page.html；</p>

    <p>可以在每篇文站里的<strong>layout</strong>里配置</p>
  </li>
  <li>
    <p><strong>_posts</strong>.它的作用就是存放你每次写的文章.注意名称必须为<strong>YEAR-MONTH-DAY-title.md</strong>.
并且在文件里必须用<code class="highlighter-rouge">---</code>+<code class="highlighter-rouge">---</code>来确定date、title、layout。并且为方便分类，categories也是常备的。</p>
  </li>
  <li>
    <p><strong>_sites</strong>,很多时候你会发现它是最复杂的。因为你所有最后用到的.html、.png都出现在里面。不过~，我们不用管它。就交给jekyll来做吧。</p>
  </li>
</ul>

<p>好了，相信有了上面的一些东西，就可以做出最基本的一个博客了。</p>

<hr />

<p>最后再补充说明一些东西：</p>

<p><a href="http://jekyllrb.com/docs/variables/">variables</a>是我们要做出优美的jekyll博客必不可少的元素。具体内容可以看w3cschool的教程。</p>

<p>说一些值得注意的因素吧：</p>

<ul>
  <li>
    <p>在设置paginator的时候要注意设置路径,</p>

    <p><code class="highlighter-rouge">paginate_path: "blog/page:num"</code></p>
  </li>
  <li>
    <p>呃，不知道应该怎么说，jekyll发展到现在竟然还不支持在categories下生成页码。</p>

    <p>所以就只好展开所有的categories:</p>

    <p><code class="highlighter-rouge"> for post in site.categories.book </code></p>

    <p>当然，这取决于你准备怎样设置你的博客类型。我喜欢横向一目了然，但纵向的抽屉型也很漂亮。</p>

    <p>祝开心。</p>
  </li>
</ul>

<hr />

<p>关于一些配置修改</p>

<p>这篇文章主要的目的是记录自己在修改jekyll博客主题过程的整体思路。如果大家有需要类似的 theme 的话，也可以以此来作为参考。</p>

<hr />

<ul>
  <li>
    <p><strong>博客思路</strong>：</p>

    <p>在default模板里顶部采用 <strong>留白+图片+导航栏</strong> 的模式，具体板式采用最常见的两列式：左列作为文章内容，右列分配Archives/Categories/Tags。其中在主页只推送和技术有关的文章，用 <code class="highlighter-rouge">for post in site.tags.tech</code> 来实现，其他放在导航栏的其他栏目里分别展示</p>
  </li>
  <li>
    <p><strong>导航栏实现</strong>：</p>

    <p>导航栏默认采用 bootstrap 的 navbar-inverse 样式，每个导航栏目都有对应的同名文件夹，在文件夹里对应有index.html，显示打开后的网页。根据需要选择page/post模板，以及显示的文章列表是简略型/详细型。其中About里要显示的是纯粹的静态网页，所以选择的文件为index.md。</p>
  </li>
  <li>
    <p><strong>侧边栏实现</strong>：</p>

    <ul>
      <li>
        <p>Archives显示了在不同时间创建的文章，用 captue 提取出对应的日期后根据年份/月份来生成目录。</p>
      </li>
      <li>
        <p>Categories显示了在不同目录下创建的文章。用
  <code class="highlighter-rouge">for post in site.categories.CATEGORIES</code> 来生成文章列表，之后为每个链接创建不同的id，在idnex.html(主页面)里进行对应的链接。Categories是用列表实现的，jekyll对树形表支持的不是太好。同时考虑对某些 categories 增加对应的  <code class="highlighter-rouge">&lt;span class="badge"&gt;</code> 来显文章数量。但现在为止之只能手动进行添加。</p>
      </li>
      <li>
        <p>tags显示在不同标签下对应的文章。遍历所有标签从而生成index页面。如果一篇文章有多个标签的话，将它加入第一个标签所在的列表</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<ul>
  <li>
    <p><strong>如何修改：</strong></p>

    <ul>
      <li>
        <p>用F12在chrome中打开控制栏后，可以看到该页面所对应的所有板式。但直接修改在 _site 里的html文件是不可行的，jekyll会重新直接生成。可以在_layout和_include文件夹里进行修改。</p>
      </li>
      <li>
        <p>要修改对应的版式，可以修改 page 和 post 里的栅格版式。bootstrap所采取的这种样式非常便于修改:比如我们可以看到我们是在用:<code class="highlighter-rouge">&lt;div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 "&gt;</code>来定义page页面的主体内容，用 <code class="highlighter-rouge">&lt;div class=" col-lg-8 col-lg-offset-1 col-md-8 col-md-offset-1 col-sm-12 col-xs-12 post-container"&gt;</code>来定义右侧导航栏。只需要修改对应列的大小和偏移量，就可以修改版式。</p>
      </li>
      <li>
        <p>但导航栏我并没有采用 <code class="highlighter-rouge">collapse</code> 的响应式布局，因为直接用 col-sm 来配置在移动端的响应更好。</p>
      </li>
      <li>
        <p>但非常奇怪的一点是我所自定义的 css 没有覆盖 bootstrap.min.css,但到目前为止也没有找到问题所在。因为并不是专业的前端工程师，所以就直接用修改 bootstrap.min.css 这样非常 tricky 的方式来解决。</p>
      </li>
      <li>
        <p>要修改文章字体大小的话，如果不了解前端的编译及压缩，可以直接在 <code class="highlighter-rouge">css/bootstrap.min.css</code> 里修改 <code class="highlighter-rouge">font-size</code> 所对应的值，原值为 15px。</p>
      </li>
      <li>
        <p>字体选择我优先选用的是微软雅黑</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<ul>
  <li>
    <p><strong>其他配置：</strong></p>

    <ul>
      <li>
        <p>采用多说评论，在 Board 和每篇文章列表里进行加载。</p>
      </li>
      <li>
        <p>一部分文章图片存储在 img 里，另一部分存储在 <strong>七牛云存储</strong> 里，用外链加载。</p>
      </li>
    </ul>
  </li>
</ul>

<hr />


        </div>
        
          <p class="post-continue">
            <a href="/2015/01/07/Person-Blog-Build-And-Modify/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2014/11/21/some-techniques/">碎碎念...</a>
          </h1>

          <p class="post-meta">Nov 21, 2014 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>Actually I’m trying to express some light knowledge about coding and interesting experience in my daily life.And this post will be divided into 2 parts: the 1st part will be written in english,and the corresponding Chinese translation can be found in <a href="/Chinese_translation.html">chinese</a></p>

<p>一些碎碎念…
<img src="/images/HBase-source-code.png" alt="HBase-source-code.png" />
<!-- more --></p>

<ul>
  <li>之前代码是这样的：
    <div class="highlighter-rouge"><pre class="highlight"><code> private static byte[] decrypt(byte[] data, byte[] key) throws Exception {
      SecureRandom sr = new SecureRandom();
      DESKeySpec dks = new DESKeySpec(key);
      SecretKeyFactory keyFactory = SecretKeyFactory.getInstance("DES");
      SecretKey securekey = keyFactory.generateSecret(dks);
      Cipher cipher = Cipher.getInstance("DES");
      cipher.init(2, securekey, sr);
      return cipher.doFinal(data);
  }
</code></pre>
    </div>
  </li>
</ul>

<p>各种 debug，看 DES 解法对应的 mode，最后还是要感谢 https://www.tools4noobs.com/online_tools/decrypt/ ，其实两行就用 Python 写好了：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def decrypt_des(input_):
    """
    :param input_: 加密的密文
    :return: 经过 des 解密后的密文
    """
    des = DES.new("naidnefi", DES.MODE_ECB)
    return "".join(x for x in des.decrypt(b64decode(input_)) if 31 &lt; ord(x) &lt; 127)
</code></pre>
</div>
<p>最后解密出来一堆 ‘\x5’，可以看 http://donsnotes.com/tech/charsets/ascii.html 来得到具体的含义，解决方法参考：https://stackoverflow.com/questions/14256593/remove-special-characters-from-the-string</p>

<ul>
  <li>
    <p>今天帮我司算法团队调一个 Bug，调的心好累……本来用 Python2 处理中文就很闹心，还要用正则来调。调试了一大堆 unicode 字符以后终于能跑了……结果在测试服务器能跑，在对方的线上服务器就不能跑，擦……最后搜到了这个 ！<a href="https://stackoverflow.com/questions/1446347/how-to-find-out-if-python-is-compiled-with-ucs-2-or-ucs-4">链接</a>，一试，果然……测试的是用 ucs4 编译的，而线上的是用 ucs2 编译的。两个有什么区别……我不知道啊……现在到家都已经 12 点了，我要睡觉……明天再说</p>
  </li>
  <li>
    <p>自从 Google Reader 解散之后就没有怎么再用过 RSS 了，但最近发现还是很有用啊，类似 Push 和 Pull。这个 <a href="http://wokuang-blog.logdown.com/posts/208334-use-gmail-to-read-rss-data">链接</a> 里说直接用 IFTTT 连接 Feedly 和 Gmail 就可以，但连接时候发现 IFTTT 必须要付费升级到 Pro 版才行。所以参考 <a href="http://www.jianshu.com/p/26b5c66e8546">简书的这篇文章</a>，连接 RSS 和 Gmail。不过 IFTTT 改版后界面需要在右上角的个人主页那里点击 <code class="highlighter-rouge">New Applet</code>。有些 rss 的地址不一定好找，那就用 feedly 订阅后再导出 opml 文件，找到里面的 xmlUrl 属性对应内容。最后的截图如下：</p>
  </li>
</ul>

<p><img src="/images/rss.png" alt="rss.png" /></p>

<ul>
  <li>
    <p>帮搜了一个 foursquare 的数据集。开始的链接地址是在 http://www.public.asu.edu/~hgao16/dataset.html，但链接失效了，用 Google 搜的话在犄角旮旯里找到个 reddit 的帖子 https://www.reddit.com/r/datasets/comments/1nywu2/foursquare_data_set/，里面到在 https://archive.org/download/201309_foursquare_dataset_umn 提供了下载zip 格式的文件，150M+。</p>
  </li>
  <li>
    <p>Java 上 StringUtils 里最常见的一个就是把首字母变成小写，一般来实现的话就是</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">firstCharToLower</span><span class="o">(</span><span class="n">String</span> <span class="n">input</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">nulll</span><span class="o">)</span>
    
<span class="o">}</span></code></pre></figure>

<p>但 SO 上还有这么一个回答，提供了另一种思路：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">char</span> <span class="n">c</span><span class="o">[]</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span>
<span class="n">c</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">Character</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">c</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
<span class="n">string</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">c</span><span class="o">);</span></code></pre></figure>

<p>其实是以牺牲可读性来换取了性能的增加</p>

<ul>
  <li>
    <p>Curator 是 Linkedin 开源的一款对 zookeeper 封装的工具，里面提供了各种方便实现的功能，包括更新配置文件，选取 leader 节点等。今天在 Spark 上看见了这个实现，具体对应代码在：<code class="highlighter-rouge">spark/core/src/main/scala/org/apache/spark/deploy/master/ZooKeeperPersistenceEngine.scala</code></p>
  </li>
  <li>
    <p>最近又有需求，在 Ubuntu 环境下用 VirtualBox 重新安装了 Win8.1。具体</p>
  </li>
  <li>
    <p>今天试着用了一下 GitLab CI，从个人体验来说和 Github 的 travis-CI 没有什么太大区别啦，按照 stages 和 build/deploy 来区分，但最后问题发生在下面：
<img src="/images/build-failure.png" alt="build-failure.png" /></p>
  </li>
</ul>

<p>根据它的说法，你需要在安装 GitLab 的服务器上安装 Runner,参见 <a href="https://docs.gitlab.com/runner/install/linux-repository.html">这个</a>。但之前安装 GitLab 的人都不在了，既没有运维的权限，同时也没有像创业公司那样必须用 CI 的迫切性(不存在一天上线七八次这种情况啊……)。所以真的是……</p>

<p>最后把写的 .gitlab-ci.yml 脚本立此存照一下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>before_script:
    - sudo yum install maven2

stages:
    - build

build_job:
    stage: build
    script:
      - mvn install
      - mvn '-Dtest=com.xxx.example.*Test' test
</code></pre>
</div>

<p>其中 <code class="highlighter-rouge">mvn '-Dtest=com.xxx.example.*Test' test</code> 用来运行所有匹配的测试用例</p>

<ul>
  <li>
    <p>今天在讨论的时候知道阿里和百度都开始用 DL 来做 CRT 预估了，记得一段时间以前都在说深度学习都还是黑匣子，可解释性遭到 challenge 的话是不能在生产环境上用的，但转眼间都开始用了</p>
  </li>
  <li>
    <p>大部分讨论操作系统的问题最后都变成了要不要用 SSD 的问题……哇咔咔</p>
  </li>
  <li>
    <p>因为最近要从事的是现场办公，某司要访问开发环境的话，不能用 openvpn 或类似的工具，而是用启明星辰所提供的<a href="http://www.venustech.com.cn/SafeProductInfo/11/25.Html">天玥安全审计</a>。哼哧哼哧配好了 ip 和 dns 后(其中还踩了 Ubuntu Desktop 版不能直接用编辑配置文件方式修改 ip 的坑)，登陆到 Web 端来访问。但发现登陆工具怎么都选择不了，看了 css 以后发现选择器没问题啊……花了一天的时间各种配，最后申了一份当时发给运维的文档看，FAQ 里第一个就是：</p>
  </li>
</ul>

<blockquote>
  <p>问题1：如果我的操作系统是Linux或者是Mac的怎么办？
Linux和Mac系统的用户可以使用web界面操作，web地址为 ××××××，操作方法和windows客户端版是一样的，web存在兼容性问题，建议使用客户端版。</p>
</blockquote>

<p>我……</p>

<ul>
  <li>
    <p>发现 IDEA 配置好以后不能用设 Socks5 的方式来翻墙下载 SBT 的依赖，但 manual configuration 应该是没问题的啊。最后在 SBT 的参数里加上 ` -Dhttps.proxyHost=127.0.0.1  -Dhttps.proxyPort=8080`，:-(，但为什么不能用 IDEA 自带的配置呢？…….</p>
  </li>
  <li>
    <p>在调试 Spark 源码里面的 Spark Streaming 程序的时候，需要把对应的 <strong>VM Options</strong> 改为 <code class="highlighter-rouge">-Dspark.master=local[2]</code>，否则
就一直报 <strong>netword connection refused</strong> 的错误……</p>
  </li>
  <li>
    <p>分布式系统里一个最重要的特性就是 <strong>CAP</strong> 不能同时满足。Google 搜出来的第一个链接就是 <a href="https://www.quora.com/Can-someone-provide-an-intuitive-proof-explanation-of-CAP-theorem">Quora 的回答</a>，里面提到了一篇非常好的 <a href="https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed">InfoQ 文章</a>，我来试着理解一下。<strong>C</strong> 指的是 Consistency(一致性)，<strong>A</strong> 指的是 Availability(可用性)，<strong>P</strong> 指的是 Partition Tolerance(分区容忍性)。通常情况下我们必须要保证多节点运行，所以 <strong>P</strong> 是肯定要满足的。而对 <strong>C</strong> 和 <strong>A</strong>，就只能取舍一个，举例：</p>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>一个集群有两台机器，A 和 B(这里为了举例进行了简化，在生产环境中要求通常为大于 1 的奇数)。
每当 A/B 有数据写入，都会同时在 B/A 上同步过去。
但突然网络连接出现了故障，A 和 B 之间无法进行通信。这时候对 A 而言，有两种选择：

1. 为了保持一致性，就不应当再接受对外的请求来确保数据不发生变化，这时候可用性就无法得到满足。

2. 为了保持可用性，继续接受请求，那么两台机器上的数据就会不一致，这时候一致性就无法得到满足。

这时候大多数的选择都是保持对外的可用性，两台机器继续对外提供服务，当可以继续进行通信时再同步数据，
从而保持最终一致性(eventual consistency)。

</code></pre>
</div>

<p><img src="/images/CAP.jpg" alt="CAP.jpg" /></p>

<p>在衡量系统的 Availability 的时候有几个概念，一个就是 <strong>X 个9</strong>。说明如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>3个9：(1-99.9%)*365*24=8.76小时：
表示该软件系统在连续运行1年时间里最多可能的业务中断时间是8.76小时。
4个9：(1-99.99%)*365*24=0.876小时=52.6分钟：
表示该软件系统在连续运行1年时间里最多可能的业务中断时间是52.6分钟。
5个9：(1-99.999%)*365*24*60=5.26分钟：
表示该软件系统在连续运行1年时间里最多可能的业务中断时间是5.26分钟。

</code></pre>
</div>

<ul>
  <li>最近在写一个 MR 的程序，解析出一堆变量要产生一个字符串。虽然知道 <code class="highlighter-rouge">Guava</code> 库里有 <code class="highlighter-rouge">join</code> 方法，并且用 <code class="highlighter-rouge">hasNext()</code> 来避免结尾加上分隔符的实现高到不知道哪里去了，但就为了这么一个函数引入一个 jar 包是不是不太好啊⊙﹏⊙b。试着自己写一个，实现的稍微 tricky：</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">join</span><span class="o">(</span><span class="n">Character</span> <span class="n">separator</span><span class="o">,</span> <span class="n">String</span><span class="o">...</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">input</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">input</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"the input is illegal,check wheteris it's null or empty"</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">_separator</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">separator</span><span class="o">);</span>
        <span class="n">StringBuilder</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">elem</span> <span class="o">:</span> <span class="n">input</span><span class="o">)</span>
            <span class="n">res</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">elem</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">_separator</span><span class="o">);</span>
        <span class="n">res</span><span class="o">.</span><span class="na">deleteCharAt</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span></code></pre></figure>

<ul>
  <li>
    <p>日常日常超量的话要进行处理，如果是我的话估计就写个脚本了，但今天才被教做人…Linux 下的 <strong>/etc/logrotate.conf</strong> 直接进行编辑就好了，压缩，移除，时间设置，各种功能都有……</p>
  </li>
  <li>
    <p>最近在看 JStorm 的源码,其中有一段代码是这样的……kill the process 5 times……make sure the process be killed definitely……作者是个有故事的人……</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">ensure_process_killed</span><span class="o">(</span><span class="n">Integer</span> <span class="n">pid</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// in this function, just kill the process 5 times
</span>
        <span class="c1">// make sure the process be killed definitely
</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">exec_command</span><span class="o">(</span><span class="s">"kill -9 "</span> <span class="o">+</span> <span class="n">pid</span><span class="o">);</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"kill -9 process "</span> <span class="o">+</span> <span class="n">pid</span><span class="o">);</span>
                <span class="n">sleepMs</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecuteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Error when trying to kill "</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s">". Process has been killed"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Error when trying to kill "</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s">".Exception "</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">concurrency(并发)</code> 和 <code class="highlighter-rouge">parallelism(并行)</code> 两个概念常常混淆。今天又遇到了这个问题，结果发现为知里 2014 年就有这个记录了……好尴……那么用一句话来总结，就是说并发是针对程序的设计来讲的(concurrency as a property of a program or system)，一个设计良好的并发程序使得程序可以做到在重叠的时间段内执行不同任务。而并行指的是在实际运行中在物理上有多个任务在运行(parallelism as the run-time behaviour of executing multiple tasks at the same time)。所以如果一个并发的程序在一个单 cpu 的机器上运行，那么它仍然是并发的，但却不是并行。</li>
</ul>

<p>这个问题解释最好的中文文章在 <a href="https://laike9m.com/blog/huan-zai-yi-huo-bing-fa-he-bing-xing,61/">这里</a>，英文资料就是 Go 语言的那篇 <a href="https://talks.golang.org/2012/concurrency.slide">slide</a> 了</p>

<ul>
  <li>
    <p>除了 MongoDB 外 ES 也有被人黑啊……为了开发方便就不取消 <code class="highlighter-rouge">curl delete</code> 了，但必须只有内网能访问……到底是怎么做到每笔交易都是可回溯验证但无法关联到具体账户的……根据这个 <a href="https://blockchain.info/address/13zaxGVjj9MNc2jyvDRhLyYpkCh323MsMq">blockchain 地址</a> 看一下，收了 32 笔 0.2 BTC，总共 6.4 BTC，根据 2017.01.18-11:36 上午的汇率，等价 5696.64 $，也等价 39202.73 ¥……</p>
  </li>
  <li>
    <p>有一个 600M+ 的 CSV 文件，因为要实验转化读取，所以就用 split 来按大小分割一下。但之后怎么处理都是乱码，以为是源文件的问题，但 <code class="highlighter-rouge">head -10</code> 读出来也没问题啊。也怀疑是自己没有加后缀，但文本文件又不是二进制啊……最后才意识到不应该按大小来分割的……按大小来分割是为了方便后续合并啊……要用 <code class="highlighter-rouge">split -l</code> 按行来分……</p>
  </li>
</ul>

<p><img src="/images/青蛙.jpg" alt="无话可说" /></p>

<ul>
  <li>
    <p>所以到底发生了什么……为什么要用图片处理……今天遇到不少事情……比如说要用 <code class="highlighter-rouge">pillow</code> 来把一个字体显示到图像上。需要用到 ImageFont 的 TrueType ，下载 <code class="highlighter-rouge">simsun.ttc</code>，包含宋体和新宋体，但使用的时候会报 <code class="highlighter-rouge">OSError</code>的错误，无法识别 fileformat ，需要换成 Linux 下对应的字体。但如果用 <code class="highlighter-rouge">/usr/share/fonts/</code> 目录下的随便一个，又不会正常显示，只会出现 “?”。需要选择一个对中文支持友好的字体，可以在命令行里用 <code class="highlighter-rouge">fc-list :lang=zh-cn</code> 来找。用 <code class="highlighter-rouge">numpy.asarray() 和 numpy.fromarray()</code> 来做到在图像和矩阵之间相互转化，中间添加随机数干扰会让字体扭曲变形，但这个更适配于对手写体的识别。如果是对拍照的印刷体，合适的场景是用 rotate() 来旋转一定角度。但这样会出现一些黑色空间，用 crop()再截取一下就好了：-D</p>
  </li>
  <li>
    <p>虽然一直在用 requests，但今天才意识到可以这样: <a href="http://sh3ll.me/2014/06/18/python-requests-encoding/">requests-code-read-content-auto-encode</a>。关于 <code class="highlighter-rouge">chardet</code> 识别编码的原理之前在看《Fluent Python》的时候也提到过，根据字符前缀出现的频率来判定。</p>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>In [7]: chardet.detect('再也不被编码问题困扰了2333ShakaLaka!!!'.encode('GBK'))
Out[7]: {'confidence': 0.99, 'encoding': 'GB2312'}
</code></pre>
</div>
<ul>
  <li>
    <p>supervisor 项目配置下有一个 user 选项，可以选择以什么用户来启动命令。但是必须用 root 账号来启动 supervisor</p>
  </li>
  <li>
    <p>今天遇到了一个挺崩溃的问题。简单来说就是这样：数据校验的脚本有这样一句sql 查询:<code class="highlighter-rouge">count_sql = "select count(*) from...</code> 但 <code class="highlighter-rouge">print count_sql</code> 的时候总是会把第一个 ‘s’ 字符和最后的一个单引号 <code class="highlighter-rouge">'</code> 丢掉。查来查去最后甚至怀疑到了 <code class="highlighter-rouge">XShell</code> 的显示问题，但在我电脑上显示也不对，那就还是代码的问题。最后不用 print 来 debug 了，决定把 count_sql 写入到文件里来看(一直在用 Linux，读写模式里没有加 ‘b’…)，然后发现显示的语句后面多了一个 <code class="highlighter-rouge">^M</code>。问题就出在这里，以前创建这个文件的时候用的是 txt 文本编辑器而不是 notepad++，换行符用的是 ‘\r\n’，而 Linux 下用的是 ‘\n’。换句话来说就是 <code class="highlighter-rouge">Unix uses 0xA for a newline character. Windows uses a combination of two characters: 0xD 0xA. 0xD is the carriage return character. ^M happens to be the way vim displays 0xD.</code>(参考 <a href="http://stackoverflow.com/questions/5843495/what-does-m-character-mean-in-vim">这个</a>)。在 Py2 的范畴内解决办法就是读取后再用 strip() 处理一次。当然换到 Py3 就没有这个问题了(虽然离 2020 还有 3 年，但还是赶紧换啊啊啊)。这种问题还是第一次遇见，记录一下：-D</p>
  </li>
  <li>
    <p>装 Kafka 的 UI，最后选型用的是 Yahoo 的 Kafka Manager。但它要用的是 JDK8 …能检测单位时间内的信息量。最后界面还好啦，就是浓厚的 Bootstrap 风格让人不忍直视：</p>
  </li>
</ul>

<p><img src="/images/KafkaUI.png" alt="KafkaUI" /></p>

<p>同时补充一下 Centos 下安装 JDK8 的使用方法:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>① 在现有的环境下 java -version 显示 1.7.0,目录在 /usr/lib 下。参考 Ubuntu 上的安装经验，我们不希望它发生冲突，所以在 /opt 目录下安装。
② cd /opt,之后使用 
wget --no-cookies --no-check-certificate --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie" "http://download.oracle.com/otn-pub/java/jdk/8u101-b13/jdk-8u101-linux-x64.tar.gz"
来安装,之后使用 tar -xzf jdk-8u101-linux-i586.tar.gz 来解压。
③ cd /opt/jdk1.8.0_101/ 来进入安装环境。java 提供了 alternatives 选项来允许在同一系统内存在多个 java 版本。执行 
alternatives --install /usr/bin/java java /opt/jdk1.8.0_101/bin/java 2 
来安装。执行 
alternatives --config java
来选择，只需要输入对应的编号即可（在 158 环境需要输入的是 3，对应的正是 /opt 对应的 JDK8）。执行 java -version 可以看到已经变为 1.8。
④ 接下来需要设置环境变量，直接执行下面三个命令：
export JAVA_HOME=/opt/jdk1.8.0_101
export JRE_HOME=/opt/jdk1.8.0_101/jre
export PATH=$PATH:/opt/jdk1.8.0_101/bin:/opt/jdk1.8.0_101/jre/bin

</code></pre>
</div>

<ul>
  <li>
    <p>准备去看 <code class="highlighter-rouge">《Web Analytics 2.0》 </code>了，虽然与技术关联不大，但没事的时候翻一番～～</p>
  </li>
  <li>
    <p>对于定时清空的日志文件，用命令 <code class="highlighter-rouge">&gt; ToDelete.log</code>…</p>
  </li>
  <li>
    <p>NLPchina 提供了一个 <a href="https://github.com/NLPchina/elasticsearch-sql">elasticsearch-sql</a> 的插件，能用类 sql 的方式来对 ES 进行查询。但用 <code class="highlighter-rouge">select</code> 查询的时候如果不指定 limit 的数量，默认始终是 200</p>
  </li>
  <li>
    <p>想起以前看过的一个挺有意思的 <a href="https://www.zhihu.com/question/38331955">问题</a>，刚好最近在学 Scala，试着写一个</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">var</span> <span class="n">boyfriendList</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">.</span><span class="n">fill</span><span class="o">(</span><span class="mi">12</span><span class="o">)(</span><span class="mi">0</span><span class="o">)</span>

<span class="k">def</span> <span class="n">calculate</span><span class="o">(</span><span class="n">total</span><span class="k">:</span><span class="kt">Int</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span><span class="n">freq</span><span class="k">:</span><span class="kt">Int</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span><span class="k">:</span><span class="kt">Int</span> <span class="o">=</span> <span class="n">total</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="mi">12</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"总次数为 $freq "</span><span class="o">)</span>
        <span class="n">freq</span>
    <span class="o">}</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="n">boyfriendList</span><span class="o">(</span><span class="n">nextInt</span><span class="o">(</span><span class="mi">12</span><span class="o">))</span> <span class="k">=</span> <span class="mi">1</span>
        <span class="n">calculate</span><span class="o">(</span><span class="n">boyfriendList</span><span class="o">.</span><span class="n">sum</span><span class="o">,</span><span class="n">freq</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Application</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>

    <span class="k">var</span> <span class="n">boyfriendList</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">.</span><span class="n">fill</span><span class="o">(</span><span class="mi">12</span><span class="o">)(</span><span class="mi">0</span><span class="o">)</span>
    <span class="k">var</span> <span class="n">index</span> <span class="k">=</span> <span class="mi">1</span>
    <span class="k">var</span> <span class="n">count</span> <span class="k">=</span> <span class="mi">0</span>
    <span class="k">while</span><span class="o">(</span><span class="n">index</span><span class="o">&lt;=</span><span class="mi">50</span><span class="o">){</span>
        <span class="n">boyfriendList</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">.</span><span class="n">fill</span><span class="o">(</span><span class="mi">12</span><span class="o">)(</span><span class="mi">0</span><span class="o">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">calculate</span><span class="o">()</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="o">}</span>
    <span class="n">println</span><span class="o">(</span><span class="n">sum</span><span class="o">.</span><span class="n">toFloat</span><span class="o">/</span><span class="mi">50</span><span class="o">)</span>  <span class="o">//</span> <span class="mf">34.64</span></code></pre></figure>

<p>啊，Pattern Matching 这里还比较好，但 var 和 val 变量这里自己做的太 tricky 了 ……</p>

<ul>
  <li>
    <p>今天群里在讨论爬虫被抓的一个问题，有人提到可以模拟搜索引擎，就搜了一下…还真有这种数据，看这个 <a href="https://support.google.com/webmasters/answer/1061943?hl=en">Google Crawler</a> ，把 <code class="highlighter-rouge">UA</code> 配置成 <code class="highlighter-rouge">Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)</code></p>
  </li>
  <li>
    <p>Python 2.6 里一个输出语句 <code class="highlighter-rouge">print '{}'.format(1)</code> 会报错，提示 <code class="highlighter-rouge">ValueError: zero length field name in format</code>，必须指明顺序，<code class="highlighter-rouge">print '{0}'.format(1)</code>。啊…连 2.7 和 2.6 都不能做到完全兼容，有毒…</p>
  </li>
  <li>
    <p>今天遇到一个挺有意思的问题。日志打码用的是 pageName&amp;{key1:value1,key2:value2} 的形式，通常情况下用 split(“&amp;”)[1] 得到 JSON 字符串后用 get_json_object 来查就可以了。但如果所提供的 value 里面有多个 “&amp;”(如含参的 url)，那么分隔开后就会产生只有一个 <code class="highlighter-rouge">"</code> 的字符串，读不出 JSON 格式。所以就写了一个 UDF 来解决(额，貌似 Hadoop.io.Text 效率比 Java 的 String 高……)</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
 * 主要处理 url 中包含 &amp; 从而不能用 split("&amp;") 来分割的情形
 * input:String
 * output:JSON-like Object
 */</span>

<span class="kn">import</span> <span class="nn">org.apache.hadoop.hive.ql.exec.UDF</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">dealJSONWithUrl</span> <span class="kd">extends</span> <span class="n">UDF</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">evaluate</span><span class="o">(</span><span class="n">String</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">input</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"&amp;"</span><span class="o">))</span>
            <span class="k">return</span> <span class="n">input</span><span class="o">;</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"&amp;"</span><span class="o">);</span>
        <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">temp</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">temp</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">]).</span><span class="na">append</span><span class="o">(</span><span class="s">"&amp;"</span><span class="o">);</span>
            <span class="k">else</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<ul>
  <li>
    <p>crontab 总会有一些非常 tricky 的问题…今天遇到的是运维老师写的一个<code class="highlighter-rouge">redis-cli</code> 清数据的时候在 shell 脚本里不能直接用 <code class="highlighter-rouge">redis-cli</code>，而是一定要用绝对路径（线上服务器的绝对路径是在 <code class="highlighter-rouge">/usr/local/lib</code>，测试服务器上是 <code class="highlighter-rouge">/usr/bin</code>，后者可以在 shell 里直接删…所以是这个原因吗？）。还想起之前一个 Python 程序总是不能正常运行，最后发现是因为自己用了 <code class="highlighter-rouge">os.chdir('..')</code>，要先 <code class="highlighter-rouge">cd</code> 到目录再跑。这个坑踩过的人还不少啊…<a href="https://www.digitalocean.com/community/questions/unable-to-execute-a-python-script-via-crontab-but-can-execute-it-manually-what-gives">这个</a>…supervisor 里能指定 <code class="highlighter-rouge">Directory</code> 实在太幸福了…</p>
  </li>
  <li>
    <p>有一段时间搜狗输入法会莫名其妙崩溃，突然就无法输入中文了。没有办法，写了个 <code class="highlighter-rouge">alias sogou='pkill sogou-qimpanel &amp;&amp; fcitx &amp;&amp; sogou-qimpanel&amp;'</code> 的命令，一有崩溃就重启。</p>
  </li>
  <li>
    <p>上面说的这个故障应该是搜狗输入法云端输入后台的故障，因为大概在某一个时间段内同时在 PC 和自己的笔记本上遇到这个 Bug，在此之前和在此之后都没有能复现这个问题…</p>
  </li>
  <li>
    <p>row_number() over 查询分组，用 row_id 来选择指定</p>
  </li>
  <li>
    <p>之前用 <code class="highlighter-rouge">ssh-copy-id</code> 配置免密码登陆后一般都是在 bash 里面设置一个 alias，比如 <code class="highlighter-rouge">ssh-75='ssh root@10.10.8.75'</code> 这种，今天又学习了一点新的人生经验，可以在 ~/.ssh 里直接配一个 config 文件。看看 <a href="https://www.cyberciti.biz/faq/create-ssh-config-file-on-linux-unix/">create-ssh-config-file-on-linux-unit</a></p>
  </li>
  <li>
    <p>ubuntu 上最喜欢的命令行工具是 <code class="highlighter-rouge">guake</code>，<code class="highlighter-rouge">F12</code> 一键呼出，再配合上 <code class="highlighter-rouge">tmux</code> 分屏…可惜的是我不是纯 vim 党啊…有时候 guake 会突然变空白，这个时候杀掉进程就好了，但之前运行的一些程序会还运行。当然像 <code class="highlighter-rouge">shadowsocks</code> 这些程序会提醒你端口被占用，但 <code class="highlighter-rouge">openvpn</code> 是不会告诉你已经有一个实例运行了啊…再开一个就会造成你在服务器上动不动就被踢下去…</p>
  </li>
  <li>
    <p>今天用到了 pip 的一个功能… 把所有项目的依赖下下来并且不安装: <code class="highlighter-rouge">pip install --download /path module_name</code>，scp 上传后用
<code class="highlighter-rouge">pip insall --no-index -f /path module_name</code> 来安装</p>
  </li>
  <li>
    <p>又是 Hive 时间的问题…..在 unix_timestamp 转化时，如果时间格式如 <code class="highlighter-rouge">2016-06-27 11:00</code> 因为没有秒数，所以实际上是无法进行转化的。它查询时也不会报错，但也永远不会有合乎要求的结果。最后用 concat() 连接上不会影响时间的 <code class="highlighter-rouge">':','00'</code>再查。</p>
  </li>
  <li>
    <p>需要用 JStorm 调用一个运维接口来发短信。但只有 Nimbus 服务器可以发短信，Supervisor 服务器没有对应的权限（host 地址设置问题）。这种分布式的问题总是由奇奇怪怪的原因产生…</p>
  </li>
  <li>
    <p>Java 的 jedis 只能在 getResource() 取得实例后再用 select 来选择分库，但 Python 的 redis client 是可以在构造函数里就指定的。</p>
  </li>
  <li>
    <p>有时间要学学 docker 啊，真的要能统一开发环境和生产环境，那就很厉害了…</p>
  </li>
  <li>
    <p>踩了 Hive SQL 的一个坑，不同表的时间格式不一样，转的时候要这么用：from_unixtime(unix_timestamp(‘20160521’,’yyyyMMdd’),’yyyy-MM-dd’)</p>
  </li>
  <li>
    <p>Gunicorn 部署。一个空格引发的惨案，噗</p>
  </li>
  <li>
    <p>Anaconda 突然发现 .condarc 好像不起作用了，不从清华的源安装。看了看 <code class="highlighter-rouge">conda install -h</code>，用 <code class="highlighter-rouge">--channel https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</code> 来指定以后就可以了。还有问题是提示没有权限，，，看了一下，文件上显示锁，chown + chmod ~~</p>
  </li>
  <li>
    <p>几百行的 SQL 到底是怎么维护</p>
  </li>
</ul>

<hr />

<ul>
  <li>
    <p>等待毕设结果，有些焦虑……写了个模拟登陆教务处的脚本，下载完验证码后输入到命令行中……没有能明确显示登陆结果的标志，最后发现可以用返回 header 的 Content-Type 来判断，如果后缀是 <code class="highlighter-rouge">gb2312</code> 就登陆成功，而后缀是 <code class="highlighter-rouge">GBK</code> 就登录失败(好奇葩是不是……当时是谁写的这个网站⊙﹏⊙b)。本来想再分析一下课表的，但发现 post 请求的结果是一个 js 函数……竟然有这种 Web 开发方式……虽然也能解析但……还是算了……并且它的登陆逻辑是有问题的啊，填完一次验证码后就能多次尝试登陆，按照大多数人的习惯，如果还是六位数密码，那么最多跑 10**6 次就肯定能破出密码来~~~
<img src="/images/lesson-course-list.jpg" alt="lesson-course-list" />
<img src="/images/brute-force.jpg" alt="brute-force" /></p>
  </li>
  <li>
    <p>花在写论文上的时间比在代码上的时间还多：-D</p>
  </li>
  <li>
    <p>中期答辩前终于把简化版的结果做出来了…但中文字符前都会有一个 u’’ Unicode 标识符，影响美观</p>
  </li>
  <li>
    <p>为何要作死…用 <code class="highlighter-rouge">sudo shutdown now</code> 来关机,然后黑屏状态-&gt;强制关机-&gt;重启后发现怎么输入密码都不对.重装系统…</p>
  </li>
  <li>
    <p>用 ubuntu 用多了会在某些时候觉得真的不方便啊,大概是 auto-remove 和 purge 之间的混乱关系,或者是自己编译 OpenSSL 和安装后的 OpenSSL 产生冲突…<code class="highlighter-rouge">Arch wiki</code>能和 <code class="highlighter-rouge">ask ubuntu</code> 提供一样的帮助,随时升级内核比不敢 <code class="highlighter-rouge">upgrade</code> 高到不知道哪里去了…但路径依赖…再在这上面折腾就太耗时间了…</p>
  </li>
  <li>
    <p>被 STL 的 Vector 坑大了==&gt;!!!!</p>
  </li>
  <li>
    <p>Sublime 的列操作，<code class="highlighter-rouge">ctrl + shift + L</code></p>
  </li>
  <li>
    <p>Windows 下的命令行终端还是推荐 cmder，能使用 <code class="highlighter-rouge">cd/ls</code> 等常用命令，切换磁盘(以D盘为例)请直接用 <code class="highlighter-rouge">D:</code>，要使中文字符不产生缩进可以选择右侧的设置(ctrl+alt+p),勾选 monospace 为不使用状态，并且自带对 git 的支持。再也不用 <code class="highlighter-rouge">git bash</code> 了…</p>
  </li>
  <li>
    <p>在 VMWare 上安装 Ubuntu 镜像遇到了桌面无法显示边栏和顶栏问题，最后用的是 ccsm 来解决(<code class="highlighter-rouge">sudo apt-get install ccsm</code>，执行软件，并选中 Unity，执行，关机重启)</p>
  </li>
</ul>

<!-- 数万人的流离失所比不上一张孩童溺水的照片所引起的影响力大。心理学的理论再一次得到了令人心悸的验证。 -->

<!-- @tombkeeper 曾经在微博上发过这样一条状态： 很多人都想师从名家，但优秀的老师往往也很难容忍甘于平庸和疏于自律的学生。如果你没做好努力上几年的准备，也许一开始就不该选这样的老师  时时转发自省 -->

<!--
说好的出国已经成为泡影，整个的职业生涯规划都要因此改变。

《The House Of Cards》第一季第一季里Frank说"Never again will I allow me to be put into such a position"；

《TGW》里Alicia在独立办律所后向Cary大吼“You know what? go to hell"；

好多事情，只有亲身经历才能知道。高中时所犯的错误，以后绝不会再犯。

无限的沉迷于手机信息流的feed,no struggle for what you want，too care about others,and gain nearly nothing now,the body engineering.

The Promised Land.
-->

<!--Thanks for your advice  
All options are open to me
I will decide during the next 48 hours
-->

<!-- 本来在原著中是非常小的一段描写”石墩出动“，在电影中是非常壮观的一个场景。”Hogwarts is threatened.man the boundary,do the duty to our school"-->

<!--
每个人心里都有一个方向，由DNA所引发，一直到20岁都会持续变化，就是你所经历的事、遇到的人、走路的路，就是摩西所说的“promised land"。它的翻译“必见辽阔之地”一直被我认为是最好的翻译之一。在你经历过一天之后，你会清醒的知道它是否有助于你实现你的目标，即便你的潜意识里在否认。
-->

<!--
    * 2015.07.04 星期六

很少想到有一天压力竟然能这么大……

跑了5圈就已经受不了了。
-->

<ul>
  <li>之前在用 Intellij IDEA 和 Pycharm 时候一直用的是 Sublime Text2 的配色，来自<a href="http://www.ideacolorthemes.org/home/">Intellij theme</a>虽然配色很好，但还是和 ST 有差距。今天修改了一下 Line Comment 的颜色，改成 RGB(138,130,107)，评论颜色为淡灰色，更容易和正文区分开，给原作者发了封邮件，邮件秒回，发邮件这个真的是美帝人民的天赋技能…自己当时是怎么写出 is not very good 这种小学英语的…我的天…</li>
</ul>

<p><img src="/images/contact.JPG" alt="Email And Send" /></p>

<ul>
  <li>jkeyll竟然不支持Pagination下的categories/tags 集合，试了半天啊…</li>
</ul>

<blockquote>
  <p>Pagination does not support tags or categories.Pagination pages through every post in the posts variable regardless of variables defined in the YAML Front Matter of each. It does not currently allow paging over groups of posts linked by a common tag or category. It cannot include any collection of documents because it is restricted to posts.</p>
</blockquote>

<ul>
  <li>
    <p>计算机系统结构试验要求是用WInDLX平台来模拟，现在才知道不同平台汇编语言标准不统一…其他语言都是标准一样实现不一样的</p>
  </li>
  <li>
    <p>计算机网络实验，用微软的 network monitor 来监控，用 display fliter 来过滤，但是为什么不用 fiddler 呀</p>
  </li>
  <li>
    <p>手写 Parser 和 Token …</p>
  </li>
  <li>
    <p>写《通信原理》的结课论文，发现一本扫描版的书也给搜出来了，Google…OCR…ORZ…</p>
  </li>
</ul>

<hr />


        </div>
        
          <p class="post-continue">
            <a href="/2014/11/21/some-techniques/">Read on &rarr;</a>
          </p>
        
      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2014/06/22/Python-Multiprocessing-Multithreading/">Python one-line 实现多进程和多线程(修正版)</a>
          </h1>

          <p class="post-meta">Jun 22, 2014 • 
  
  

</p>
        </header>

        <div class="post-content">
          <p>用 <code class="highlighter-rouge">multiprocessing</code> 和 <code class="highlighter-rouge">multiprocessing.dummy</code> 来实现多进程/实现多进程和多线程，增加了 ThreadPoolExecutor 以及其他内容</p>

<!-- more -->

<h4 id="直接使用-one-line">直接使用 one-line</h4>

<p>关于 multiprocessing 和 Thread 之间的 pros 和 cons 就不多做描述了，因为关键是我们要让我们的代码来并行对吧:-D</p>

<p>关于使用就直接看这篇文章 <a href="http://chriskiehl.com/article/parallelism-in-one-line/">parallelism-in-one-line</a> 好啦</p>

<p>来提供一个所写的例子：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># -*- coding:utf-8 -*-
</span>

<span class="s">"""
对某个目录下的文件求 md5 值
"""</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ProcessPool</span>
<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ThreadPool</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="k">def</span> <span class="nf">traverse_dir</span><span class="p">(</span><span class="n">dir_</span><span class="o">=</span><span class="s">'/home/'</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">origin_dir</span><span class="p">,</span> <span class="n">current_dir</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dir_</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">origin_dir</span> <span class="o">+</span> <span class="n">file_</span>


<span class="k">def</span> <span class="nf">create_hash</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traverse_dir</span><span class="p">())</span>
    <span class="c"># import random
</span>
    <span class="c"># random.shuffle(file_list)
</span>
    <span class="k">print</span> <span class="s">'共有 {} 个文件'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">create_hash</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'普通执行状况: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'多进程运行状况: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time2</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">time3</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'多线程运行状况: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time3</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span></code></pre></figure>

<p>有这样几个注意事项：</p>

<ul>
  <li>
    <p>如果对所产生的文件列表进行 <code class="highlighter-rouge">shuflle</code> 操作让文件变得无序的话，所有消耗时间都会变长。说明线程在操作文件时是 <code class="highlighter-rouge">I/O Bound</code> 的行为。</p>
  </li>
  <li>
    <p>第 22 行计算从 1-300 的阶乘，非常典型的消耗 CPU 行为。在这种情况下时间运行状况为：</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  共有 403345 个文件
  普通执行状况: 16.230872
  多进程运行状况: 4.874608
  多线程运行状况: 21.812273

</code></pre>
    </div>
    <p>可以看出多进程操作有明显的优势</p>
  </li>
  <li>如果注释掉第 22 行，运行状况为
    <div class="highlighter-rouge"><pre class="highlight"><code>  共有 403365 个文件
  普通执行状况: 0.182251
  多进程运行状况: 0.39652
  多线程运行状况: 0.234787
</code></pre>
    </div>
    <p>可以看出多线程要比多进程的运行效果好，但仍然不如普通的执行情况。一个解释是切换目录造成的 I/O 阻塞是小于线程之间切换的 context switch 。在用 requests 写爬虫的时候检测到的 <code class="highlighter-rouge">multiprocessing.dummy</code> 运行效果要比单线程快的多。</p>
  </li>
  <li>为了安全，在 map() 后还可以再加上 <code class="highlighter-rouge">pool.close()  pool.join()</code>。<code class="highlighter-rouge">close()</code> 的作用是 <code class="highlighter-rouge">Prevents any more tasks from being submitted to the pool. Once all the tasks have been completed the worker processes will exit.</code>,<code class="highlighter-rouge">join</code> 的作用是 <code class="highlighter-rouge">Wait for the worker processes to exit</code></li>
</ul>

<h5 id="lock">Lock</h5>

<p>Lock 的作用是对一些敏感的函数或者变量，确保只有一个进程/线程来运行。同时因为 Lock 是不可 pickable 的，所以不能作为 map() 的参数传进去。直接使用全局变量来解。</p>

<p>一个例子如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">multiprocessing.Lock</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func1</span><span class="p">():</span>
    <span class="c"># some key function
</span>
    <span class="n">l</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="c"># do-something
</span>
    <span class="n">l</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func2</span><span class="p">():</span>
    <span class="c"># or use next method
</span>
    <span class="k">with</span> <span class="n">l</span><span class="p">:</span>
        <span class="c"># do-something,it will release automatic</span></code></pre></figure>

<p>with lock 实现了 context manager，可以类比于 Java 的 <code class="highlighter-rouge">Synchronized</code> 关键字。在测试时候发现如果所有要执行的函数都被置于 lock 下，那么多进程的执行时间甚至比
顺序执行还要差。</p>

<h5 id="关于-apply_async">关于 apply_async</h5>

<p>在 multiprocessing 的 pool 里除了 map/map_async 外还提供了 apply/apply_async。主要区别包括：</p>

<ul>
  <li>
    <p>map/map_async 可以接受一个包含大量参数的 list，并把这个 list 的每个元素发给要执行的函数。apply/apply_async 则只能接受类似于 tuple 的一个参数，如 <code class="highlighter-rouge">(1,)</code></p>
  </li>
  <li>
    <p>map/apply 都是阻塞型的，也就是返回时间取决于执行最长的那个时间，在所有任务执行完后一起返回。而 map_async/apply_async 则是在开始执行任务时就返回一个 AsyncResult 对象，之后用 <code class="highlighter-rouge">.get()</code> 方法来得到结果。来做一个说明：</p>
  </li>
  <li>
    <p>map_async/apply_async 相比 map/apply 多了一个参数:callback。callback 是一个只接受一个参数的函数，用来对执行的结果进行 ` 写入文件/读入数据库` 等操作。</p>
  </li>
  <li>
    <p>最喜欢使用的两个就是 map 和 apply_async，其中 map 的输出和输入的顺序一致，apply_async 输出和输入顺序无关。进行一个简单的比较如下：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">cal</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="c"># with l:
</span>
    <span class="c">#     #print f
</span>
    <span class="c">#     for _ in range(f):
</span>
    <span class="c">#         temp = reduce(lambda x, y: x * y, range(1, 400))
</span>
    <span class="c">#     #temp = reduce(lambda x, y: x * y, range(1, f))
</span>
    <span class="c">#     return 2**f
</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'{} 出现'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40000</span><span class="p">))</span>
        <span class="c"># temp = reduce(lambda x, y: x * y, range(1, f))
</span>
    <span class="k">return</span> <span class="s">'计算出 {} 的乘积为 {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">date3</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">cal</span><span class="p">,(</span><span class="n">x</span><span class="p">,))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)]:</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'总共花费时间为: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">date3</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">date1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="c">#for x in [pool.map_async(cal, range(1, 30))]:
</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)):</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'总共花费时间为: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">date1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></code></pre></figure>

<p>对 pool.apply_async ，显示结果如下。可以很明显看出一旦结果执行完就返回。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1 出现
2 出现
3 出现
4 出现
计算出 1 的乘积为 2
5 出现
计算出 2 的乘积为 4
6 出现
计算出 3 的乘积为 8
7 出现
计算出 4 的乘积为 16
8 出现
计算出 5 的乘积为 32
9 出现
计算出 6 的乘积为 64
计算出 7 的乘积为 128
计算出 8 的乘积为 256
计算出 9 的乘积为 512
总共花费时间为：5.700147

</code></pre>
</div>

<p>对 pool.map，显示结果如下。可以看出它在等待所有的结果都运行完，存在明显的 block 。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1 出现
2 出现
3 出现
4 出现
5 出现
6 出现
7 出现
8 出现
9 出现
// 此处会出现明显的停顿
计算出 1 的乘积为 2
计算出 2 的乘积为 4
计算出 3 的乘积为 8
计算出 4 的乘积为 16
计算出 5 的乘积为 32
计算出 6 的乘积为 64
计算出 7 的乘积为 128
计算出 8 的乘积为 256
计算出 9 的乘积为 512
总共花费时间为: 5.706731

</code></pre>
</div>

<p>关于性能，在做的大量测试下所花费的时间都是类似的，在这种情况下性能不应该成为考量的瓶颈。apply_async 更适合于希望能立刻得到执行结果的场合：-D</p>

<h4 id="一个更加复杂的例子">一个更加复杂的例子</h4>

<p>上面的方法在大多数情况下已经足够开发用了。但如果我们想要对多进程/线程操作有更好的掌控，如共享状态(share state)，就需要了解的更深。
曾经在学习的时候写过一个用 <code class="highlighter-rouge">mp.Process</code> 来运行，并用 <code class="highlighter-rouge">mp.Queue</code> 来作为队列的例子，参见如下。有时间的话再加上注释吧：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python
</span>
<span class="c"># -*- coding:utf-8 -*-
</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">result_queue</span><span class="p">,</span> <span class="n">visited_set</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># return an item if one is immediately available
</span>
            <span class="n">new_task</span> <span class="o">=</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">url</span><span class="o">=</span><span class="n">new_task</span>
            <span class="s">'''
            if not next_task:
                print '{} exiting'.format(next_task)
                task_queue.task_done()
                break
            '''</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c">#print 'error happened'
</span>

            <span class="c"># task_queue.task_done()
</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">visited_set</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">'{}has been added'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">crawl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">'{}:{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
        <span class="n">visited_set</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="n">result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c">#time.sleep(5.0/1000)
</span>
    <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">title</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r'&lt;title&gt;(.*?).&lt;/title&gt;'</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">title</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">JoinableQueue</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="c"># completeFlag 
</span>
    <span class="n">vset</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="nb">dict</span><span class="p">()</span>

    <span class="n">num_consumers</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">print</span> <span class="s">'Creating {} consumers'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_consumers</span><span class="p">)</span>
    <span class="n">num_jobs</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">url_list</span><span class="o">=</span><span class="p">[</span><span class="s">'http://www.qunar.com'</span><span class="p">,</span><span class="s">'http://www.douban.com'</span><span class="p">,</span>
    <span class="s">'http://www.github.com'</span><span class="p">,</span><span class="s">'http://www.ctrip.com'</span><span class="p">,</span><span class="s">'http://www.v2ex.com'</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">vset</span><span class="p">))</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">num_consumers</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c"># wait until all the items in taskqueue are processed
</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">),</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">'停止'</span>
            <span class="k">break</span>

    <span class="k">print</span> <span class="s">'cost {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span></code></pre></figure>

<h4 id="python3-里的-threadprocess-poolexecutor">Python3 里的 Thread/Process PoolExecutor</h4>

<p>Python3 里为进程和线程提供了进一步的抽象。使用方法有两种：</p>

<h5 id="使用-map">使用 map</h5>

<p>一个典型的函数如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">executor</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span></code></pre></figure>

<p>在对上面的代码稍作改动之后在 Python3 里运行，在最好的情况里结果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>普通执行状况: 12.71012
多进程运行状况: 5.799454
多线程运行状况: 18.085609
ThreadPoolExecutor 运行状况: 18.403806
ProcessPoolExecutor 运行状况: 5.764657
</code></pre>
</div>
<p>其他大部分的情况 ThreadPoolExecutor 和 ProcessPoolExecutor 都比 multiprocessing 的效果差。原因可以参考 <a href="http://stackoverflow.com/questions/18671528/processpoolexecutor-from-concurrent-futures-way-slower-than-multiprocessing-pool">processpoolexecutor-from-concurrent-futures-way-slower-than-multiprocessing-pool</a>也就是说 PoolExecutor 里最好的适用情况是用 submit() 来监测即时更新的结果，而非套用 mp 。这就引到了第二种使用，使用 <code class="highlighter-rouge">submit()</code>:</p>

<h5 id="使用-submit">使用 submit</h5>

<p>正如上面所说，对 PoolExecutor 用 map 的意义不大。下面就主要对 submit　进行讨论。
submit 这里很明显可以看到 Java 的影子。future 特性最好的是一旦完成就返回，而不必等到所有阻塞返回。和 apply_async 相比更抽象。
对官网的例子略作改进，一个使用如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span><span class="n">as_completed</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">URLS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'http://www.foxnews.com/'</span><span class="p">,</span>
        <span class="s">'http://www.cnn.com/'</span><span class="p">,</span>
        <span class="s">'http://europe.wsj.com/'</span><span class="p">,</span>
        <span class="s">'http://www.bbc.co.uk/'</span><span class="p">,</span>
        <span class="s">'http://some-made-up-domain.com/'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">load_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">future_to_url</span> <span class="o">=</span> <span class="p">{</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">load_url</span><span class="p">,</span><span class="n">url</span><span class="p">):</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">URLS</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_url</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">future_to_url</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="s">'raise exception'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="s">'{url} content is {content}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span><span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">))</span></code></pre></figure>

        </div>
        
          <p class="post-continue">
            <a href="/2014/06/22/Python-Multiprocessing-Multithreading/">Read on &rarr;</a>
          </p>
        
      </li>
    
  </ul>

  


</div>

        


    </main>
    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Pro Land
    </p>

  </div>

</footer>


  </body>

</html>
