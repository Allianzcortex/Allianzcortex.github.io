<!DOCTYPE html>

<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>One Line To Achieve MultiProcess and MultiThreads In Python</title>
  <meta name="description" content="Using multiprocessing and multiprocessing.dummy to implement multi-process and multi-threading, adding ThreadPoolExecutor and other content. 这篇文章对应的中文版 Just Add One-line There is not much description about pros and cons between multiprocessing and Thread, because the key is that we want our code to be parallel:-D Read this article [parallelism-in-one-line] (http://chriskiehl.com/article/parallelism-in-one-line/) to get a rough impression. Providing an example written: # -*- coding:utf-8 -*- &quot;&quot;&quot; calculate the md5 value for files under one directory &quot;&quot;&quot; import os import hashlib from multiprocessing import Pool as ProcessPool from multiprocessing.dummy import Pool as ThreadPool from datetime import datetime def traverse_dir(dir_=&#39;/home/&#39;): for origin_dir, current_dir, filename in os.walk(dir_): for file_ in filename: yield origin_dir + file_ def create_hash(filename): hashlib.md5(filename) temp = reduce(lambda x, y: x * y, range(1, 300)) if __name__ == &#39;__main__&#39;: file_list = list(traverse_dir()) # import random # random.shuffle(file_list) print &#39;There are {} files&#39;.format(len(file_list)) time1 = datetime.now() for filename in file_list: create_hash(filename) print &#39;normal case: {}&#39;.format((datetime.now() - time1).total_seconds()) pool = ProcessPool(4) time2 = datetime.now() pool.map(create_hash, file_list) print &#39;multi-process case: {}&#39;.format((datetime.now() - time2).total_seconds()) pool = ThreadPool(4) time3 = datetime.now() pool.map(create_hash, file_list) print &#39;multi-thread: {}&#39;.format((datetime.now() - time3).total_seconds()) There are something to mention： If the shuflle operation is performed on the generated file list to make the file unordered,then all the time will be longer. Explain that the thread is I/O Bound when it manipulates the file. Line 22 calculates the factorial from 1-300, which is very typical of CPU consumption. In this case the time health is: There are 403345 files normal case: 16.230872 multi-process: 4.874608 multi-thread: 21.812273 There are obvious multi-process advantages on multi=progress. 4&amp;lt;16&amp;lt;21 it is not difficult to choose. If we comment the line 22,then situation will be: There are 403365 files normal case: 0.182251 multi-process: 0.39652 multi-thread: 0.234787 For security, you can add pool.close() pool.join() after map() . The role of close() is Prevents any more tasks from being submitted to the pool. Once all the tasks have been completed , the worker processes will exit., join is Wait for the worker processes to exit Lock The role of Lock is for some sensitive functions or variables, ensuring that only one process/thread is running. Also because Lock is not pickable, it cannot be passed as a parameter to map() . Use global variables directly to solve. An example is as follows: import multiprocessing.Lock l = Lock() def func1(): # some key function l.acquire() # do-something l.release() def func2(): # or use next method with l: # do-something,it will release automatic With lock implements the context manager, which can be compared to Java’s Synchronized keyword. During the test, it was found that if all the functions to be executed were placed under lock, the execution time of multiple processes was even worse than the sequential execution. About apply_async In the multiprocessing pool, apply/apply_async is provided in addition to map/map_async. The main differences include: map/map_async can accept a list containing a large number of arguments and send each element of the list to the function to be executed. Apply/apply_async only accepts one parameter like tuple, such as (1,) map/apply is block-type, that is, the return time depends on the longest execution time and returns after all tasks have been executed. Map_async/apply_async returns an AsyncResult object when it starts executing the task, and then uses the .get() method to get the result. map_async/apply_async has one more parameter than map/apply: callback. Callback is a function that accepts only one parameter and is used to perform operations such as write file/read into database on the result of the execution. The two favorite ones are map and apply_async, where the output of map is the same as the order of the input, and the apply_async output is independent of the input order. Make a simple comparison as follows: import multiprocessing from datetime import datetime from functools import reduce l = multiprocessing.Lock() def cal(f): # test lock # with l: # #print f # for _ in range(f): # temp = reduce(lambda x, y: x * y, range(1, 400)) # #temp = reduce(lambda x, y: x * y, range(1, f)) # return 2**f print (&#39;{} occurs&#39;.format(f)) for _ in range(f): temp = reduce(lambda x, y: x * y, range(1, 40000)) # temp = reduce(lambda x, y: x * y, range(1, f)) return &#39;calculate {} result is {}&#39;.format(f,2**f) if __name__==&#39;__main__&#39;: pool = multiprocessing.Pool(4) date3 = datetime.now() for c in [pool.apply_async(cal,(x,)) for x in range(1,10)]: print (c.get()) print (&#39;Total cost time is: {}&#39;.format((datetime.now()-date3).total_seconds())) pool.close() pool.join() pool = multiprocessing.Pool(4) date1 = datetime.now() for x in pool.map(cal,range(1,10)): print (x) print (&#39;Total cost time is: {}&#39;.format((datetime.now() - date1).total_seconds())) pool.close() pool.join() Result of pool.apply_async. Each task returns result the moment it is finished. 1 occurs 2 occurs 3 occurs 4 occurs calculate 1 result is 2 5 occurs calculate 2 result is 4 6 occurs calculate 3 result is 8 7 occurs calculate 4 result is 16 8 occurs calculate 5 result is 32 9 occurs calculate 6 result is 64 calculate 7 result is 128 calculate 8 result is 256 calculate 9 result is 512 Total cost time is：5.700147 Result of pool.map. It is waiting for all results to be finished. 1 occurs 2 occurs 3 occurs 4 occurs 5 occurs 6 occurs 7 occurs 8 occurs 9 occurs // it will pause for a few seconds calculate 1 result is 2 calculate 2 result is 4 calculate 3 result is 8 calculate 4 result is 16 calculate 5 result is 32 calculate 6 result is 64 calculate 7 result is 128 calculate 8 result is 256 calculate 9 result is 512 Total cost time is: 5.706731 Regarding performance, the time spent remain contant while doing a lot of testing So performance should not be a bottleneck. Apply_async is more suitable for occasions where you want immediate results. A Complicated Example The above method is sufficient for development in most cases. But if we want to have better control over multi-process/thread operations such as sharing state among different threads. we need to understand more. I used to write an example of running with mp.Process and using mp.Queue as a queue, as shown below. #!/usr/bin/env python # -*- coding:utf-8 -*- import multiprocessing as mp import Queue import time import re import requests def run(task_queue, result_queue, visited_set): name = mp.current_process().name while True: try: # return an item if one is immediately available new_task = task_queue.get(False) url=new_task &#39;&#39;&#39; if not next_task: print &#39;{} exiting&#39;.format(next_task) task_queue.task_done() break &#39;&#39;&#39; except Queue.Empty: # task_queue.task_done() break if visited_set.has_key(url): print &#39;{}has been added&#39;.format(url) task_queue.task_done() continue title = crawl(url) print &#39;{}:{}&#39;.format(name,title) visited_set[url] = 1 task_queue.task_done() result_queue.put(title) return def crawl(url): #time.sleep(5.0/1000) r=requests.get(url) title=re.findall(r&#39;&amp;lt;title&amp;gt;(.*?).&amp;lt;/title&amp;gt;&#39;,r.content) return title if __name__ == &#39;__main__&#39;: t1=time.time() tasks = mp.JoinableQueue() results = mp.Queue() manager = mp.Manager() # completeFlag vset = manager.dict() num_consumers = mp.cpu_count() * 2 print &#39;Creating {} consumers&#39;.format(num_consumers) num_jobs = 10 url_list=[&#39;http://www.qunar.com&#39;,&#39;http://www.douban.com&#39;, &#39;http://www.github.com&#39;,&#39;http://www.ctrip.com&#39;,&#39;http://www.v2ex.com&#39;] for u in url_list: tasks.put(u, False) tasks.put(url_list[2], False) tasks.put(url_list[3], False) processes = [mp.Process(target=run, args=(tasks, results, vset)) for i in xrange(num_consumers)] for p in processes: p.start() # wait until all the items in taskqueue are processed tasks.join() for p in processes: p.join() while True: try: print results.get(False), except Queue.Empty: print &#39;stop&#39; break print &#39;cost {}&#39;.format(time.time()-t1) Thread/Process And PoolExecutor In Python3 Python3 provides a high-level abstraction。There are two ways to use: Using Map A standard example is： with ProcessPoolExecutor(max_workers=4) as executor: executor.map(create_hash, file_list) put it in the above example.The result is: normal case: 12.71012 multi-process case: 5.799454 multi-thread: 18.085609 ThreadPoolExecutor case: 18.403806 ProcessPoolExecutor case: 5.764657 In most cases,ThreadPoolExecutor and ProcessPoolExecutor, are less effective than multiprocessing. The reason can be referred to processpoolexecutor-from-concurrent-futures-way-slower-than-multiprocessing-pool That is to say, the best application in PoolExecutor is to use submit() to monitor the results of instant updates instead of applying mp. Using submit As mentioned above, the use of map for PoolExecutor is of little significance. The main discussion of submit is as follows. It is obvious that you can see the shadow of Java. The best feature of the future feature is to return once it’s done, without having to wait for all blocking to return. It is more abstract than apply_async. The example of the official website is slightly improved. It can be used as follows: from concurrent.futures import ThreadPoolExecutor,as_completed import requests URLS = [&#39;http://www.foxnews.com/&#39;, &#39;http://www.cnn.com/&#39;, &#39;http://europe.wsj.com/&#39;, &#39;http://www.bbc.co.uk/&#39;, &#39;http://some-made-up-domain.com/&#39;] def load_url(url): return requests.get(url).content().decode(&#39;utf-8&#39;) if __name__ == &#39;__main__&#39;: with ThreadPoolExecutor(max_workers=4) as executor: future_to_url = {executor.submit(load_url,url):url for url in URLS} for future in as_completed(future_to_url): url = future_to_url.get(future) try: data = future.result() except Exception as ex: print (&#39;raise exception&#39;) else: print (&#39;{url} content is {content}&#39;.format(url=url,content=data))">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2014/06/22/Python-Multiprocessing-Multithreading/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Allianzcortex-Blog" href="http://localhost:4000/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="hzcortex">
  <meta name="twitter:title" content="One Line To Achieve MultiProcess and MultiThreads In Python">
  <meta name="twitter:description" content="Using multiprocessing and multiprocessing.dummy to implement multi-process and multi-threading, adding ThreadPoolExecutor and other content. 这篇文章对应的中文版 Just Add One-line There is not much descripti...">
  
    <meta name="twitter:creator" content="hzcortex">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Allianzcortex-Blog</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="/projects/">Projects</a>
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/board/">board</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">One Line To Achieve MultiProcess and MultiThreads In Python</h1>
    
    <p class="post-meta"><time datetime="2014-06-22T07:49:24-03:00" itemprop="datePublished">Jun 22, 2014</time> • 
  
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Using <code class="highlighter-rouge">multiprocessing</code> and <code class="highlighter-rouge">multiprocessing.dummy</code> to implement multi-process and multi-threading, adding ThreadPoolExecutor and other content.</p>

<!-- more -->

<p><a href="/../translation/2014-06-22-Python-Multiprocessing-Multithreading.html">这篇文章对应的中文版</a></p>

<h4 id="just-add-one-line">Just Add One-line</h4>

<p>There is not much description about pros and cons between multiprocessing and Thread, because the key is that we want our code to be parallel:-D</p>

<p>Read this article [parallelism-in-one-line] (http://chriskiehl.com/article/parallelism-in-one-line/) to get a rough impression.</p>

<p>Providing an example written:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># -*- coding:utf-8 -*-
</span>

<span class="s">"""
calculate the md5 value for files under one directory
"""</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ProcessPool</span>
<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ThreadPool</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="k">def</span> <span class="nf">traverse_dir</span><span class="p">(</span><span class="n">dir_</span><span class="o">=</span><span class="s">'/home/'</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">origin_dir</span><span class="p">,</span> <span class="n">current_dir</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dir_</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">origin_dir</span> <span class="o">+</span> <span class="n">file_</span>


<span class="k">def</span> <span class="nf">create_hash</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traverse_dir</span><span class="p">())</span>
    <span class="c"># import random
</span>
    <span class="c"># random.shuffle(file_list)
</span>
    <span class="k">print</span> <span class="s">'There are {} files'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">create_hash</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'normal case: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'multi-process case: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time2</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">time3</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'multi-thread: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time3</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span></code></pre></figure>

<p>There are something to mention：</p>

<ul>
  <li>If the <code class="highlighter-rouge">shuflle</code> operation is performed on the generated file list to make the file unordered,then all the time will be longer. Explain that the thread is <code class="highlighter-rouge">I/O Bound</code> when it manipulates the file.</li>
</ul>

<p>Line 22 calculates the factorial from 1-300, which is very typical of CPU consumption. In this case the time health is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>There are 403345 files
normal case: 16.230872
multi-process: 4.874608
multi-thread: 21.812273
</code></pre>
</div>
<p>There are obvious multi-process advantages on multi=progress. <code class="highlighter-rouge">4&lt;16&lt;21</code> it is not difficult to choose.</p>

<p>If we comment the line 22,then situation will be:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>There are 403365 files
normal case: 0.182251
multi-process: 0.39652
multi-thread: 0.234787
</code></pre>
</div>

<ul>
  <li>For security, you can add <code class="highlighter-rouge">pool.close() pool.join()</code> after map() . The role of <code class="highlighter-rouge">close()</code> is <code class="highlighter-rouge">Prevents any more tasks from being submitted to the pool. Once all the tasks have been completed , the worker processes will exit.</code>, <code class="highlighter-rouge">join</code> is <code class="highlighter-rouge">Wait for the worker processes to exit</code></li>
</ul>

<h5 id="lock">Lock</h5>

<p>The role of <code class="highlighter-rouge">Lock</code> is for some sensitive functions or variables, ensuring that only one process/thread is running. Also because Lock is not pickable, it cannot be passed as a parameter to map() . Use global variables directly to solve.</p>

<p>An example is as follows:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">multiprocessing.Lock</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func1</span><span class="p">():</span>
    <span class="c"># some key function
</span>
    <span class="n">l</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="c"># do-something
</span>
    <span class="n">l</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func2</span><span class="p">():</span>
    <span class="c"># or use next method
</span>
    <span class="k">with</span> <span class="n">l</span><span class="p">:</span>
        <span class="c"># do-something,it will release automatic</span></code></pre></figure>

<p><code class="highlighter-rouge">With lock</code> implements the context manager, which can be compared to Java’s <code class="highlighter-rouge">Synchronized</code> keyword. During the test, it was found that if all the functions to be executed were placed under lock, the execution time of multiple processes was even worse than the sequential execution.</p>

<h5 id="about-apply_async">About apply_async</h5>

<p>In the multiprocessing pool, <code class="highlighter-rouge">apply/apply_async</code> is provided in addition to map/map_async. The main differences include:</p>

<ul>
  <li>
    <p>map/map_async can accept a list containing a large number of arguments and send each element of the list to the function to be executed. Apply/apply_async only accepts one parameter like tuple, such as <code class="highlighter-rouge">(1,)</code></p>
  </li>
  <li>
    <p>map/apply is block-type, that is, the return time depends on the longest execution time and returns after all tasks have been executed. Map_async/apply_async returns an AsyncResult object when it starts executing the task, and then uses the <code class="highlighter-rouge">.get()</code> method to get the result.</p>
  </li>
  <li>
    <p>map_async/apply_async has one more parameter than map/apply: callback. Callback is a function that accepts only one parameter and is used to perform operations such as <code class="highlighter-rouge">write file/read into database</code> on the result of the execution.</p>
  </li>
  <li>
    <p>The two favorite ones are map and apply_async, where the output of map is the same as the order of the input, and the apply_async output is independent of the input order.</p>
  </li>
</ul>

<p>Make a simple comparison as follows:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">cal</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="c"># test lock 
</span>
    <span class="c"># with l:
</span>
    <span class="c">#     #print f
</span>
    <span class="c">#     for _ in range(f):
</span>
    <span class="c">#         temp = reduce(lambda x, y: x * y, range(1, 400))
</span>
    <span class="c">#     #temp = reduce(lambda x, y: x * y, range(1, f))
</span>
    <span class="c">#     return 2**f
</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'{} occurs'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40000</span><span class="p">))</span>
        <span class="c"># temp = reduce(lambda x, y: x * y, range(1, f))
</span>
    <span class="k">return</span> <span class="s">'calculate {} result is {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">date3</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">cal</span><span class="p">,(</span><span class="n">x</span><span class="p">,))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)]:</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'Total cost time is: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">date3</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">date1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)):</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'Total cost time is: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">date1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></code></pre></figure>

<p>Result of <code class="highlighter-rouge">pool.apply_async</code>. Each task returns result the moment it is finished.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1 occurs
2 occurs
3 occurs
4 occurs
calculate 1 result is 2
5 occurs
calculate 2 result is 4
6 occurs
calculate 3 result is 8
7 occurs
calculate 4 result is 16
8 occurs
calculate 5 result is 32
9 occurs
calculate 6 result is 64
calculate 7 result is 128
calculate 8 result is 256
calculate 9 result is 512
Total cost time is：5.700147

</code></pre>
</div>
<p>Result of <code class="highlighter-rouge">pool.map</code>. It is waiting for all results to be finished.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1 occurs
2 occurs
3 occurs
4 occurs
5 occurs
6 occurs
7 occurs
8 occurs
9 occurs
// it will pause for a few seconds
calculate 1 result is 2
calculate 2 result is 4
calculate 3 result is 8
calculate 4 result is 16
calculate 5 result is 32
calculate 6 result is 64
calculate 7 result is 128
calculate 8 result is 256
calculate 9 result is 512
Total cost time is: 5.706731

</code></pre>
</div>

<p>Regarding performance, the time spent remain contant while doing a lot of testing So performance should not be a bottleneck. <code class="highlighter-rouge">Apply_async</code> is more suitable for occasions where you want immediate results.</p>

<h4 id="a-complicated-example">A Complicated Example</h4>

<p>The above method is sufficient for development in most cases. But if we want to have better control over multi-process/thread operations such as sharing state among different threads. we need to understand more.</p>

<p>I used to write an example of running with <code class="highlighter-rouge">mp.Process</code> and using <code class="highlighter-rouge">mp.Queue</code> as a queue, as shown below.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python
</span>
<span class="c"># -*- coding:utf-8 -*-
</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">result_queue</span><span class="p">,</span> <span class="n">visited_set</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># return an item if one is immediately available
</span>
            <span class="n">new_task</span> <span class="o">=</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">url</span><span class="o">=</span><span class="n">new_task</span>
            <span class="s">'''
            if not next_task:
                print '{} exiting'.format(next_task)
                task_queue.task_done()
                break
            '''</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c"># task_queue.task_done()
</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">visited_set</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">'{}has been added'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">crawl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">'{}:{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
        <span class="n">visited_set</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="n">result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c">#time.sleep(5.0/1000)
</span>
    <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">title</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r'&lt;title&gt;(.*?).&lt;/title&gt;'</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">title</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">JoinableQueue</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="c"># completeFlag 
</span>
    <span class="n">vset</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="nb">dict</span><span class="p">()</span>

    <span class="n">num_consumers</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">print</span> <span class="s">'Creating {} consumers'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_consumers</span><span class="p">)</span>
    <span class="n">num_jobs</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">url_list</span><span class="o">=</span><span class="p">[</span><span class="s">'http://www.qunar.com'</span><span class="p">,</span><span class="s">'http://www.douban.com'</span><span class="p">,</span>
    <span class="s">'http://www.github.com'</span><span class="p">,</span><span class="s">'http://www.ctrip.com'</span><span class="p">,</span><span class="s">'http://www.v2ex.com'</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">vset</span><span class="p">))</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">num_consumers</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c"># wait until all the items in taskqueue are processed
</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">),</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">'stop'</span>
            <span class="k">break</span>

    <span class="k">print</span> <span class="s">'cost {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span></code></pre></figure>

<h4 id="threadprocess-and-poolexecutor-in-python3">Thread/Process And PoolExecutor In Python3</h4>

<p>Python3 provides a high-level abstraction。There are two ways to use:</p>

<h3 id="using-map">Using Map</h3>

<p>A standard example is：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">executor</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span></code></pre></figure>

<p>put it in the above example.The result is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>normal case: 12.71012
multi-process case: 5.799454
multi-thread: 18.085609
ThreadPoolExecutor case: 18.403806
ProcessPoolExecutor case: 5.764657
</code></pre>
</div>

<p>In most cases,<code class="highlighter-rouge">ThreadPoolExecutor</code> and <code class="highlighter-rouge">ProcessPoolExecutor</code>, are less effective than <code class="highlighter-rouge">multiprocessing</code>. The reason can be referred to <a href="http://stackoverflow.com/questions/18671528/processpoolexecutor-from-concurrent-futures-way-slower-than-multiprocessing -pool">processpoolexecutor-from-concurrent-futures-way-slower-than-multiprocessing-pool</a> That is to say, the best application in PoolExecutor is to use submit() to monitor the results of instant updates instead of applying mp.</p>

<h5 id="using-submit">Using submit</h5>

<p>As mentioned above, the use of map for PoolExecutor is of little significance. The main discussion of submit is as follows.</p>

<p>It is obvious that you can see the shadow of Java. The best feature of the future feature is to return once it’s done, without having to wait for all blocking to return. It is more abstract than apply_async.</p>

<p>The example of the official website is slightly improved. It can be used as follows:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span><span class="n">as_completed</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">URLS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'http://www.foxnews.com/'</span><span class="p">,</span>
        <span class="s">'http://www.cnn.com/'</span><span class="p">,</span>
        <span class="s">'http://europe.wsj.com/'</span><span class="p">,</span>
        <span class="s">'http://www.bbc.co.uk/'</span><span class="p">,</span>
        <span class="s">'http://some-made-up-domain.com/'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">load_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">future_to_url</span> <span class="o">=</span> <span class="p">{</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">load_url</span><span class="p">,</span><span class="n">url</span><span class="p">):</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">URLS</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_url</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">future_to_url</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="s">'raise exception'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="s">'{url} content is {content}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span><span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">))</span></code></pre></figure>

  </div>

</article>

        


    </main>
    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Pro Land
    </p>

  </div>

</footer>


  </body>

</html>
