<!DOCTYPE html>

<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Python one-line 实现多进程和多线程(修正版)</title>
  <meta name="description" content="用 multiprocessing 和 multiprocessing.dummy 来实现多进程/实现多进程和多线程，增加了 ThreadPoolExecutor 以及其他内容">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2014/06/22/Python-Multiprocessing-Multithreading/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Allianzcortex-Blog" href="http://localhost:4000/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="hzcortex">
  <meta name="twitter:title" content="Python one-line 实现多进程和多线程(修正版)">
  <meta name="twitter:description" content="用 multiprocessing 和 multiprocessing.dummy 来实现多进程/实现多进程和多线程，增加了 ThreadPoolExecutor 以及其他内容">
  
    <meta name="twitter:creator" content="hzcortex">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Allianzcortex-Blog</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="/projects/">Projects</a>
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/board/">board</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Python one-line 实现多进程和多线程(修正版)</h1>
    
    <p class="post-meta"><time datetime="2014-06-22T18:49:24+08:00" itemprop="datePublished">Jun 22, 2014</time> • 
  
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>用 <code class="highlighter-rouge">multiprocessing</code> 和 <code class="highlighter-rouge">multiprocessing.dummy</code> 来实现多进程/实现多进程和多线程，增加了 ThreadPoolExecutor 以及其他内容</p>

<!-- more -->

<h4 id="直接使用-one-line">直接使用 one-line</h4>

<p>关于 multiprocessing 和 Thread 之间的 pros 和 cons 就不多做描述了，因为关键是我们要让我们的代码来并行对吧:-D</p>

<p>关于使用就直接看这篇文章 <a href="http://chriskiehl.com/article/parallelism-in-one-line/">parallelism-in-one-line</a> 好啦</p>

<p>来提供一个所写的例子：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># -*- coding:utf-8 -*-</span>

<span class="s">"""
对某个目录下的文件求 md5 值
"""</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ProcessPool</span>
<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ThreadPool</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="k">def</span> <span class="nf">traverse_dir</span><span class="p">(</span><span class="n">dir_</span><span class="o">=</span><span class="s">'/home/'</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">origin_dir</span><span class="p">,</span> <span class="n">current_dir</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dir_</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">origin_dir</span> <span class="o">+</span> <span class="n">file_</span>


<span class="k">def</span> <span class="nf">create_hash</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traverse_dir</span><span class="p">())</span>
    <span class="c"># import random</span>
    <span class="c"># random.shuffle(file_list)</span>
    <span class="k">print</span> <span class="s">'共有 {} 个文件'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">create_hash</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'普通执行状况: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">ProcessPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'多进程运行状况: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time2</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">time3</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'多线程运行状况: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">time3</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span></code></pre></figure>

<p>有这样几个注意事项：</p>

<ul>
  <li>
    <p>如果对所产生的文件列表进行 <code class="highlighter-rouge">shuflle</code> 操作让文件变得无序的话，所有消耗时间都会变长。说明线程在操作文件时是 <code class="highlighter-rouge">I/O Bound</code> 的行为。</p>
  </li>
  <li>
    <p>第 22 行计算从 1-300 的阶乘，非常典型的消耗 CPU 行为。在这种情况下时间运行状况为：</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  共有 403345 个文件
  普通执行状况: 16.230872
  多进程运行状况: 4.874608
  多线程运行状况: 21.812273

</code></pre>
    </div>
    <p>可以看出多进程操作有明显的优势</p>
  </li>
  <li>如果注释掉第 22 行，运行状况为
    <div class="highlighter-rouge"><pre class="highlight"><code>  共有 403365 个文件
  普通执行状况: 0.182251
  多进程运行状况: 0.39652
  多线程运行状况: 0.234787
</code></pre>
    </div>
    <p>可以看出多线程要比多进程的运行效果好，但仍然不如普通的执行情况。一个解释是切换目录造成的 I/O 阻塞是小于线程之间切换的 context switch 。在用 requests 写爬虫的时候检测到的 <code class="highlighter-rouge">multiprocessing.dummy</code> 运行效果要比单线程快的多。</p>
  </li>
  <li>为了安全，在 map() 后还可以再加上 <code class="highlighter-rouge">pool.close()  pool.join()</code>。<code class="highlighter-rouge">close()</code> 的作用是 <code class="highlighter-rouge">Prevents any more tasks from being submitted to the pool. Once all the tasks have been completed the worker processes will exit.</code>,<code class="highlighter-rouge">join</code> 的作用是 <code class="highlighter-rouge">Wait for the worker processes to exit</code></li>
</ul>

<h5 id="lock">Lock</h5>

<p>Lock 的作用是对一些敏感的函数或者变量，确保只有一个进程/线程来运行。同时因为 Lock 是不可 pickable 的，所以不能作为 map() 的参数传进去。直接使用全局变量来解。</p>

<p>一个例子如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">multiprocessing.Lock</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func1</span><span class="p">():</span>
    <span class="c"># some key function</span>
    <span class="n">l</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="c"># do-something</span>
    <span class="n">l</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func2</span><span class="p">():</span>
    <span class="c"># or use next method</span>
    <span class="k">with</span> <span class="n">l</span><span class="p">:</span>
        <span class="c"># do-something,it will release automatic</span></code></pre></figure>

<p>with lock 实现了 context manager，可以类比于 Java 的 <code class="highlighter-rouge">Synchronized</code> 关键字。在测试时候发现如果所有要执行的函数都被置于 lock 下，那么多进程的执行时间甚至比
顺序执行还要差。</p>

<h5 id="关于-apply_async">关于 apply_async</h5>

<p>在 multiprocessing 的 pool 里除了 map/map_async 外还提供了 apply/apply_async。主要区别包括：</p>

<ul>
  <li>
    <p>map/map_async 可以接受一个包含大量参数的 list，并把这个 list 的每个元素发给要执行的函数。apply/apply_async 则只能接受类似于 tuple 的一个参数，如 <code class="highlighter-rouge">(1,)</code></p>
  </li>
  <li>
    <p>map/apply 都是阻塞型的，也就是返回时间取决于执行最长的那个时间，在所有任务执行完后一起返回。而 map_async/apply_async 则是在开始执行任务时就返回一个 AsyncResult 对象，之后用 <code class="highlighter-rouge">.get()</code> 方法来得到结果。来做一个说明：</p>
  </li>
  <li>
    <p>map_async/apply_async 相比 map/apply 多了一个参数:callback。callback 是一个只接受一个参数的函数，用来对执行的结果进行 ` 写入文件/读入数据库` 等操作。</p>
  </li>
  <li>
    <p>最喜欢使用的两个就是 map 和 apply_async，其中 map 的输出和输入的顺序一致，apply_async 输出和输入顺序无关。进行一个简单的比较如下：</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>

<span class="n">l</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">cal</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="c"># with l:</span>
    <span class="c">#     #print f</span>
    <span class="c">#     for _ in range(f):</span>
    <span class="c">#         temp = reduce(lambda x, y: x * y, range(1, 400))</span>
    <span class="c">#     #temp = reduce(lambda x, y: x * y, range(1, f))</span>
    <span class="c">#     return 2**f</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'{} 出现'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40000</span><span class="p">))</span>
        <span class="c"># temp = reduce(lambda x, y: x * y, range(1, f))</span>
    <span class="k">return</span> <span class="s">'计算出 {} 的乘积为 {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="n">f</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">date3</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">cal</span><span class="p">,(</span><span class="n">x</span><span class="p">,))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)]:</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'总共花费时间为: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">date3</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">date1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="c">#for x in [pool.map_async(cal, range(1, 30))]:</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)):</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'总共花费时间为: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">date1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></code></pre></figure>

<p>对 pool.apply_async ，显示结果如下。可以很明显看出一旦结果执行完就返回。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1 出现
2 出现
3 出现
4 出现
计算出 1 的乘积为 2
5 出现
计算出 2 的乘积为 4
6 出现
计算出 3 的乘积为 8
7 出现
计算出 4 的乘积为 16
8 出现
计算出 5 的乘积为 32
9 出现
计算出 6 的乘积为 64
计算出 7 的乘积为 128
计算出 8 的乘积为 256
计算出 9 的乘积为 512
总共花费时间为：5.700147

</code></pre>
</div>

<p>对 pool.map，显示结果如下。可以看出它在等待所有的结果都运行完，存在明显的 block 。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1 出现
2 出现
3 出现
4 出现
5 出现
6 出现
7 出现
8 出现
9 出现
// 此处会出现明显的停顿
计算出 1 的乘积为 2
计算出 2 的乘积为 4
计算出 3 的乘积为 8
计算出 4 的乘积为 16
计算出 5 的乘积为 32
计算出 6 的乘积为 64
计算出 7 的乘积为 128
计算出 8 的乘积为 256
计算出 9 的乘积为 512
总共花费时间为: 5.706731

</code></pre>
</div>

<p>关于性能，在做的大量测试下所花费的时间都是类似的，在这种情况下性能不应该成为考量的瓶颈。apply_async 更适合于希望能立刻得到执行结果的场合：-D</p>

<h4 id="一个更加复杂的例子">一个更加复杂的例子</h4>

<p>上面的方法在大多数情况下已经足够开发用了。但如果我们想要对多进程/线程操作有更好的掌控，如共享状态(share state)，就需要了解的更深。
曾经在学习的时候写过一个用 <code class="highlighter-rouge">mp.Process</code> 来运行，并用 <code class="highlighter-rouge">mp.Queue</code> 来作为队列的例子，参见如下。有时间的话再加上注释吧：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding:utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">result_queue</span><span class="p">,</span> <span class="n">visited_set</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># return an item if one is immediately available</span>
            <span class="n">new_task</span> <span class="o">=</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">url</span><span class="o">=</span><span class="n">new_task</span>
            <span class="s">'''
            if not next_task:
                print '{} exiting'.format(next_task)
                task_queue.task_done()
                break
            '''</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c">#print 'error happened'</span>

            <span class="c"># task_queue.task_done()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">visited_set</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">'{}has been added'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">crawl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">'{}:{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
        <span class="n">visited_set</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="n">result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c">#time.sleep(5.0/1000)</span>
    <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">title</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r'&lt;title&gt;(.*?).&lt;/title&gt;'</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">title</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">JoinableQueue</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="c"># completeFlag </span>
    <span class="n">vset</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="nb">dict</span><span class="p">()</span>

    <span class="n">num_consumers</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">print</span> <span class="s">'Creating {} consumers'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_consumers</span><span class="p">)</span>
    <span class="n">num_jobs</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">url_list</span><span class="o">=</span><span class="p">[</span><span class="s">'http://www.qunar.com'</span><span class="p">,</span><span class="s">'http://www.douban.com'</span><span class="p">,</span>
    <span class="s">'http://www.github.com'</span><span class="p">,</span><span class="s">'http://www.ctrip.com'</span><span class="p">,</span><span class="s">'http://www.v2ex.com'</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">vset</span><span class="p">))</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">num_consumers</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c"># wait until all the items in taskqueue are processed</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">),</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">'停止'</span>
            <span class="k">break</span>

    <span class="k">print</span> <span class="s">'cost {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span></code></pre></figure>

<h4 id="python3-里的-threadprocess-poolexecutor">Python3 里的 Thread/Process PoolExecutor</h4>

<p>Python3 里为进程和线程提供了进一步的抽象。使用方法有两种：</p>

<h5 id="使用-map">使用 map</h5>

<p>一个典型的函数如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">executor</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">create_hash</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span></code></pre></figure>

<p>在对上面的代码稍作改动之后在 Python3 里运行，在最好的情况里结果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>普通执行状况: 12.71012
多进程运行状况: 5.799454
多线程运行状况: 18.085609
ThreadPoolExecutor 运行状况: 18.403806
ProcessPoolExecutor 运行状况: 5.764657
</code></pre>
</div>
<p>其他大部分的情况 ThreadPoolExecutor 和 ProcessPoolExecutor 都比 multiprocessing 的效果差。原因可以参考 <a href="http://stackoverflow.com/questions/18671528/processpoolexecutor-from-concurrent-futures-way-slower-than-multiprocessing-pool">processpoolexecutor-from-concurrent-futures-way-slower-than-multiprocessing-pool</a>也就是说 PoolExecutor 里最好的适用情况是用 submit() 来监测即时更新的结果，而非套用 mp 。这就引到了第二种使用，使用 <code class="highlighter-rouge">submit()</code>:</p>

<h5 id="使用-submit">使用 submit</h5>

<p>正如上面所说，对 PoolExecutor 用 map 的意义不大。下面就主要对 submit　进行讨论。
submit 这里很明显可以看到 Java 的影子。future 特性最好的是一旦完成就返回，而不必等到所有阻塞返回。和 apply_async 相比更抽象。
对官网的例子略作改进，一个使用如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span><span class="n">as_completed</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">URLS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'http://www.foxnews.com/'</span><span class="p">,</span>
        <span class="s">'http://www.cnn.com/'</span><span class="p">,</span>
        <span class="s">'http://europe.wsj.com/'</span><span class="p">,</span>
        <span class="s">'http://www.bbc.co.uk/'</span><span class="p">,</span>
        <span class="s">'http://some-made-up-domain.com/'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">load_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">future_to_url</span> <span class="o">=</span> <span class="p">{</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">load_url</span><span class="p">,</span><span class="n">url</span><span class="p">):</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">URLS</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_url</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">future_to_url</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="s">'raise exception'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="s">'{url} content is {content}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span><span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">))</span></code></pre></figure>

  </div>

</article>

        


    </main>
    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Pro Land
    </p>

  </div>

</footer>


  </body>

</html>
