<!DOCTYPE html>

<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Different Open Source Projects I Read</title>
  <meta name="description" content="To write fluent/elegant/idiomatic code 这篇文章对应的中文版 Prologue The benefits of reading open source projects have been demonstrated by many people. Whether it is to increase the understanding of tools used in daily development, or to learn to divide the project structure and improve the quality of the code better, reading open source projects is essential. There are some interesting findings during the progress.Take the famous requests which gained over 3.5K stars as an example. There is a file (core.py) in the first version v0.2.3 listed on github that used tab as a whitespace,it certainly doesn’t satisfy the requirements of PEP8 (:D What is Pythonic Code Pythonic code is to implement code in a pythonic way.Having a summary: OOP considers code reuse and extension. Many can use a basic class / ABC to provide an interface, other sub-class inherit from it just needs to implement the necessary function. Customize BaseException, such as class ProjectBasedException(Exception), and then use the code of the various inheritance exception classes to handle the specific exception, so that the prompt information can be reported more specifically. Define some small and common functions in utils, abstract the multiplexed code into @decorators; define the configuration files that will be used in settings, such as url, to avoid hard-coded. Defensive programming. Although _prefix can be used to define the private attribute to some extent, the parameters passed to the API must be type tested. Use a reasonable data structure or other tools (redis/celery) to limit the use of resources. meta-programming implements the User-defined behaviour. Standard comments for docstring and writing unit tests, logging important actions to files. On the basis of the above, some details, like replacing the string splicing with &#39;&#39;.join[], replacing the loop with list-comprehension also should be noticed. Projects List Not all high-star projects on Github are useful. For example, the code style of a 1000+ star project is not good, and a lot of code does not meet the principle of DRY(Don&#39;t Repeat Yourself) . There are still many projects that directly hack Python itself(so many variables and functions begin with __, it’s hard to understand what the logic behind it is) june Although the project has been deprecated in the description, it can still run smoothly. A forum project that includes the Node/Topic/Reply. a. The implementation of OOP is very thorough, the following is an example: # Define saving method in Topic model class Topic(db.Model): #... def save(self,user=None,node=None): if self.id: db.session.add(self) db.session.commit() return self # Form uses save method of Topic Model class TopicForm(BaseForm): #... topic = Topic(**self.data) return Topic.save(user=user,node=node) # Views uses method of Form @bp.route(&#39;/create/&amp;lt;int:id&amp;gt;&#39;,methods=[&#39;GET&#39;,&#39;POST&#39;]) @require_user def create(url_name): #... form = TopicForm() if form.validate_on_submit(): topic = form.save(g.user,node) return redirect(url_for(&#39;.view&#39;,uid=topic.id)) return render_template(&#39;topic/create.html&#39;, node=node, form=form) # So avoiding the hassle of calling the model and db.session.add(topic) in views. b. there is a decorator @require_user, which is the permission management for the user. A user may have multiple roles. If you define a decorator for each of these roles, there will be too many repetitions. In this case let’s see what the author did: # Define a base class class require_role(object): roles = { &#39;spam&#39;: 0, &#39;new&#39;: 1, &#39;user&#39;: 2, &#39;staff&#39;: 3, &#39;admin&#39;: 4, } def __init__(self, role): self.role = role def __call__(self, method): @functools.wraps(method) def wrapper(*args, **kwargs): if not g.user: url = url_for(&#39;account.signin&#39;) if &#39;?&#39; not in url: url += &#39;?next=&#39; + request.url return redirect(url) if self.role is None: return method(*args, **kwargs) if g.user.id == 1: # this is superuser, have no limitation return method(*args, **kwargs) if g.user.role == &#39;new&#39;: flash(_(&#39;Please verify your email&#39;), &#39;warn&#39;) return redirect(url_for(&#39;account.setting&#39;)) if g.user.role == &#39;spam&#39;: flash(_(&#39;You are a spammer&#39;), &#39;error&#39;) return redirect(&#39;/&#39;) if self.roles[g.user.role] &amp;lt; self.roles[self.role]: return abort(403) return method(*args, **kwargs) return wrapper # Then define different permission limits for different roles require_login = require_role(None) require_user = require_role(&#39;user&#39;) require_staff = require_role(&#39;staff&#39;) require_admin = require_role(&#39;admin&#39;) zhihu-oauth by @7sDream The second project is zhihu-oauth written by @7sDream. The overall structure is very beautiful, and the meta-programming is also very good. Especially considering that the author and I are peers, it is especially amazing. BTW, I also provide two PRs: pull-27 and pull-28 The author reversely parses the zhihu Android client and encapsulates the oauth interface. Unlike other libraries that use simulated login and Beautifuoup to parse web content, zhihu-oauth can provide a more stable API. And it is also less likely to be blocked by ip. The whole project is divided into three parts: oauth for verification, zhcls for class description, and client for combining the two to provide a login API. For oauth: The imZhihuAndroidClient class is defined in im_android.py, inheriting requests.authbase. The methods that are used in building parameters such as api_version/app_version/zpp_za/ua are defined in __init__. Also use the method self._api_version=api_version or API_VERSION (from setting.py) to allow the user to customize some parameters. The following __call__(self,r) is the mechanism of authbase and will be called automatically when posting a request. Before_login_auth.py defines the BeforeLoginAuth class, inherits the imZhihuAndroidClient class above, adds client_id to imZhihuAndroidClient, and uses self._client_id=client_id to execute validation before login. The implementation of __call__ is as follows: def __call__(self,r): r = super(BeforeLoginAuth,self).__call__() r.headers[&#39;Authorization&#39;] = &#39;oauth{0}&#39;.format(str(self._client_id)) return r In setting.py, some parameters are used, such as ZHIHU_API_ROOT, LOGIN_URL=ZHIHU_API_ROOT+&#39;/signin&#39;, all in uppercase. In token.py, the ZhihuToken class is defined, and the token is generated after the access is known. So obviously, according to OOP’s thoughts, the following job can be done: The self._cretate_at=time.time(), self._expires_in=expires_in initialization tool is defined in __init__ and these are also provided: class ZhihuToken: @staticmethod def from_dict(json_dict): try: return ZhihuToken(**json_dict) except TypeError: raise ValueError(&#39;{} is not a valid zhihu token json&#39;.format(json_dict)) @staticmethod def from_str(json_str): try: return ZhihuToken.from_dict(json.loads(json_str)) except TypeError: raise ValueError(&#39;{} is not a valid zhihu token str&#39;.format(json_str)) @staticmethod def from_file(filename): with open(filename,&#39;rb&#39;) as f: return pickle.load(f) # pickle ,long-time storage def save(self,filename): &quot;&quot;&quot; saving token to file &quot;&quot;&quot; with open(filename,&#39;wb&#39;) as f: pickle.dump(self,f) @property def user_id(self): return self._user_id Look again at the implementation of exception.py. As mentioned earlier,base exception should be provided for the entire project. # deal python2 and python3 respectively. # Also you can use `if py2:import ..;else import ..`,but it&#39;s against the # principle of `easier to ask for forgiveness than permission` try: from json import JSONDecodeError as MyJSONDecodeError except ImportError: MyJSONDecodeError = Exception class UnexpectedResponseException(Exception): def __init__(self,url,res): &quot;&quot;&quot; For all situations that json cannot be decoded,this exception will be used. &quot;&quot;&quot; self.url = url self.res = res def __repr__(self): return &quot;when visit {self.url},get an unexpected response {self.res.text}&quot;. format(self=self) __str__ = __repr__ Java 代码 Based on requirements,I ever investigaed the use of jedis to see how it handlers multi-thread situation. It inherits Apache.commons.pool and it is called The super.getResource() method, which in turn calls the borrowObject method in the pool.In the borrowObject method, it has implemented the consideration of multithreading: long starttime = System.currentTimeMillis(); Latch&amp;lt;T&amp;gt; latch = new Latch&amp;lt;T&amp;gt;(); byte whenExhaustedAction; long maxWait; synchronized (this) { /* Get local copy of current config. Can&#39;t sync when used later as it can result in a deadlock. Has the added advantage that config is consistent for entire execution */ whenExhaustedAction = _whenExhaustedAction; maxWait = _maxWait; // activate &amp;amp; validate the object try { _factory.activateObject(latch.getPair().value); if(_testOnBorrow &amp;amp;&amp;amp; !_factory.validateObject(latch.getPair().value)) { throw new Exception(&quot;ValidateObject failed&quot;); } synchronized(this) { // only one thread can execute at the moment _numInternalProcessing--; _numActive++; } return latch.getPair().value; } catch (Throwable e) { }">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2016/05/23/Read-Python-Open-Source-Project/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Allianzcortex-Blog" href="http://localhost:4000/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="hzcortex">
  <meta name="twitter:title" content="Different Open Source Projects I Read">
  <meta name="twitter:description" content="To write fluent/elegant/idiomatic code 这篇文章对应的中文版 Prologue The benefits of reading open source projects have been demonstrated by many people. Whether it is to increase the understanding of tools u...">
  
    <meta name="twitter:creator" content="hzcortex">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Allianzcortex-Blog</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="/projects/">Projects</a>
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/board/">board</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Different Open Source Projects I Read</h1>
    
    <p class="post-meta"><time datetime="2016-05-23T12:01:33-03:00" itemprop="datePublished">May 23, 2016</time> • 
  
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>To write <code class="highlighter-rouge">fluent/elegant/idiomatic</code> code
<!-- more --></p>

<p><a href="/../translation/2016-05-23-Read-Python-Open-Source-Project.html">这篇文章对应的中文版</a></p>

<h4 id="prologue">Prologue</h4>

<p>The benefits of reading open source projects have been demonstrated by many people. Whether it is to increase the understanding of tools used in daily development, or to learn to divide the project structure and improve the quality of the code better, reading open source projects is essential.</p>

<p>There are some interesting findings during the progress.Take the famous <a href="https://github.com/requests/requests">requests</a> which gained over 3.5K stars as an example. There is a file (core.py) in the first version v0.2.3 listed on github that used tab as a whitespace,it certainly doesn’t satisfy the requirements of PEP8 (:D</p>

<hr />

<h4 id="what-is-pythonic-code">What is Pythonic Code</h4>

<p>Pythonic code is to implement code in a pythonic way.Having a summary:</p>

<ol>
  <li>
    <p><code class="highlighter-rouge">OOP</code> considers code reuse and extension. Many can use a basic class / ABC to provide an interface, other sub-class inherit from it just needs to implement the necessary function.</p>
  </li>
  <li>
    <p>Customize BaseException, such as <code class="highlighter-rouge">class ProjectBasedException(Exception)</code>, and then use the code of the various inheritance exception classes to handle the specific exception, so that the prompt information can be reported more specifically.</p>
  </li>
  <li>
    <p>Define some small and common functions in utils, abstract the multiplexed code into @decorators; define the configuration files that will be used in settings, such as url, to avoid hard-coded.</p>
  </li>
  <li>
    <p>Defensive programming. Although _prefix can be used to define the private attribute to some extent, the parameters passed to the API must be type tested. Use a reasonable data structure or other tools (redis/celery) to limit the use of resources.</p>
  </li>
  <li>
    <p>meta-programming implements the <code class="highlighter-rouge">User-defined behaviour</code>.</p>
  </li>
  <li>
    <p>Standard comments for <code class="highlighter-rouge">docstring</code> and writing unit tests, logging important actions to files.</p>
  </li>
  <li>
    <p>On the basis of the above, some details, like replacing the string splicing with <code class="highlighter-rouge">''.join[]</code>, replacing the loop with <code class="highlighter-rouge">list-comprehension</code> also should be noticed.</p>
  </li>
</ol>

<hr />

<h3 id="projects-list">Projects List</h3>

<p>Not all high-star projects on Github are useful. For example, the code style of a <code class="highlighter-rouge">1000+ star</code> project is not good, and a lot of code does not meet the principle of <code class="highlighter-rouge">DRY(Don't Repeat Yourself)</code> . There are still many projects that directly hack Python itself(so many variables and functions begin with <code class="highlighter-rouge">__</code>, it’s hard to understand what the logic behind it is)</p>

<hr />

<h5 id="june"><a href="https://github.com/pythoncn/june">june</a></h5>

<p>Although the project has been deprecated in the description, it can still run smoothly. A forum project that includes the <code class="highlighter-rouge">Node/Topic/Reply</code>.</p>

<p>a. The implementation of OOP is very thorough, the following is an example:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Define saving method in Topic model
</span>
<span class="k">class</span> <span class="nc">Topic</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c">#...
</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="nb">id</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>

<span class="c"># Form uses save method of Topic Model
</span>
<span class="k">class</span> <span class="nc">TopicForm</span><span class="p">(</span><span class="n">BaseForm</span><span class="p">):</span>
    <span class="c">#...
</span>
    <span class="n">topic</span> <span class="o">=</span> <span class="n">Topic</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Topic</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span><span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>

<span class="c"># Views uses method of Form
</span>
<span class="nd">@bp.route</span><span class="p">(</span><span class="s">'/create/&lt;int:id&gt;'</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span><span class="s">'POST'</span><span class="p">])</span>
<span class="nd">@require_user</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">url_name</span><span class="p">):</span>
    <span class="c">#...
</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">TopicForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="p">,</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'.view'</span><span class="p">,</span><span class="n">uid</span><span class="o">=</span><span class="n">topic</span><span class="o">.</span><span class="nb">id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'topic/create.html'</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="c"># So avoiding the hassle of calling the model and db.session.add(topic) in views.</span></code></pre></figure>

<hr />

<p>b.  there is a decorator <code class="highlighter-rouge">@require_user</code>, which is the permission management for the user. A user may have multiple roles. If you define a decorator for each of these roles, there will be too many repetitions. In this case let’s see what the author did:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Define a base class
</span>

<span class="k">class</span> <span class="nc">require_role</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'spam'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">'new'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">'user'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s">'staff'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">'admin'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'account.signin'</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">'?'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">+=</span> <span class="s">'?next='</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="nb">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># this is superuser, have no limitation
</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s">'new'</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">'Please verify your email'</span><span class="p">),</span> <span class="s">'warn'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'account.setting'</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s">'spam'</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">'You are a spammer'</span><span class="p">),</span> <span class="s">'error'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>

<span class="c"># Then define different permission limits for different roles
</span>

<span class="n">require_login</span> <span class="o">=</span> <span class="n">require_role</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="n">require_user</span> <span class="o">=</span> <span class="n">require_role</span><span class="p">(</span><span class="s">'user'</span><span class="p">)</span>
<span class="n">require_staff</span> <span class="o">=</span> <span class="n">require_role</span><span class="p">(</span><span class="s">'staff'</span><span class="p">)</span>
<span class="n">require_admin</span> <span class="o">=</span> <span class="n">require_role</span><span class="p">(</span><span class="s">'admin'</span><span class="p">)</span></code></pre></figure>

<hr />

<h5 id="zhihu-oauth-by-7sdream"><a href="https://github.com/7sDream/zhihu-oauth">zhihu-oauth</a> by @7sDream</h5>

<p>The second project is <a href="https://github.com/7sDream/zhihu-oauth">zhihu-oauth</a> written by @7sDream. The overall structure is very beautiful, and the meta-programming is also very good. Especially considering that the author and I are peers, it is especially amazing. BTW, I also provide two PRs: 
<a href="https://github.com/7sDream/zhihu-oauth/pull/27">pull-27</a> and 
<a href="https://github.com/7sDream/zhihu- Oauth/pull/28">pull-28</a></p>

<p>The author reversely parses the zhihu Android client and encapsulates the oauth interface. Unlike other libraries that use simulated login and Beautifuoup to parse web content, zhihu-oauth can provide a more stable API. And it is also less likely to be blocked by ip.</p>

<p>The whole project is divided into three parts: <code class="highlighter-rouge">oauth</code> for verification, <code class="highlighter-rouge">zhcls</code> for class description, and <code class="highlighter-rouge">client</code> for combining the two to provide a login API.</p>

<p>For <code class="highlighter-rouge">oauth</code>:</p>

<ul>
  <li>
    <p>The <code class="highlighter-rouge">imZhihuAndroidClient class</code> is defined in im_android.py, inheriting requests.authbase. The methods that are used in building parameters such as api_version/app_version/zpp_za/ua are defined in <code class="highlighter-rouge">__init__</code>. Also use the method self._api_version=api_version or API_VERSION (from setting.py) to allow the user to customize some parameters. The following <code class="highlighter-rouge">__call__(self,r)</code> is the mechanism of authbase and will be called automatically when posting a request.</p>
  </li>
  <li>
    <p>Before_login_auth.py defines the BeforeLoginAuth class, inherits the imZhihuAndroidClient class above, adds client_id to imZhihuAndroidClient, and uses self._client_id=client_id to execute validation before login. The implementation of <code class="highlighter-rouge">__call__</code> is as follows:</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BeforeLoginAuth</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">()</span>
    <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'oauth{0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span></code></pre></figure>

<ul>
  <li>
    <p>In setting.py, some parameters are used, such as <code class="highlighter-rouge">ZHIHU_API_ROOT</code>, <code class="highlighter-rouge">LOGIN_URL=ZHIHU_API_ROOT+'/signin'</code>, all in uppercase.</p>
  </li>
  <li>
    <p>In token.py, the ZhihuToken class is defined, and the token is generated after the access is known. So obviously, according to OOP’s thoughts, the following job can be done:</p>
  </li>
</ul>

<p>The <code class="highlighter-rouge">self._cretate_at=time.time(), self._expires_in=expires_in</code> initialization tool is defined in <code class="highlighter-rouge">__init__</code> and these are also provided:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">ZhihuToken</span><span class="p">:</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">json_dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZhihuToken</span><span class="p">(</span><span class="o">**</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'{} is not a valid zhihu token json'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json_dict</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_str</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZhihuToken</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'{} is not a valid zhihu token str'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json_str</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="c"># pickle ,long-time storage
</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="s">"""
        saving token to file
        """</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id</span></code></pre></figure>

<p>Look again at the implementation of <code class="highlighter-rouge">exception.py</code>. As mentioned earlier,base exception should be provided for the entire project.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># deal python2 and python3 respectively.
</span>
<span class="c"># Also you can use `if py2:import ..;else import ..`,but it's against the   
</span>
<span class="c"># principle of `easier to ask for forgiveness than permission`
</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">MyJSONDecodeError</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="n">MyJSONDecodeError</span> <span class="o">=</span> <span class="nb">Exception</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">UnexpectedResponseException</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="p">,</span><span class="n">res</span><span class="p">):</span>
        <span class="s">"""
        For all situations that json cannot be decoded,this exception will be used.
        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"when visit {self.url},get an unexpected response {self.res.text}"</span><span class="o">.</span>
            <span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span></code></pre></figure>

<hr />

<p>Java 代码</p>

<p>Based on requirements,I ever investigaed the use of <code class="highlighter-rouge">jedis</code> to see how it handlers multi-thread situation.</p>

<p>It inherits <code class="highlighter-rouge">Apache.commons.pool</code> and it is called
The <code class="highlighter-rouge">super.getResource()</code> method, which in turn calls the <code class="highlighter-rouge">borrowObject</code> method in the pool.In the <code class="highlighter-rouge">borrowObject</code> method, it has implemented the consideration of multithreading:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">long</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
<span class="n">Latch</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Latch</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;();</span>
<span class="kt">byte</span> <span class="n">whenExhaustedAction</span><span class="o">;</span>
<span class="kt">long</span> <span class="n">maxWait</span><span class="o">;</span>
<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 
Get local copy of current config. Can't sync when used 
later as it can result in a deadlock. Has the added 
advantage that config is consistent for entire execution

*/</span>
<span class="n">whenExhaustedAction</span> <span class="o">=</span> <span class="n">_whenExhaustedAction</span><span class="o">;</span>
<span class="n">maxWait</span> <span class="o">=</span> <span class="n">_maxWait</span><span class="o">;</span>

<span class="c1">// activate &amp; validate the object
</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">_factory</span><span class="o">.</span><span class="na">activateObject</span><span class="o">(</span><span class="n">latch</span><span class="o">.</span><span class="na">getPair</span><span class="o">().</span><span class="na">value</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">_testOnBorrow</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">_factory</span><span class="o">.</span><span class="na">validateObject</span><span class="o">(</span><span class="n">latch</span><span class="o">.</span><span class="na">getPair</span><span class="o">().</span><span class="na">value</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"ValidateObject failed"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// only one thread can execute at the moment
</span>
        <span class="n">_numInternalProcessing</span><span class="o">--;</span>
        <span class="n">_numActive</span><span class="o">++;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">latch</span><span class="o">.</span><span class="na">getPair</span><span class="o">().</span><span class="na">value</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="o">}</span></code></pre></figure>

  </div>

</article>

        


    </main>
    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

Pro Land
    </p>

  </div>

</footer>


  </body>

</html>
